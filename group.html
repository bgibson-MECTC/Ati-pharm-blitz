<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ATI Pharm Blitz ‚Äì Group View</title>

  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a1128 0%, #1e3a5f 100%);
      color: #ffffff;
      overflow-x: hidden;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    .main-wrapper {
      width: 100%;
      min-height: 100vh;
      overflow-y: auto;
      padding: 40px 20px;
      max-width: 1100px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    .main-title {
      font-size: 36px;
      font-weight: 900;
      background: linear-gradient(90deg, #00d4ff, #00ffb3, #00d4ff);
      background-size: 200% auto;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 3s linear infinite;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 16px;
      color: #00ffb3;
      font-weight: 400;
      margin-bottom: 4px;
    }

    .group-label {
      font-size: 14px;
      color: #ccecff;
    }

    @keyframes shimmer {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }

    .section {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      border: 2px solid rgba(0, 212, 255, 0.3);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
      padding-bottom: 10px;
      border-bottom: 2px solid #00d4ff;
    }

    .section-icon {
      font-size: 28px;
    }

    .section-title {
      font-size: 22px;
      font-weight: 700;
      color: #00ffb3;
      margin: 0;
    }

    .huddle-box {
      background: rgba(0, 212, 255, 0.1);
      border: 2px solid #00d4ff;
      border-radius: 15px;
      padding: 20px;
      margin-top: 10px;
    }

    .huddle-box h3 {
      color: #00ffb3;
      font-size: 20px;
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
    }

    .huddle-field {
      margin-bottom: 15px;
    }

    .huddle-field label {
      display: block;
      color: #00d4ff;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .huddle-field input,
    .huddle-field textarea {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 8px;
      padding: 9px;
      color: #ffffff;
      font-size: 14px;
      font-family: inherit;
    }

    .huddle-field textarea {
      min-height: 70px;
      resize: vertical;
    }

    .huddle-field input:focus,
    .huddle-field textarea:focus {
      outline: none;
      border-color: #00ffb3;
      background: rgba(255, 255, 255, 0.15);
    }

    .instructions-list {
      color: #ccecff;
      font-size: 14px;
      padding-left: 18px;
    }

    .instructions-list li {
      margin-bottom: 6px;
    }

    .back-link {
      display: inline-block;
      margin-top: 10px;
      font-size: 13px;
      color: #00ffb3;
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,212,255,0.5);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #ccecff;
      margin-left: 6px;
    }

    @media (max-width: 768px) {
      .main-title {
        font-size: 26px;
      }
      .section-title {
        font-size: 19px;
      }
    }

    /* Flashcard Guess */
    .flashguess-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 10px;
    }

    .fg-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #00d4ff;
      margin-bottom: 5px;
    }

    .fg-input {
      width: 100%;
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      border: 1px solid rgba(0,212,255,0.4);
      color: #ffffff;
      padding: 8px 10px;
      font-size: 14px;
      font-family: inherit;
    }

    .fg-input option {
      background: #1e3a5f;
      color: #ffffff;
    }

    .fg-input:focus {
      outline: none;
      border-color: #00ffb3;
      background: rgba(255,255,255,0.12);
    }

    @media (max-width: 600px) {
      .flashguess-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Flashcards */
    .flashcard-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .flashcard {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      border-radius: 15px;
      padding: 25px 18px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      min-height: 180px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .flashcard.locked {
      cursor: not-allowed;
      opacity: 0.7;
      background: linear-gradient(135deg, #555 0%, #333 100%);
    }

    .flashcard.locked::after {
      content: 'üîí';
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
    }

    .flashcard:not(.locked):hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.5);
    }

    .flashcard.flipped {
      background: linear-gradient(135deg, #00ffb3 0%, #00cc88 100%);
    }

    .flashcard-front {
      font-size: 14px;
      font-weight: 600;
      color: #ffffff;
      line-height: 1.4;
    }

    .flashcard-back {
      display: none;
      font-size: 13px;
      font-weight: 600;
      color: #0a1128;
      line-height: 1.5;
      text-align: left;
    }

    .flashcard.flipped .flashcard-front {
      display: none;
    }

    .flashcard.flipped .flashcard-back {
      display: block;
    }

    .card-number {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.5);
      color: #00ffb3;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Group Selection Landing */
    .group-selection-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
      padding: 40px 20px;
      text-align: center;
    }

    .group-selection-screen.hidden {
      display: none;
    }

    .selection-title {
      font-size: 42px;
      font-weight: 900;
      background: linear-gradient(90deg, #00d4ff, #00ffb3);
      background-size: 200% auto;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 15px;
    }

    .selection-subtitle {
      font-size: 18px;
      color: #b8e0ff;
      margin-bottom: 40px;
    }

    .group-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      max-width: 900px;
      width: 100%;
    }

    .group-option {
      background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(0,255,179,0.05));
      border: 2px solid rgba(0,212,255,0.3);
      border-radius: 16px;
      padding: 30px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .group-option:hover {
      transform: translateY(-8px);
      border-color: #00d4ff;
      box-shadow: 0 15px 35px rgba(0,212,255,0.3);
      background: linear-gradient(135deg, rgba(0,212,255,0.15), rgba(0,255,179,0.1));
    }

    .group-number {
      font-size: 48px;
      font-weight: 900;
      color: #00d4ff;
      margin-bottom: 10px;
    }

    .group-system {
      font-size: 18px;
      font-weight: 600;
      color: #00ffb3;
      margin-bottom: 8px;
    }

    .group-icon {
      font-size: 36px;
      margin-bottom: 5px;
    }

    .group-activity-content {
      display: none;
    }

    .group-activity-content.active {
      display: block;
    }

    /* Role Selection Screen */
    .role-selection-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
      padding: 40px 20px;
      text-align: center;
    }

    .role-selection-screen.active {
      display: flex;
    }

    .role-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      max-width: 800px;
      width: 100%;
    }

    .role-option {
      background: linear-gradient(135deg, rgba(255,179,0,0.1), rgba(255,107,0,0.05));
      border: 2px solid rgba(255,179,0,0.3);
      border-radius: 16px;
      padding: 30px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .role-option:hover {
      transform: translateY(-8px);
      border-color: #ffb300;
      box-shadow: 0 15px 35px rgba(255,179,0,0.3);
      background: linear-gradient(135deg, rgba(255,179,0,0.15), rgba(255,107,0,0.1));
    }

    .role-option.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }

    .role-name {
      font-size: 22px;
      font-weight: 700;
      color: #ffb300;
      margin-bottom: 8px;
    }

    .role-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(0,212,255,0.2);
      color: #00d4ff;
      margin-top: 10px;
    }

    .role-description {
      font-size: 13px;
      color: #b8e0ff;
      line-height: 1.5;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <!-- GROUP SELECTION LANDING -->
  <div class="group-selection-screen" id="groupSelectionScreen">
    <h1 class="selection-title">Select Your Role</h1>
    <p class="selection-subtitle">Choose to join a student group or take a leadership role</p>
    
    <!-- Leadership Roles Section -->
    <div style="margin-bottom: 40px;">
      <h3 style="color: #ffb300; font-size: 20px; margin-bottom: 20px;">üéØ Leadership Roles</h3>
      <div class="role-grid">
        <div class="role-option" onclick="selectLeadership('charge1')" id="charge1Option">
          <div class="role-icon" style="font-size: 48px;">üë®‚Äç‚öïÔ∏è</div>
          <div class="role-name">Charge Nurse 1</div>
          <div class="role-badge">Oversee All Groups</div>
          <div class="role-description">Monitor all 6 groups, approve answers, trigger RRT</div>
        </div>
        
        <div class="role-option" onclick="selectLeadership('charge2')" id="charge2Option">
          <div class="role-icon" style="font-size: 48px;">üë©‚Äç‚öïÔ∏è</div>
          <div class="role-name">Charge Nurse 2</div>
          <div class="role-badge">Oversee All Groups</div>
          <div class="role-description">Monitor all 6 groups, approve answers, trigger RRT</div>
        </div>
        
        <div class="role-option" onclick="selectLeadership('rrt')" id="rrtOption">
          <div class="role-icon" style="font-size: 48px;">üö®</div>
          <div class="role-name">Rapid Response RN</div>
          <div class="role-badge">Emergency Response</div>
          <div class="role-description">Rescue crashing groups and stabilize patients</div>
        </div>
      </div>
    </div>

    <!-- Student Groups Section -->
    <div>
      <h3 style="color: #00d4ff; font-size: 20px; margin-bottom: 20px;">üìö Student Groups</h3>
      <div class="group-grid">
        <div class="group-option" onclick="selectGroup(1)">
          <div class="group-icon">üß†</div>
          <div class="group-number">1</div>
          <div class="group-system">Neurological</div>
        </div>
        
        <div class="group-option" onclick="selectGroup(2)">
          <div class="group-icon">üíä</div>
          <div class="group-number">2</div>
          <div class="group-system">Psychopharmacology</div>
        </div>
        
        <div class="group-option" onclick="selectGroup(3)">
          <div class="group-icon">üò£</div>
          <div class="group-number">3</div>
          <div class="group-system">Pain Management</div>
        </div>
        
        <div class="group-option" onclick="selectGroup(4)">
          <div class="group-icon">üî•</div>
          <div class="group-number">4</div>
          <div class="group-system">Inflammation</div>
        </div>
        
        <div class="group-option" onclick="selectGroup(5)">
          <div class="group-icon">ü©∫</div>
          <div class="group-number">5</div>
          <div class="group-system">Endocrine</div>
        </div>
        
        <div class="group-option" onclick="selectGroup(6)">
          <div class="group-icon">ü¶†</div>
          <div class="group-number">6</div>
          <div class="group-system">Infection</div>
        </div>
      </div>
    </div>
  </div>

  <!-- LEADERSHIP DASHBOARD (Charge/RRT) -->
  <div class="main-wrapper group-activity-content" id="leadershipDashboard" style="display:none;">
    <header>
      <h1 class="main-title">Leadership Command Center</h1>
      <p class="subtitle" id="leadershipRoleLabel">Role: ‚Ä¶</p>
      <a href="index.html?select=1" class="back-link">‚¨Ö Change Role</a>
    </header>

    <!-- All Groups Stability Monitor -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üìä</span>
        <h2 class="section-title">All Groups ‚Äì Patient Stability</h2>
      </div>
      <div id="allGroupsStability" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;">
        <!-- Populated by JS -->
      </div>
    </section>

    <!-- Flashcard & Jigsaw Errors -->
    <section class="section" id="errorLogSection">
      <div class="section-header">
        <span class="section-icon">‚ö†Ô∏è</span>
        <h2 class="section-title">Error Log ‚Äì All Groups</h2>
      </div>
      <div id="allGroupsErrors" style="max-height:400px;overflow-y:auto;">
        <!-- Populated by JS -->
      </div>
    </section>

    <!-- Group Cases & Approval -->
    <section class="section" id="groupCasesSection">
      <div class="section-header">
        <span class="section-icon">üìã</span>
        <h2 class="section-title">Assigned Cases & Approval</h2>
      </div>
      <div id="groupCases">
        <!-- Populated by JS -->
      </div>
    </section>

    <!-- Debrief Board (Charge Nurses only) -->
    <section class="section" id="debriefBoard">
      <div class="section-header">
        <span class="section-icon">üìù</span>
        <h2 class="section-title">Debrief Board</h2>
      </div>
      <p style="color:#ccecff;font-size:14px;margin-bottom:15px;" id="debriefInstructions">
        Document key learnings and reflections for your assigned groups.
      </p>
      <div id="debriefGroups">
        <!-- Populated based on charge nurse role -->
      </div>
    </section>

    <!-- RRT Rescue Controls (Charge Nurse only) -->
    <section class="section" id="rrtControls">
      <div class="section-header">
        <span class="section-icon">üö®</span>
        <h2 class="section-title">Rapid Response Team Controls</h2>
      </div>
      <p style="color:#ccecff;font-size:14px;margin-bottom:15px;">
        Trigger an RRT call to rescue a crashing group. Complete the SBAR report for the RRT nurse.
      </p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;">
        <button class="assign-btn" onclick="openRRTReport(1)">üö® RRT to Group 1</button>
        <button class="assign-btn" onclick="openRRTReport(2)">üö® RRT to Group 2</button>
        <button class="assign-btn" onclick="openRRTReport(3)">üö® RRT to Group 3</button>
        <button class="assign-btn" onclick="openRRTReport(4)">üö® RRT to Group 4</button>
        <button class="assign-btn" onclick="openRRTReport(5)">üö® RRT to Group 5</button>
        <button class="assign-btn" onclick="openRRTReport(6)">üö® RRT to Group 6</button>
      </div>

      <!-- SBAR Report Modal -->
      <div id="sbarModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:600px;background:#0a1128;border-radius:20px;border:2px solid #00d4ff;padding:30px;max-height:90vh;overflow-y:auto;">
          <h2 style="color:#00d4ff;margin-top:0;">üö® RRT Call - SBAR Report</h2>
          <p style="color:#ccecff;font-size:14px;margin-bottom:20px;" id="sbarGroupInfo">Group: ‚Ä¶</p>

          <div style="margin-bottom:15px;">
            <label style="display:block;color:#00ffb3;font-weight:600;margin-bottom:5px;">Situation (What's happening?)</label>
            <textarea id="sbarSituation" rows="2" style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:8px;padding:10px;color:#fff;font-family:inherit;" placeholder="Patient status is declining, stability at..."></textarea>
          </div>

          <div style="margin-bottom:15px;">
            <label style="display:block;color:#00ffb3;font-weight:600;margin-bottom:5px;">Background (Relevant history)</label>
            <textarea id="sbarBackground" rows="2" style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:8px;padding:10px;color:#fff;font-family:inherit;" placeholder="Group made errors on..."></textarea>
          </div>

          <div style="margin-bottom:15px;">
            <label style="display:block;color:#00ffb3;font-weight:600;margin-bottom:5px;">Assessment (What do you think is wrong?)</label>
            <textarea id="sbarAssessment" rows="2" style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:8px;padding:10px;color:#fff;font-family:inherit;" placeholder="I believe the patient is..."></textarea>
          </div>

          <div style="margin-bottom:20px;">
            <label style="display:block;color:#00ffb3;font-weight:600;margin-bottom:5px;">Recommendation (What needs to happen?)</label>
            <textarea id="sbarRecommendation" rows="2" style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:8px;padding:10px;color:#fff;font-family:inherit;" placeholder="I recommend immediate intervention..."></textarea>
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="assign-btn" onclick="closeSBARModal()" style="background:rgba(255,255,255,0.1);">Cancel</button>
            <button class="assign-btn" onclick="submitRRTCall()" style="background:#ff006e;">üö® Send RRT Now</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RRT Active Calls (RRT role only) -->
    <section class="section" id="rrtCalls" style="display:none;">
      <div class="section-header">
        <span class="section-icon">üö®</span>
        <h2 class="section-title">Active RRT Calls</h2>
      </div>
      <div id="activeCalls">
        <p style="color:#ccecff;font-size:14px;">No active calls. Standby for charge nurse alerts.</p>
      </div>
    </section>

    <!-- RRT Intervention Selection -->
    <section class="section" id="rrtInterventions" style="display:none;">
      <div class="section-header">
        <span class="section-icon">üíâ</span>
        <h2 class="section-title">Available Interventions</h2>
      </div>
      <p style="color:#ccecff;font-size:14px;margin-bottom:15px;">Select the appropriate intervention based on the SBAR report above.</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;" id="interventionOptions">
        <!-- Populated when call is active -->
      </div>
    </section>
  </div>

  <!-- ROLE SELECTION SCREEN -->
  <div class="role-selection-screen" id="roleSelectionScreen">
    <h1 class="selection-title">Select Your Role</h1>
    <p class="selection-subtitle" id="roleSubtitle">Choose your leadership role for this activity</p>
    
    <div class="role-grid">
      <div class="role-option" onclick="selectRole('charge1')" id="charge1Option">
        <div class="role-icon" style="font-size: 48px;">üë®‚Äç‚öïÔ∏è</div>
        <div class="role-name">Charge Nurse</div>
        <div class="role-badge">Role 1 of 2</div>
        <div class="role-description">Lead delegation and prioritization decisions</div>
      </div>
      
      <div class="role-option" onclick="selectRole('charge2')" id="charge2Option">
        <div class="role-icon" style="font-size: 48px;">üë©‚Äç‚öïÔ∏è</div>
        <div class="role-name">Charge Nurse</div>
        <div class="role-badge">Role 2 of 2</div>
        <div class="role-description">Lead delegation and prioritization decisions</div>
      </div>
      
      <div class="role-option" onclick="selectRole('rrt')" id="rrtOption">
        <div class="role-icon" style="font-size: 48px;">üö®</div>
        <div class="role-name">Rapid Response RN</div>
        <div class="role-badge">Critical Care</div>
        <div class="role-description">Respond to patient emergencies and instability</div>
      </div>
    </div>
  </div>

  <!-- GROUP ACTIVITY CONTENT -->
  <div class="main-wrapper group-activity-content" id="groupActivityContent">
    <header>
      <h1 class="main-title">ATI Pharm Blitz</h1>
      <p class="subtitle" id="systemLabel">Group System: ‚Ä¶</p>
      <p class="group-label" id="groupLabel">Group: ‚Ä¶</p>
      <a href="index.html" class="back-link">‚¨Ö Back to Instructor View</a>
    </header>

    <!-- Instructions -->
    <section class="section" id="missionSection" style="display:none;">
      <div class="section-header">
        <span class="section-icon">üìã</span>
        <h2 class="section-title">Your Mission<span class="pill">Group View</span></h2>
      </div>
      <ul class="instructions-list" id="instructionList">
        <!-- Filled dynamically based on system -->
      </ul>
    </section>

    <!-- WARM-UP FLASHCARDS -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üî•</span>
        <h2 class="section-title">Warm-Up Flashcards</h2>
      </div>

      <p style="color:#ccecff;font-size:14px;margin-bottom:10px;">
        Click any card to flip it and see the answer. Cards are locked üîí until your group submits the correct system guess below.
      </p>

      <div class="flashcard-container">
        <!-- Card 1: Psychopharmacology -->
        <div class="flashcard locked" data-card-id="card1" data-system="psychopharmacology">
          <span class="card-number">Card 1</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on Haloperidol is showing muscle rigidity and tremors. What serious adverse effect requires immediate intervention? <em>(Psycho or Neuro?)</em>
          </div>
          <div class="flashcard-back">
            <strong>System:</strong> Psychopharmacology<br>
            <strong>Answer:</strong> Extrapyramidal symptoms (EPS) - requires immediate benztropine or dose adjustment<br>
            <strong>Priority:</strong> Watch for tardive dyskinesia (irreversible)<br>
            <strong>Safety Tip:</strong> Avoid combining with anticholinergics unless treating EPS<br>
            <strong>High-Yield Med:</strong> Fluoxetine - risk of serotonin syndrome with MAOIs
          </div>
        </div>

        <!-- Card 2: Neurological -->
        <div class="flashcard locked" data-card-id="card2" data-system="neurological">
          <span class="card-number">Card 2</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on Levodopa/Carbidopa experiences sudden "on-off" phenomenon. What lab value is critical to monitor? <em>(Neuro or Endocrine?)</em>
          </div>
          <div class="flashcard-back">
            <strong>System:</strong> Neurological<br>
            <strong>Answer:</strong> Vitamin B6 (pyridoxine) levels - can decrease Levodopa effectiveness<br>
            <strong>Priority:</strong> Monitor for dyskinesias and orthostatic hypotension<br>
            <strong>Safety Tip:</strong> Avoid high-protein meals (competes with absorption)<br>
            <strong>High-Yield Med:</strong> Phenobarbital - monitor therapeutic levels (10-40 mcg/mL)
          </div>
        </div>

        <!-- Card 3: Pain -->
        <div class="flashcard locked" data-card-id="card3" data-system="pain">
          <span class="card-number">Card 3</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A post-op patient on IV Fentanyl has a respiratory rate of 8. What is your FIRST action? <em>(Pain or Neuro?)</em>
          </div>
          <div class="flashcard-back">
            <strong>System:</strong> Pain<br>
            <strong>Answer:</strong> Administer Naloxone (Narcan) immediately - opioid reversal agent<br>
            <strong>Priority:</strong> Monitor respiratory rate &lt;12 = critical<br>
            <strong>Do NOT Mix:</strong> Fentanyl + benzodiazepines (respiratory depression)<br>
            <strong>High-Yield Med:</strong> Butorphanol - mixed agonist-antagonist, can precipitate withdrawal
          </div>
        </div>

        <!-- Card 4: Endocrine -->
        <div class="flashcard locked" data-card-id="card4" data-system="endocrine">
          <span class="card-number">Card 4</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on PTU (Propylthiouracil) develops a sore throat and fever. What life-threatening complication must you suspect? <em>(Endocrine or Infection?)</em>
          </div>
          <div class="flashcard-back">
            <strong>System:</strong> Endocrine<br>
            <strong>Answer:</strong> Agranulocytosis - obtain STAT CBC with differential<br>
            <strong>Priority:</strong> Monitor WBC &lt;3,000 = hold medication<br>
            <strong>Safety Tip:</strong> Teach patient to report signs of infection immediately<br>
            <strong>High-Yield Med:</strong> Somatropin - monitor blood glucose (causes hyperglycemia)
          </div>
        </div>

        <!-- Card 5: Infection -->
        <div class="flashcard locked" data-card-id="card5" data-system="infection">
          <span class="card-number">Card 5</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on Erythromycin is also taking Warfarin. What dangerous interaction must you monitor? <em>(Infection or Inflammation?)</em>
          </div>
          <div class="flashcard-back">
            <strong>System:</strong> Infection<br>
            <strong>Answer:</strong> Increased bleeding risk - Erythromycin inhibits Warfarin metabolism (elevated INR)<br>
            <strong>Priority:</strong> Monitor INR closely, target 2-3 for most indications<br>
            <strong>Do NOT Mix:</strong> Rifampin + oral contraceptives (decreases effectiveness)<br>
            <strong>High-Yield Med:</strong> Amphotericin B - monitor potassium (causes severe hypokalemia)
          </div>
        </div>

        <!-- Card 6: Inflammation -->
        <div class="flashcard locked" data-card-id="card6" data-system="inflammation">
          <span class="card-number">Card 6</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on Belimumab (lupus treatment) is scheduled for a live vaccine. What is your nursing action? <em>(Inflammation or Infection?)</em>
          </div>
          <div class="flashcard-back">
            <strong>System:</strong> Inflammation<br>
            <strong>Answer:</strong> HOLD vaccine - immunosuppressed patients cannot receive live vaccines<br>
            <strong>Priority:</strong> Screen for infections before each dose<br>
            <strong>Safety Tip:</strong> Avoid NSAIDs with immunosuppressants (GI bleeding risk)<br>
            <strong>High-Yield Meds:</strong> Allopurinol (monitor uric acid), Hydrocortisone (taper slowly - adrenal crisis)
          </div>
        </div>
      </div>
    </section>

    <!-- FLASHCARD GUESS SUBMISSION -->
    <section class="section" id="flashcardGuessSection">
      <div class="section-header">
        <span class="section-icon">üß†</span>
        <h2 class="section-title">Flashcard Guess ‚Äì Submit to Unlock</h2>
      </div>
      <p style="color:#ccecff;font-size:14px;margin-bottom:10px;">
        Submit your group's best guess for which system each card belongs to. When you get it right, the card unlocks and you can flip it!
      </p>

      <div class="flashguess-grid">
        <div>
          <label class="fg-label">Card ID</label>
          <select id="fgCard" class="fg-input">
            <option value="">Choose card‚Ä¶</option>
            <option value="card1">Card 1</option>
            <option value="card2">Card 2</option>
            <option value="card3">Card 3</option>
            <option value="card4">Card 4</option>
            <option value="card5">Card 5</option>
            <option value="card6">Card 6</option>
          </select>
        </div>
        <div>
          <label class="fg-label">System Guess</label>
          <select id="fgSystem" class="fg-input">
            <option value="">Select system‚Ä¶</option>
            <option value="Neurological">Neurological</option>
            <option value="Psychopharmacology">Psychopharmacology</option>
            <option value="Pain">Pain</option>
            <option value="Inflammation">Inflammation</option>
            <option value="Endocrine">Endocrine</option>
            <option value="Infection">Infection</option>
          </select>
        </div>
      </div>
      <button id="fgSubmit" class="assign-btn" style="margin-top:12px;">Submit Guess</button>
      <p id="fgStatus" class="assign-error"></p>
    </section>

    <!-- Expert Huddle Box (single system) -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üë©‚Äç‚öïÔ∏è</span>
        <h2 class="section-title">Expert Huddle ‚Äì <span id="systemNameInline">System</span></h2>
      </div>

      <div class="huddle-box" id="huddleBox">
        <h3 id="huddleTitle">System Experts</h3>

        <div class="huddle-field">
          <label>#1 Safety Risk (What kills the patient first?)</label>
          <input type="text" id="safetyRisk" placeholder="e.g., Respiratory depression, Lithium toxicity, GI bleed">
        </div>

        <div class="huddle-field">
          <label>#1 Lab / Assessment to Monitor</label>
          <input type="text" id="priorityLab" placeholder="e.g., Lithium level, INR, Blood glucose, WBC">
        </div>

        <div class="huddle-field">
          <label>"Do Not Mix" Rule</label>
          <input type="text" id="doNotMix" placeholder="e.g., MAOIs + SSRIs, opioids + benzos, NSAIDs + anticoagulants">
        </div>

        <div class="huddle-field">
          <label>High-Yield Medication(s)</label>
          <input type="text" id="highYieldMed" placeholder="e.g., Lithium, Vancomycin, Morphine, Insulin">
        </div>

        <div class="huddle-field">
          <label>Scenario Prompts (at least 2)</label>
          <textarea id="scenarioPrompts" placeholder="Example:
1) Your patient on ___ develops ___. What is your first action?
2) Teaching point the patient MUST remember about this med."></textarea>
        </div>

        <div class="huddle-field">
          <label>Rationale: Why are these your Top 3 priorities?</label>
          <textarea id="rationale" placeholder="Connect back to ATI, safety, and NCLEX-style thinking."></textarea>
        </div>
      </div>
    </section>

    <!-- JIGSAW LEARNING TRACKER -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üîÑ</span>
        <h2 class="section-title">Jigsaw Learning ‚Äì Track Your Progress</h2>
      </div>

      <p style="color:#ccecff;font-size:14px;margin-bottom:15px;">
        As you rotate through each system station, check off what you've learned. 
        When you complete a system's teaching, click the checkbox below to mark it complete.
      </p>

      <div id="jigsawCheckboxes" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:15px;">
        <!-- Checkboxes populated automatically when group is selected -->
      </div>

      <div style="margin-top:15px;padding:12px;background:rgba(0,212,255,0.08);border-radius:10px;border-left:4px solid #00d4ff;">
        <p style="margin:0;font-size:13px;color:#ccecff;line-height:1.5;">
          <strong>üìù Pro Tip:</strong> Take notes on each system's #1 safety risk, critical lab, and do-not-mix rule. 
          You'll use this knowledge in the Lightning Round!
        </p>
      </div>
    </section>

    <!-- JIGSAW SPEED ROUND ‚Äì CASE REVEAL -->
    <section class="section" id="jigsawSection">
      <div class="section-header">
        <span class="section-icon">üß©</span>
        <h2 class="section-title">Jigsaw Speed Round ‚Äì Get Your Case</h2>
      </div>

      <p style="color:#ccecff;font-size:14px;margin-bottom:10px;">
        Each <strong>system expert</strong> will generate one case for their group.
        Select your expert role below and click <strong>"Get My Case"</strong>.
        The system will assign either a standard scenario or a consequence scenario based on your group's earlier decisions.
      </p>

      <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px;">
        <label for="jigsawSystemSelect" style="font-size:14px;color:#00d4ff;font-weight:600;">
          I am the expert for:
        </label>
        <select id="jigsawSystemSelect" class="fg-input" style="min-width:220px;">
          <option value="">Select your system‚Ä¶</option>
          <option value="psych">Psych / Haloperidol‚ÄìFluoxetine</option>
          <option value="neuro">Neuro / Levodopa‚ÄìPhenobarbital</option>
          <option value="pain">Pain / Fentanyl‚ÄìButorphanol</option>
          <option value="endocrine">Endocrine / PTU‚ÄìSomatropin</option>
          <option value="infection">Infection / Antibiotics‚ÄìAntifungals</option>
          <option value="inflammation">Inflammation / Belimumab‚ÄìAllopurinol‚ÄìSteroids</option>
        </select>

        <button id="jigsawCaseBtn" class="assign-btn">
          Get My Case
        </button>
      </div>

      <p id="jigsawStatus" class="assign-error"></p>

      <div id="jigsawCaseDisplay"
           style="margin-top:16px;padding:16px;border-radius:12px;border:1px solid rgba(0,212,255,0.4);background:rgba(255,255,255,0.04);min-height:80px;">
        <em style="color:#ccecff;font-size:13px;">Your case will appear here once generated. Do not refresh or you may lose your assigned scenario.</em>
      </div>
    </section>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBfJ4KBqpbP4tbtikAgMEdbT5P1rb3yhHo",
      authDomain: "ati-pharm-blitz.firebaseapp.com",
      databaseURL: "https://ati-pharm-blitz-default-rtdb.firebaseio.com",
      projectId: "ati-pharm-blitz",
      storageBucket: "ati-pharm-blitz.firebasestorage.app",
      messagingSenderId: "236104923394",
      appId: "1:236104923394:web:201f51f9ba162438b2aa1b"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Map group number -> system name + instructions
    const groupConfig = {
      1: {
        name: 'Neurological',
        label: 'Group 1 ‚Äì Neurological Experts',
        instructions: [
          'Focus on seizure meds, antiepileptics, and CNS depressants.',
          'Identify the biggest safety risk (airway, LOC, respiratory depression, etc.).',
          'Pick at least one high-yield drug (e.g., Phenytoin, Levetiracetam).',
          'Create two scenarios where neuro meds could rapidly become unsafe.',
          'Be ready to teach your Top 3 priorities to a mixed group.'
        ]
      },
      2: {
        name: 'Psychopharmacology',
        label: 'Group 2 ‚Äì Psychopharm Experts',
        instructions: [
          'Focus on antidepressants, antipsychotics, mood stabilizers, and anxiolytics.',
          'Think about suicide risk, serotonin syndrome, NMS, EPS, and sedation.',
          'Choose high-yield meds (e.g., Lithium, SSRIs, Clozapine).',
          'Create scenarios that force the group to choose the safest FIRST action.',
          'Prepare to explain why your rules prevent harm to the patient.'
        ]
      },
      3: {
        name: 'Pain Management',
        label: 'Group 3 ‚Äì Pain Management Experts',
        instructions: [
          'Focus on opioids, non-opioids, and adjunct pain meds.',
          'Zero in on respiratory depression, oversedation, and uncontrolled pain.',
          'Include at least one opioid and one non-opioid (e.g., Morphine + Ketorolac).',
          'Build scenarios where the wrong choice could tank breathing or perfusion.',
          'Be ready to explain how to safely combine or stagger pain meds.'
        ]
      },
      4: {
        name: 'Inflammation',
        label: 'Group 4 ‚Äì Inflammation / NSAID Experts',
        instructions: [
          'Focus on NSAIDs, steroids, and anti-inflammatory meds.',
          'Key risks: GI bleed, renal injury, immunosuppression.',
          'Pick common meds (e.g., Ibuprofen, Ketorolac, Prednisone).',
          'Create at least one scenario involving a patient on anticoagulants or with ulcers.',
          'Highlight labs and assessments that would make you HOLD the drug.'
        ]
      },
      5: {
        name: 'Endocrine',
        label: 'Group 5 ‚Äì Endocrine Experts',
        instructions: [
          'Focus on insulin, oral hypoglycemics, thyroid meds, and steroids.',
          'Watch for hypoglycemia, DKA/HHS, and thyroid storm/myxedema coma.',
          'Include at least one insulin and one oral agent or thyroid med.',
          'Create scenarios where timing of meds and meals matters.',
          'Be ready to explain which lab change is most deadly, the fastest.'
        ]
      },
      6: {
        name: 'Infection',
        label: 'Group 6 ‚Äì Infection / Antibiotic Experts',
        instructions: [
          'Focus on antibiotics, antivirals, and antifungals.',
          'Key risks: anaphylaxis, nephrotoxicity, C. diff, resistance.',
          'Choose high-yield meds (e.g., Vancomycin, Piperacillin-tazobactam).',
          'Write scenarios where cultures, trough levels, or allergies matter.',
          'Be ready to explain when you would STOP an antibiotic immediately.'
        ]
      }
    };

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    function initGroupView() {
      let groupNum = parseInt(getQueryParam('group'), 10);
      if (isNaN(groupNum) || groupNum < 1 || groupNum > 6) {
        groupNum = 1; // default to Group 1 if invalid
      }

      const config = groupConfig[groupNum];

      // Update header
      const systemLabel = document.getElementById('systemLabel');
      const groupLabel = document.getElementById('groupLabel');
      const systemNameInline = document.getElementById('systemNameInline');
      const huddleTitle = document.getElementById('huddleTitle');

      if (systemLabel) systemLabel.textContent = `System Focus: ${config.name}`;
      if (groupLabel) groupLabel.textContent = config.label;
      if (systemNameInline) systemNameInline.textContent = config.name;
      if (huddleTitle) huddleTitle.textContent = `${config.name} ‚Äì Top 3 Priorities`;

      // Instructions list
      const list = document.getElementById('instructionList');
      if (list) {
        list.innerHTML = '';
        config.instructions.forEach(text => {
          const li = document.createElement('li');
          li.textContent = text;
          list.appendChild(li);
        });
      }
    }

    document.addEventListener('DOMContentLoaded', initGroupView);

    // Auto-save to Firebase
    function setupFirebaseSync(groupNum) {
      const fields = ['safetyRisk', 'priorityLab', 'doNotMix', 'highYieldMed', 'scenarioPrompts', 'rationale'];
      const groupRef = database.ref('groups/' + groupNum);

      // Load existing data
      groupRef.once('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          fields.forEach(field => {
            const el = document.getElementById(field);
            if (el && data[field]) {
              el.value = data[field];
            }
          });
        }
      });

      // Save on input
      fields.forEach(fieldId => {
        const el = document.getElementById(fieldId);
        if (el) {
          el.addEventListener('input', () => {
            const updates = {};
            fields.forEach(field => {
              const input = document.getElementById(field);
              updates[field] = input ? input.value : '';
            });
            updates.systemName = groupConfig[groupNum].name;
            updates.timestamp = Date.now();
            groupRef.set(updates);
          });
        }
      });
    }

    function initGroupView() {
      let groupNum = parseInt(getQueryParam('group'), 10);
      if (isNaN(groupNum) || groupNum < 1 || groupNum > 6) {
        groupNum = 1; // default to Group 1 if invalid
      }

      const config = groupConfig[groupNum];

      // Update header
      const systemLabel = document.getElementById('systemLabel');
      const groupLabel = document.getElementById('groupLabel');
      const systemNameInline = document.getElementById('systemNameInline');
      const huddleTitle = document.getElementById('huddleTitle');

      if (systemLabel) systemLabel.textContent = `System Focus: ${config.name}`;
      if (groupLabel) groupLabel.textContent = config.label;
      if (systemNameInline) systemNameInline.textContent = config.name;
      if (huddleTitle) huddleTitle.textContent = `${config.name} ‚Äì Top 3 Priorities`;

      // Instructions list
      const list = document.getElementById('instructionList');
      if (list) {
        list.innerHTML = '';
        config.instructions.forEach(text => {
          const li = document.createElement('li');
          li.textContent = text;
          list.appendChild(li);
        });
      }

      // Setup Firebase sync
      setupFirebaseSync(groupNum);
    }

    document.addEventListener('DOMContentLoaded', initGroupView);

    // -----------------------------
    // GROUP ID HANDLING (Legacy - kept for compatibility)
    // -----------------------------

    let currentGroupId = null;

    // Note: Group selection now handled by selectGroup() function
    // This legacy code kept for any direct references

    // -----------------------------
    // DECISION ENGINE + STABILITY
    // -----------------------------

    /**
     * recordDecision({
     *   phase: 'flashcard' | 'jigsaw' | 'lightning' | ...,
     *   itemId: 'card1' or 'scenarioA',
     *   isCorrect: true/false,
     *   severity: 'minor' | 'moderate' | 'critical',
     *   explanation: 'text shown to instructor'
     * })
     */
    function recordDecision(config) {
      if (!currentGroupId) {
        const status = document.getElementById('fgStatus') || document.getElementById('groupIdStatus');
        if (status) {
          status.style.color = '#ff99c2';
          status.textContent = 'Set your Group # first.';
        }
        return;
      }

      const { phase, itemId, isCorrect, severity, explanation } = config;
      const groupRef = database.ref('groups/' + currentGroupId);
      const eventsRef = database.ref('events');

      // Stability deltas
      let delta = 0;
      if (!isCorrect) {
        if (severity === 'critical') delta = -25;
        else if (severity === 'moderate') delta = -15;
        else delta = -5;
      } else {
        // small positive bump for correct decisions if you want
        delta = +2;
      }

      // Update stability atomically
      groupRef.child('stability').transaction(current => {
        if (typeof current !== 'number') current = 100;
        let next = current + delta;
        if (next > 100) next = 100;
        if (next < 0) next = 0;
        return next;
      });

      // Log event (for instructor alerts/consequence mapping)
      const payload = {
        groupId: currentGroupId,
        phase: phase,
        itemId: itemId,
        isCorrect: !!isCorrect,
        severity: severity,
        explanation: explanation,
        delta: delta,
        timestamp: Date.now()
      };

      eventsRef.push(payload);
    }

    // -----------------------------
    // FLASHCARD DISPLAY + SYNC
    // -----------------------------

    function setupFlashcardSync() {
      const flashcards = document.querySelectorAll('.flashcard[data-card-id]');
      
      flashcards.forEach(card => {
        const cardId = card.dataset.cardId;
        if (!cardId) return;
        
        // Listen to Firebase for flip state
        database.ref('flashcards/' + cardId).on('value', (snapshot) => {
          const data = snapshot.val();
          if (data && data.flipped) {
            // Unlock and can be flipped
            card.classList.remove('locked');
            
            // Add visual feedback
            card.style.animation = 'pulse 0.5s ease';
            setTimeout(() => {
              card.style.animation = '';
            }, 500);
          }
        });
        
        // Allow manual toggle only if unlocked
        card.addEventListener('click', () => {
          if (!card.classList.contains('locked')) {
            card.classList.toggle('flipped');
          }
        });
      });
    }

    // Initialize flashcard sync
    setupFlashcardSync();

    // -----------------------------
    // FLASHCARD GUESS ‚Äì AUTO CHECK
    // -----------------------------

    // Map each card to the correct system
    const flashcardKey = {
      card1: 'Psychopharmacology',  // Haloperidol/Fluoxetine - EPS, serotonin syndrome
      card2: 'Neurological',        // Levodopa/Phenobarbital - on-off phenomenon
      card3: 'Pain',                // Fentanyl/Butorphanol - respiratory depression
      card4: 'Endocrine',           // PTU/Somatropin - agranulocytosis
      card5: 'Infection',           // Erythromycin/Rifampin/Amphotericin B - drug interactions
      card6: 'Inflammation'         // Belimumab/Allopurinol/Hydrocortisone - live vaccines
    };

    function submitFlashcardGuess() {
      const cardInput = document.getElementById('fgCard');
      const systemInput = document.getElementById('fgSystem');
      const statusEl = document.getElementById('fgStatus');

      statusEl.textContent = '';

      if (!currentGroupId) {
        statusEl.style.color = '#ff99c2';
        statusEl.textContent = 'Set your Group # first.';
        return;
      }

      const cardId = cardInput.value;
      const systemGuess = systemInput.value;

      if (!cardId) {
        statusEl.style.color = '#ff99c2';
        statusEl.textContent = 'Choose which card you are answering for.';
        return;
      }
      if (!systemGuess) {
        statusEl.style.color = '#ff99c2';
        statusEl.textContent = 'Select your system guess.';
        return;
      }

      const correctSystem = flashcardKey[cardId];
      const isCorrect = (systemGuess === correctSystem);

      if (isCorrect) {
        statusEl.style.color = '#00ffb3';
        statusEl.textContent = '‚úì Correct ‚Äì nice call! Your patient remains stable.';
        
        // Record correct decision (affects patient stability only)
        recordDecision({
          phase: 'flashcard',
          itemId: cardId,
          isCorrect: true,
          severity: 'minor',
          explanation: `Correctly identified ${cardId} as ${correctSystem}.`
        });
      } else {
        statusEl.style.color = '#ffb300';
        statusEl.textContent = `Not quite ‚Äì you picked ${systemGuess}, but the correct answer is ${correctSystem}. This affects your patient's stability.`;
        recordDecision({
          phase: 'flashcard',
          itemId: cardId,
          isCorrect: false,
          severity: 'moderate',
          explanation: `Misclassified ${cardId}: guessed ${systemGuess}, correct was ${correctSystem}.`
        });
      }

      // Reset form after brief delay
      setTimeout(() => {
        cardInput.value = '';
        systemInput.value = '';
      }, 2000);
    }

    const fgBtn = document.getElementById('fgSubmit');
    if (fgBtn) {
      fgBtn.addEventListener('click', submitFlashcardGuess);
    }

    // -----------------------------
    // JIGSAW LEARNING CHECKBOXES
    // -----------------------------

    const systemNames = {
      1: 'Neurological üß†',
      2: 'Psychopharmacology üíä',
      3: 'Pain Management üò£',
      4: 'Inflammation üî•',
      5: 'Endocrine ü©∫',
      6: 'Infection ü¶†'
    };

    function setupJigsawCheckboxes() {
      const container = document.getElementById('jigsawCheckboxes');
      if (!container || !currentGroupId) return;

      const jigsawRef = database.ref('jigsaw/group' + currentGroupId);

      // Load existing progress
      jigsawRef.once('value', (snapshot) => {
        const data = snapshot.val() || {};

        for (let sysNum = 1; sysNum <= 6; sysNum++) {
          const systemKey = 'system' + sysNum;
          const isCompleted = data[systemKey] === true;

          const box = document.createElement('div');
          box.style.cssText = 'background:rgba(255,255,255,0.05);border-radius:10px;padding:12px;border:1px solid rgba(0,212,255,0.3);display:flex;align-items:center;gap:10px;cursor:pointer;transition:all 0.2s ease;';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = 'jigsaw-sys-' + sysNum;
          checkbox.checked = isCompleted;
          checkbox.style.cssText = 'width:18px;height:18px;cursor:pointer;';

          const label = document.createElement('label');
          label.htmlFor = 'jigsaw-sys-' + sysNum;
          label.textContent = systemNames[sysNum];
          label.style.cssText = 'flex:1;cursor:pointer;font-size:14px;color:#ccecff;';

          box.appendChild(checkbox);
          box.appendChild(label);
          container.appendChild(box);

          // Save to Firebase when checked/unchecked
          checkbox.addEventListener('change', () => {
            jigsawRef.update({
              [systemKey]: checkbox.checked
            });

            // Optional: log a decision event
            if (checkbox.checked) {
              recordDecision({
                phase: 'jigsaw',
                itemId: systemKey,
                isCorrect: true,
                severity: 'minor',
                explanation: `Group ${currentGroupId} completed learning ${systemNames[sysNum]}`
              });
            }
          });

          // Visual feedback on hover
          box.addEventListener('mouseenter', () => {
            box.style.background = 'rgba(0,212,255,0.1)';
          });
          box.addEventListener('mouseleave', () => {
            box.style.background = 'rgba(255,255,255,0.05)';
          });
        }
      });

      // Listen for changes from instructor or other devices
      jigsawRef.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        for (let sysNum = 1; sysNum <= 6; sysNum++) {
          const checkbox = document.getElementById('jigsaw-sys-' + sysNum);
          if (checkbox) {
            checkbox.checked = data['system' + sysNum] === true;
          }
        }
      });
    }

    // Also initialize on page load if group ID already exists
    if (currentGroupId) {
      setupJigsawCheckboxes();
    }

    // Try again after a short delay in case group ID loads from localStorage
    setTimeout(() => {
      if (currentGroupId && document.getElementById('jigsawCheckboxes').children.length <= 1) {
        setupJigsawCheckboxes();
      }
    }, 1000);

    // -----------------------------
    // JIGSAW SPEED ROUND ‚Äì CASE ASSIGNMENT
    // -----------------------------

    // Map systems ‚Üí their flashcard card ID
    const systemToCard = {
      psych: 'card1',
      neuro: 'card2',
      pain: 'card3',
      endocrine: 'card4',
      infection: 'card5',
      inflammation: 'card6'
    };

    // JIGSAW CASE BANK
    const jigsawCases = {
      psych: {
        standard: {
          title: 'Psych ‚Äì Standard Case: Haloperidol (NMS Risk)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>You receive a new patient with schizophrenia started on <strong>Haloperidol</strong> 48 hours ago.</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Temperature: <strong>100.9¬∞F</strong></li>
              <li>Increasing <strong>muscle rigidity</strong></li>
              <li>BP: <strong>168/94</strong>, HR <strong>128</strong></li>
              <li>Patient looks confused and diaphoretic.</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority concern</strong>, and what is your <strong>first action</strong> as the nurse?</p>
          `
        },
        consequence: {
          title: 'Psych ‚Äì Consequence Case: Fluoxetine + Tramadol (Serotonin Syndrome)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>Patient on <strong>fluoxetine</strong> for depression and <strong>tramadol</strong> for chronic pain presents with:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Temperature: <strong>102.6¬∞F</strong></li>
              <li><strong>Clonus</strong> and hyperreflexia</li>
              <li>Agitation, flushed skin, heavy sweating</li>
              <li>BP <strong>154/90</strong>, HR <strong>132</strong></li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is happening, and what is your <strong>first priority action</strong>?</p>
          `
        }
      },

      neuro: {
        standard: {
          title: 'Neuro ‚Äì Standard Case: Levodopa/Carbidopa (Fall Risk)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A Parkinson's patient taking <strong>levodopa-carbidopa</strong> reports:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Improved tremors</li>
              <li><strong>Dizziness</strong> when standing</li>
              <li>Nausea</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority nursing focus</strong> for this patient to prevent harm?</p>
          `
        },
        consequence: {
          title: 'Neuro ‚Äì Consequence Case: Phenobarbital Toxicity',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A seizure patient taking <strong>phenobarbital</strong> is found:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Very lethargic, difficult to arouse</li>
              <li>RR <strong>8</strong></li>
              <li>BP <strong>90/60</strong></li>
              <li>Pupils sluggish</li>
              <li>Admits: "I took a little extra dose because I felt a seizure coming."</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority action</strong>, and what is the likely cause of this decline?</p>
          `
        }
      },

      pain: {
        standard: {
          title: 'Pain ‚Äì Standard Case: Fentanyl Monitoring',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>Post-op patient received IV <strong>fentanyl</strong> 20 minutes ago.</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Pain decreases from 9/10 ‚Üí 3/10</li>
              <li>RR <strong>10</strong>, shallow but arousable</li>
              <li>SpO‚ÇÇ <strong>92%</strong> on 2 L/min NC</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>next nursing action</strong> and what should you watch closely?</p>
          `
        },
        consequence: {
          title: 'Pain ‚Äì Consequence Case: Fentanyl Overdose',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>Same post-op patient now:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>RR <strong>6</strong></li>
              <li>Unresponsive to voice</li>
              <li>SpO‚ÇÇ <strong>84%</strong></li>
              <li>Pinpoint pupils</li>
              <li>An empty fentanyl PCA vial is in the bed.</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>first priority action</strong>, and what medication do you anticipate administering?</p>
          `
        }
      },

      endocrine: {
        standard: {
          title: 'Endocrine ‚Äì Standard Case: PTU (Agranulocytosis Risk)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A patient on <strong>PTU</strong> for hyperthyroidism reports:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Sore throat</li>
              <li>Mild fever</li>
              <li>Fatigue</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What lab value is your <strong>priority</strong>, and why?</p>
          `
        },
        consequence: {
          title: 'Endocrine ‚Äì Consequence Case: PTU Agranulocytosis',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>Same PTU patient now presents with:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Temp <strong>101.8¬∞F</strong></li>
              <li>Severe sore throat</li>
              <li>WBC <strong>1,200</strong></li>
              <li>BP <strong>92/54</strong>, HR <strong>130</strong></li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What condition are you most concerned about and what is your <strong>immediate nursing action</strong>?</p>
          `
        }
      },

      infection: {
        standard: {
          title: 'Infection ‚Äì Standard Case: Rifampin (Liver Monitoring)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A TB patient on <strong>rifampin</strong> reports:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Orange-colored urine and tears</li>
              <li>Mild fatigue</li>
              <li>Mild abdominal discomfort</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            Which lab values are your <strong>priority</strong> to monitor, and why?</p>
          `
        },
        consequence: {
          title: 'Infection ‚Äì Consequence Case: Amphotericin B Nephrotoxicity',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A patient on IV <strong>Amphotericin B</strong> for fungal infection now has:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Creatinine rising from 0.9 ‚Üí <strong>2.4</strong></li>
              <li>K‚Å∫ <strong>6.1</strong></li>
              <li>EKG showing <strong>peaked T waves</strong></li>
              <li>Rigors and fevers with infusions</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority</strong> response, and what earlier monitoring could have prevented this?</p>
          `
        }
      },

      inflammation: {
        standard: {
          title: 'Inflammation ‚Äì Standard Case: Belimumab (Infection Risk)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A lupus patient on <strong>belimumab</strong> reports:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>New fatigue</li>
              <li>Mild sore throat</li>
              <li>Low-grade temp 99.9¬∞F</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority teaching</strong> for this patient?</p>
          `
        },
        consequence: {
          title: 'Inflammation ‚Äì Consequence Case: Allopurinol (SJS/TEN)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A gout patient on <strong>allopurinol</strong> develops:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Widespread painful rash</li>
              <li>Blistering lesions</li>
              <li>Fever</li>
              <li>Oral and mucosal involvement</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority concern</strong>, and what should you do immediately?</p>
          `
        }
      }
    };

    // Decide which variant a group gets: standard vs consequence
    function decideJigsawVariantForGroup(systemKey) {
      return new Promise((resolve, reject) => {
        if (!currentGroupId) {
          return reject(new Error('Group # not set. Make sure your group has already used the site for Phase 1.'));
        }

        const cardId = systemToCard[systemKey];
        if (!cardId) return reject(new Error('Unknown system selection.'));

        const groupRef = database.ref('groups/' + currentGroupId + '/stability');
        const eventsRef = database.ref('events').orderByChild('groupId').equalTo(currentGroupId);

        // Get stability + events in parallel
        Promise.all([
          groupRef.once('value'),
          eventsRef.once('value')
        ]).then(([stabilitySnap, eventsSnap]) => {
          const stability = typeof stabilitySnap.val() === 'number' ? stabilitySnap.val() : 100;
          let hadFlashcardMiss = false;

          const eventsVal = eventsSnap.val() || {};
          Object.values(eventsVal).forEach(ev => {
            if (
              ev.phase === 'flashcard' &&
              ev.itemId === cardId &&
              ev.isCorrect === false
            ) {
              hadFlashcardMiss = true;
            }
          });

          // RULE:
          // If they missed the flashcard for this system OR their stability is < 75 ‚Üí consequence case.
          // Otherwise ‚Üí standard case.
          if (hadFlashcardMiss || stability < 75) {
            resolve('consequence');
          } else {
            resolve('standard');
          }

        }).catch(err => reject(err));
      });
    }

    // Hook up the "Get My Case" button
    const jigsawCaseBtn = document.getElementById('jigsawCaseBtn');
    const jigsawSystemSelect = document.getElementById('jigsawSystemSelect');
    const jigsawCaseDisplay = document.getElementById('jigsawCaseDisplay');
    const jigsawStatus = document.getElementById('jigsawStatus');

    if (jigsawCaseBtn && jigsawSystemSelect && jigsawCaseDisplay) {
      jigsawCaseBtn.addEventListener('click', () => {
        jigsawStatus.textContent = '';
        jigsawCaseDisplay.innerHTML = '<em style="color:#ccecff;font-size:13px;">Loading case...</em>';

        const systemKey = jigsawSystemSelect.value;
        if (!systemKey) {
          jigsawStatus.style.color = '#ff99c2';
          jigsawStatus.textContent = 'Please select your expert system first.';
          jigsawCaseDisplay.innerHTML = '<em style="color:#ccecff;font-size:13px;">No case loaded.</em>';
          return;
        }

        if (!jigsawCases[systemKey]) {
          jigsawStatus.style.color = '#ff99c2';
          jigsawStatus.textContent = 'Case bank not configured for that system.';
          return;
        }

        decideJigsawVariantForGroup(systemKey)
          .then(variant => {
            const caseData = jigsawCases[systemKey][variant];
            if (!caseData) {
              throw new Error('No case configured for that variant.');
            }
            jigsawCaseDisplay.innerHTML = `
              <h3 style="color:#00ffb3;margin-top:0;">${caseData.title}</h3>
              ${caseData.html}
              <p style="margin-top:12px;font-size:12px;color:#ccecff;">
                <em>Note for your group:</em> This scenario was assigned based on your earlier decisions in Phase 1.
              </p>
            `;
          })
          .catch(err => {
            console.error(err);
            jigsawStatus.style.color = '#ff99c2';
            jigsawStatus.textContent = 'Unable to assign case. Check your group number and Firebase connection.';
            jigsawCaseDisplay.innerHTML = '<em style="color:#ff9f9f;font-size:13px;">Error loading case.</em>';
          });
      });
    }

    // -----------------------------
    // GROUP & LEADERSHIP SELECTION
    // -----------------------------
    let selectedGroupNumber = null;
    let selectedRole = null;

    function selectLeadership(role) {
      selectedRole = role;
      
      // Store role in localStorage
      try {
        localStorage.setItem('pharmBlitzRole', role);
        localStorage.removeItem('pharmBlitzGroupId'); // Clear group if switching to leadership
      } catch (e) {}

      // Claim this leadership role in Firebase
      const leadershipRef = database.ref('leadership/' + role);
      leadershipRef.set({
        claimed: true,
        timestamp: Date.now()
      });

      // Hide selection, show leadership dashboard
      document.getElementById('groupSelectionScreen').classList.add('hidden');
      document.getElementById('leadershipDashboard').style.display = 'block';

      // Set role label
      const roleNames = {
        charge1: 'Charge Nurse 1',
        charge2: 'Charge Nurse 2',
        rrt: 'Rapid Response RN'
      };
      document.getElementById('leadershipRoleLabel').textContent = 'Role: ' + roleNames[role];

      // Show appropriate sections
      if (role === 'rrt') {
        document.getElementById('rrtControls').style.display = 'none';
        document.getElementById('rrtCalls').style.display = 'block';
        document.getElementById('debriefBoard').style.display = 'none';
        document.getElementById('errorLogSection').style.display = 'none';
        document.getElementById('groupCasesSection').style.display = 'none';
        setupRRTListener();
      } else {
        document.getElementById('rrtControls').style.display = 'block';
        document.getElementById('rrtCalls').style.display = 'none';
        document.getElementById('debriefBoard').style.display = 'block';
        document.getElementById('errorLogSection').style.display = 'block';
        document.getElementById('groupCasesSection').style.display = 'block';
        setupDebriefBoard(role);
      }

      // Initialize dashboards
      setupAllGroupsMonitor();
      if (role !== 'rrt') {
        setupErrorLog();
        setupGroupCasesMonitor();
      }
    }

    function selectGroup(groupNumber) {
      currentGroupId = groupNumber;
      selectedGroupNumber = groupNumber;
      
      // Store group in localStorage
      try {
        localStorage.setItem('pharmBlitzGroupId', String(currentGroupId));
        localStorage.removeItem('pharmBlitzRole'); // Clear leadership role if joining group
      } catch (e) {}

      // Hide selection screen, show group activity content
      document.getElementById('groupSelectionScreen').classList.add('hidden');
      document.getElementById('groupActivityContent').classList.add('active');

      // Update mission instructions
      const instructionList = document.getElementById('instructionList');
      if (instructionList && config.instructions) {
        instructionList.innerHTML = '';
        config.instructions.forEach(text => {
          const li = document.createElement('li');
          li.textContent = text;
          instructionList.appendChild(li);
        });
      }

      // Update huddle title
      const huddleTitle = document.getElementById('huddleTitle');
      if (huddleTitle) {
        huddleTitle.textContent = config.name + ' ‚Äì Top 3 Priorities';
      }

      // Show mission section
      const missionSection = document.getElementById('missionSection');
      if (missionSection) {
        missionSection.style.display = 'block';
      }

      // Initialize stability in Firebase
      const groupRef = database.ref('groups/' + currentGroupId);
      groupRef.child('stability').once('value').then(snap => {
        if (snap.val() == null) {
          groupRef.update({ stability: 100 });
        }
      });

      // Setup Firebase sync for this group
      if (typeof setupFirebaseSync === 'function') {
        setupFirebaseSync(groupNumber);
      }

      // Initialize jigsaw checkboxes
      if (typeof setupJigsawCheckboxes === 'function') {
        setupJigsawCheckboxes();
      }
    }

    // -----------------------------
    // LEADERSHIP DASHBOARD FUNCTIONS
    // -----------------------------
    function setupAllGroupsMonitor() {
      const container = document.getElementById('allGroupsStability');
      const groupNames = ['Neuro', 'Psych', 'Pain', 'Inflam', 'Endo', 'Infection'];
      
      for (let i = 1; i <= 6; i++) {
        const groupRef = database.ref('groups/' + i + '/stability');
        const groupDiv = document.createElement('div');
        groupDiv.id = 'groupStability' + i;
        groupDiv.style.cssText = 'padding:15px;background:rgba(255,255,255,0.05);border-radius:12px;border:2px solid rgba(0,212,255,0.3);';
        groupDiv.innerHTML = `
          <div style="font-size:18px;font-weight:700;color:#00d4ff;margin-bottom:8px;">Group ${i}: ${groupNames[i-1]}</div>
          <div style="font-size:32px;font-weight:900;color:#00ffb3;" id="stabilityValue${i}">100</div>
          <div style="font-size:12px;color:#ccecff;margin-top:4px;">Patient Stability</div>
        `;
        container.appendChild(groupDiv);
        
        groupRef.on('value', snap => {
          const stability = snap.val() || 100;
          const valueEl = document.getElementById('stabilityValue' + i);
          if (valueEl) {
            valueEl.textContent = stability;
            valueEl.style.color = stability >= 75 ? '#00ffb3' : stability >= 50 ? '#ffb300' : '#ff006e';
          }
        });
      }
    }

    function setupErrorLog() {
      const container = document.getElementById('allGroupsErrors');
      const eventsRef = database.ref('events').orderByChild('timestamp').limitToLast(50);
      
      eventsRef.on('child_added', snap => {
        const event = snap.val();
        if (!event.isCorrect) {
          const div = document.createElement('div');
          div.style.cssText = 'padding:10px;margin-bottom:8px;background:rgba(255,255,255,0.05);border-radius:8px;border-left:4px solid #ff006e;';
          div.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <strong style="color:#ff99c2;">Group ${event.groupId} ‚Äì ${event.phase}</strong>
              <span style="font-size:11px;color:#ccecff;">${new Date(event.timestamp).toLocaleTimeString()}</span>
            </div>
            <div style="font-size:13px;color:#ccecff;">${event.explanation || 'Error recorded'}</div>
            <div style="font-size:12px;color:#ffb300;margin-top:4px;">Stability: ${event.delta}</div>
          `;
          container.prepend(div);
        }
      });
    }

    function setupGroupCasesMonitor() {
      const container = document.getElementById('groupCases');
      container.innerHTML = '<p style="color:#ccecff;font-size:14px;">Group case assignments will appear here during Jigsaw Speed Round.</p>';
      
      // Monitor jigsaw cases when they're generated
      for (let i = 1; i <= 6; i++) {
        const caseRef = database.ref('jigsaw/group' + i + '/assignedCase');
        caseRef.on('value', snap => {
          const caseData = snap.val();
          if (caseData) {
            // Show case with approve/escalate buttons
            const caseDiv = document.createElement('div');
            caseDiv.style.cssText = 'padding:15px;margin-bottom:12px;background:rgba(255,255,255,0.05);border-radius:12px;border:2px solid rgba(0,212,255,0.3);';
            caseDiv.innerHTML = `
              <h4 style="color:#00d4ff;margin:0 0 10px 0;">Group ${i} ‚Äì ${caseData.system || 'System'}</h4>
              <div style="font-size:13px;color:#ccecff;margin-bottom:12px;">${caseData.title || 'Case assigned'}</div>
              <div style="display:flex;gap:10px;">
                <button class="assign-btn" onclick="approveAnswer(${i})" style="background:#00ffb3;">‚úì Approve</button>
                <button class="assign-btn" onclick="escalateAnswer(${i})" style="background:#ff006e;">‚ö† Escalate</button>
              </div>
            `;
            document.getElementById('groupCases').appendChild(caseDiv);
          }
        });
      }
    }

    function setupDebriefBoard(role) {
      const container = document.getElementById('debriefGroups');
      const groupNames = {1: 'Neurological', 2: 'Psychopharmacology', 3: 'Pain', 4: 'Inflammation', 5: 'Endocrine', 6: 'Infection'};
      
      // Charge 1 gets groups 1-3, Charge 2 gets groups 4-6
      const assignedGroups = role === 'charge1' ? [1, 2, 3] : [4, 5, 6];
      
      assignedGroups.forEach(groupId => {
        const groupDiv = document.createElement('div');
        groupDiv.style.cssText = 'padding:15px;margin-bottom:15px;background:rgba(255,255,255,0.05);border-radius:12px;border:2px solid rgba(0,212,255,0.3);';
        
        groupDiv.innerHTML = `
          <h4 style="color:#00d4ff;margin:0 0 10px 0;">Group ${groupId}: ${groupNames[groupId]}</h4>
          <textarea 
            id="debrief${groupId}" 
            rows="4" 
            placeholder="What did this group do well? What challenges did they face? Key learning points..."
            style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:8px;padding:10px;color:#fff;font-family:inherit;font-size:13px;resize:vertical;"
          ></textarea>
          <div style="display:flex;gap:10px;margin-top:8px;align-items:center;">
            <button class="assign-btn" onclick="saveDebrief(${groupId})" style="background:#00ffb3;">üíæ Save</button>
            <span id="debriefStatus${groupId}" style="font-size:12px;color:#00ffb3;"></span>
          </div>
        `;
        
        container.appendChild(groupDiv);
        
        // Load existing debrief if any
        const debriefRef = database.ref('debrief/group' + groupId);
        debriefRef.on('value', snap => {
          const data = snap.val();
          const textarea = document.getElementById('debrief' + groupId);
          if (data && data.content && textarea) {
            textarea.value = data.content;
          }
        });
      });
    }

    function saveDebrief(groupId) {
      const textarea = document.getElementById('debrief' + groupId);
      const status = document.getElementById('debriefStatus' + groupId);
      const content = textarea.value;
      
      if (!content.trim()) {
        status.style.color = '#ff99c2';
        status.textContent = 'Please enter some notes first';
        return;
      }
      
      database.ref('debrief/group' + groupId).set({
        content: content,
        chargeNurse: selectedRole,
        timestamp: Date.now()
      }).then(() => {
        status.style.color = '#00ffb3';
        status.textContent = '‚úì Saved';
        setTimeout(() => {
          status.textContent = '';
        }, 2000);
      }).catch(err => {
        status.style.color = '#ff006e';
        status.textContent = 'Error saving';
      });
    }

    function setupRRTListener() {
      const container = document.getElementById('activeCalls');
      const interventionsSection = document.getElementById('rrtInterventions');
      const interventionOptions = document.getElementById('interventionOptions');
      const rrtRef = database.ref('rrt/calls');
      
      rrtRef.on('child_added', snap => {
        const call = snap.val();
        const callDiv = document.createElement('div');
        callDiv.id = 'rrtCall' + snap.key;
        callDiv.style.cssText = 'padding:20px;margin-bottom:12px;background:rgba(255,0,110,0.1);border-radius:12px;border:2px solid #ff006e;animation:pulse 2s infinite;';
        callDiv.innerHTML = `
          <h4 style="color:#ff006e;margin:0 0 15px 0;">üö® RRT CALL: Group ${call.groupId}</h4>
          
          <div style="background:rgba(0,0,0,0.3);padding:15px;border-radius:8px;margin-bottom:15px;">
            <h5 style="color:#00ffb3;margin:0 0 10px 0;">SBAR Report from ${call.calledBy || 'Charge Nurse'}</h5>
            
            <div style="margin-bottom:8px;">
              <strong style="color:#00d4ff;">Situation:</strong>
              <p style="margin:4px 0;color:#ccecff;font-size:13px;">${call.sbar.situation || 'Not provided'}</p>
            </div>
            
            <div style="margin-bottom:8px;">
              <strong style="color:#00d4ff;">Background:</strong>
              <p style="margin:4px 0;color:#ccecff;font-size:13px;">${call.sbar.background || 'Not provided'}</p>
            </div>
            
            <div style="margin-bottom:8px;">
              <strong style="color:#00d4ff;">Assessment:</strong>
              <p style="margin:4px 0;color:#ccecff;font-size:13px;">${call.sbar.assessment || 'Not provided'}</p>
            </div>
            
            <div>
              <strong style="color:#00d4ff;">Recommendation:</strong>
              <p style="margin:4px 0;color:#ccecff;font-size:13px;">${call.sbar.recommendation || 'Not provided'}</p>
            </div>
          </div>
          
          <div style="font-size:14px;color:#ffb300;font-weight:600;">Patient Stability: ${call.stability || 'Unknown'}</div>
        `;
        container.innerHTML = '';
        container.appendChild(callDiv);
        
        // Show intervention options
        interventionsSection.style.display = 'block';
        interventionOptions.innerHTML = `
          <div class="role-option" onclick="applyIntervention(${call.groupId}, '${snap.key}', 'stabilize', 30)">
            <div style="font-size:36px;margin-bottom:8px;">üíâ</div>
            <div style="font-size:16px;font-weight:700;color:#00ffb3;margin-bottom:5px;">Stabilize Patient</div>
            <div style="font-size:12px;color:#b8e0ff;">+30 stability</div>
          </div>
          
          <div class="role-option" onclick="applyIntervention(${call.groupId}, '${snap.key}', 'medication', 20)">
            <div style="font-size:36px;margin-bottom:8px;">üíä</div>
            <div style="font-size:16px;font-weight:700;color:#00ffb3;margin-bottom:5px;">Administer Medication</div>
            <div style="font-size:12px;color:#b8e0ff;">+20 stability</div>
          </div>
          
          <div class="role-option" onclick="applyIntervention(${call.groupId}, '${snap.key}', 'oxygen', 15)">
            <div style="font-size:36px;margin-bottom:8px;">üòÆ‚Äçüí®</div>
            <div style="font-size:16px;font-weight:700;color:#00ffb3;margin-bottom:5px;">Oxygen Support</div>
            <div style="font-size:12px;color:#b8e0ff;">+15 stability</div>
          </div>
          
          <div class="role-option" onclick="applyIntervention(${call.groupId}, '${snap.key}', 'monitoring', 10)">
            <div style="font-size:36px;margin-bottom:8px;">üìä</div>
            <div style="font-size:16px;font-weight:700;color:#00ffb3;margin-bottom:5px;">Enhanced Monitoring</div>
            <div style="font-size:12px;color:#b8e0ff;">+10 stability</div>
          </div>
        `;
      });
      
      rrtRef.on('child_removed', () => {
        container.innerHTML = '<p style="color:#ccecff;font-size:14px;">No active calls. Standby for charge nurse alerts.</p>';
        interventionsSection.style.display = 'none';
      });
    }

    let currentRRTGroup = null;

    function openRRTReport(groupId) {
      currentRRTGroup = groupId;
      const groupNames = {1: 'Neurological', 2: 'Psychopharmacology', 3: 'Pain', 4: 'Inflammation', 5: 'Endocrine', 6: 'Infection'};
      document.getElementById('sbarGroupInfo').textContent = `Group ${groupId}: ${groupNames[groupId]}`;
      document.getElementById('sbarModal').style.display = 'block';
    }

    function closeSBARModal() {
      document.getElementById('sbarModal').style.display = 'none';
      document.getElementById('sbarSituation').value = '';
      document.getElementById('sbarBackground').value = '';
      document.getElementById('sbarAssessment').value = '';
      document.getElementById('sbarRecommendation').value = '';
      currentRRTGroup = null;
    }

    function submitRRTCall() {
      const situation = document.getElementById('sbarSituation').value;
      const background = document.getElementById('sbarBackground').value;
      const assessment = document.getElementById('sbarAssessment').value;
      const recommendation = document.getElementById('sbarRecommendation').value;

      if (!situation || !background || !assessment || !recommendation) {
        alert('Please complete all SBAR fields before calling RRT.');
        return;
      }

      const rrtRef = database.ref('rrt/calls').push();
      const groupRef = database.ref('groups/' + currentRRTGroup + '/stability');
      
      groupRef.once('value').then(snap => {
        const stability = snap.val() || 100;
        rrtRef.set({
          groupId: currentRRTGroup,
          stability: stability,
          timestamp: Date.now(),
          calledBy: selectedRole,
          sbar: {
            situation: situation,
            background: background,
            assessment: assessment,
            recommendation: recommendation
          }
        });
        
        closeSBARModal();
        alert(`RRT called to Group ${currentRRTGroup}. Rapid Response RN has been notified with your SBAR report.`);
      });
    }

    function applyIntervention(groupId, callKey, interventionType, stabilityBoost) {
      const groupRef = database.ref('groups/' + groupId + '/stability');
      
      groupRef.transaction(current => {
        return Math.min(100, (current || 0) + stabilityBoost);
      }).then(() => {
        // Remove the call
        database.ref('rrt/calls/' + callKey).remove();
        
        // Log event
        database.ref('events').push({
          groupId: groupId,
          phase: 'rrt-rescue',
          isCorrect: true,
          delta: stabilityBoost,
          explanation: `RRT applied ${interventionType} intervention`,
          timestamp: Date.now()
        });
        
        alert(`Intervention applied to Group ${groupId}! ${interventionType.toUpperCase()}: +${stabilityBoost} stability.`);
      });
    }

    function approveAnswer(groupId) {
      database.ref('groups/' + groupId + '/approval').set({
        status: 'approved',
        by: selectedRole,
        timestamp: Date.now()
      });
      alert(`Group ${groupId} answer approved!`);
    }

    function escalateAnswer(groupId) {
      database.ref('groups/' + groupId + '/approval').set({
        status: 'escalated',
        by: selectedRole,
        timestamp: Date.now()
      });
      alert(`Group ${groupId} case escalated for review.`);
    }

    // -----------------------------
    // PAGE LOAD: CHECK EXISTING ROLE
    // -----------------------------
    
    // Check which leadership roles are already claimed
    // TEMPORARILY DISABLED FOR TESTING
    /*
    (function checkLeadershipAvailability() {
      // Wait a moment for Firebase to be ready
      setTimeout(() => {
        const leadershipRef = database.ref('leadership');
        leadershipRef.once('value').then(snapshot => {
          const leadership = snapshot.val() || {};
          
          // Only disable if explicitly claimed with timestamp in last hour
          const oneHourAgo = Date.now() - (60 * 60 * 1000);
          
          if (leadership.charge1 && leadership.charge1.claimed && leadership.charge1.timestamp > oneHourAgo) {
            const el = document.getElementById('charge1Option');
            if (el) el.classList.add('disabled');
          }
          if (leadership.charge2 && leadership.charge2.claimed && leadership.charge2.timestamp > oneHourAgo) {
            const el = document.getElementById('charge2Option');
            if (el) el.classList.add('disabled');
          }
          if (leadership.rrt && leadership.rrt.claimed && leadership.rrt.timestamp > oneHourAgo) {
            const el = document.getElementById('rrtOption');
            if (el) el.classList.add('disabled');
          }
        }).catch(err => {
          console.log('Leadership check failed:', err);
        });
      }, 500);
    })();
    */
    
    (function checkExistingGroup() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        
        // If ?select=1 parameter present, clear saved roles and show selection screen
        if (urlParams.get('select') === '1') {
          localStorage.removeItem('pharmBlitzGroupId');
          localStorage.removeItem('pharmBlitzRole');
          // Show selection screen (do nothing else)
          return;
        }
        
        // Check if URL has ?group parameter (old direct links)
        const groupParam = urlParams.get('group');
        if (groupParam) {
          const groupNum = parseInt(groupParam, 10);
          if (groupNum >= 1 && groupNum <= 6) {
            selectGroup(groupNum);
            return;
          }
        }
        
        // Check for saved leadership role first
        const savedRole = localStorage.getItem('pharmBlitzRole');
        if (savedRole && ['charge1', 'charge2', 'rrt'].includes(savedRole)) {
          selectLeadership(savedRole);
          return;
        }
        
        // Otherwise, auto-load saved group if exists
        const saved = localStorage.getItem('pharmBlitzGroupId');
        if (saved) {
          const groupNum = parseInt(saved, 10);
          if (groupNum >= 1 && groupNum <= 6) {
            selectGroup(groupNum);
          }
        }
      } catch (e) {}
    })();
  </script>
</body>
</html>
