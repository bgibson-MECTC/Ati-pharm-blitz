<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ATI Pharm Blitz ‚Äì Group View</title>

  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a1128 0%, #1e3a5f 100%);
      color: #ffffff;
      overflow-x: hidden;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    .main-wrapper {
      width: 100%;
      min-height: 100vh;
      overflow-y: auto;
      padding: 40px 20px;
      max-width: 1100px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    .main-title {
      font-size: 36px;
      font-weight: 900;
      background: linear-gradient(90deg, #00d4ff, #00ffb3, #00d4ff);
      background-size: 200% auto;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 3s linear infinite;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 16px;
      color: #00ffb3;
      font-weight: 400;
      margin-bottom: 4px;
    }

    .group-label {
      font-size: 14px;
      color: #ccecff;
    }

    @keyframes shimmer {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }

    .section {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      border: 2px solid rgba(0, 212, 255, 0.3);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
      padding-bottom: 10px;
      border-bottom: 2px solid #00d4ff;
    }

    .section-icon {
      font-size: 28px;
    }

    .section-title {
      font-size: 22px;
      font-weight: 700;
      color: #00ffb3;
      margin: 0;
    }

    .huddle-box {
      background: rgba(0, 212, 255, 0.1);
      border: 2px solid #00d4ff;
      border-radius: 15px;
      padding: 20px;
      margin-top: 10px;
    }

    .huddle-box h3 {
      color: #00ffb3;
      font-size: 20px;
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
    }

    .huddle-field {
      margin-bottom: 15px;
    }

    .huddle-field label {
      display: block;
      color: #00d4ff;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .huddle-field input,
    .huddle-field textarea {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 8px;
      padding: 9px;
      color: #ffffff;
      font-size: 14px;
      font-family: inherit;
    }

    .huddle-field textarea {
      min-height: 70px;
      resize: vertical;
    }

    .huddle-field input:focus,
    .huddle-field textarea:focus {
      outline: none;
      border-color: #00ffb3;
      background: rgba(255, 255, 255, 0.15);
    }

    .instructions-list {
      color: #ccecff;
      font-size: 14px;
      padding-left: 18px;
    }

    .instructions-list li {
      margin-bottom: 6px;
    }

    .back-link {
      display: inline-block;
      margin-top: 10px;
      font-size: 13px;
      color: #00ffb3;
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,212,255,0.5);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #ccecff;
      margin-left: 6px;
    }

    @media (max-width: 768px) {
      .main-title {
        font-size: 26px;
      }
      .section-title {
        font-size: 19px;
      }
    }

    /* Flashcard Guess */
    .flashguess-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 10px;
    }

    .fg-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #00d4ff;
      margin-bottom: 5px;
    }

    .fg-input {
      width: 100%;
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      border: 1px solid rgba(0,212,255,0.4);
      color: #ffffff;
      padding: 8px 10px;
      font-size: 14px;
      font-family: inherit;
    }

    .fg-input:focus {
      outline: none;
      border-color: #00ffb3;
      background: rgba(255,255,255,0.12);
    }

    @media (max-width: 600px) {
      .flashguess-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <header>
      <h1 class="main-title">ATI Pharm Blitz</h1>
      <p class="subtitle" id="systemLabel">Group System: ‚Ä¶</p>
      <p class="group-label" id="groupLabel">Group: ‚Ä¶</p>
      <a href="index.html" class="back-link">‚¨Ö Back to Instructor View</a>
    </header>

    <!-- Instructions -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üìã</span>
        <h2 class="section-title">Your Mission<span class="pill">Group View</span></h2>
      </div>
      <ul class="instructions-list" id="instructionList">
        <!-- Filled dynamically based on system -->
      </ul>
    </section>

    <!-- GROUP IDENTIFIER -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üè∑Ô∏è</span>
        <h2 class="section-title">Group Identity</h2>
      </div>
      <p style="color:#ccecff;font-size:14px;margin-bottom:10px;">
        One device per table: enter your Group # exactly as assigned (1‚Äì6). The site will track your patient's stability based on your decisions.
      </p>
      <input id="groupIdInput" type="number" min="1" max="6"
             placeholder="Enter your Group #"
             style="background:rgba(255,255,255,0.08);border-radius:8px;border:1px solid rgba(0,212,255,0.4);color:#ffffff;padding:8px 10px;font-size:14px;">
      <button id="saveGroupIdBtn" class="assign-btn" style="margin-left:8px;">Set Group</button>
      <p id="groupIdStatus" class="assign-error"></p>
    </section>

    <!-- FLASHCARD GUESS SUBMISSION -->
    <section class="section" id="flashcardGuessSection">
      <div class="section-header">
        <span class="section-icon">üß†</span>
        <h2 class="section-title">Flashcard Guess ‚Äì Before You Flip</h2>
      </div>
      <p style="color:#ccecff;font-size:14px;margin-bottom:10px;">
        Before you flip a flashcard, submit your group's best guess for which system it belongs to.
        This affects your patient's stability later in the lab.
      </p>

      <div class="flashguess-grid">
        <div>
          <label class="fg-label">Card ID</label>
          <select id="fgCard" class="fg-input">
            <option value="">Choose card‚Ä¶</option>
            <option value="card1">Card 1</option>
            <option value="card2">Card 2</option>
            <option value="card3">Card 3</option>
            <option value="card4">Card 4</option>
            <option value="card5">Card 5</option>
            <option value="card6">Card 6</option>
          </select>
        </div>
        <div>
          <label class="fg-label">System Guess</label>
          <select id="fgSystem" class="fg-input">
            <option value="">Select system‚Ä¶</option>
            <option value="Neurological">Neurological</option>
            <option value="Psychopharmacology">Psychopharmacology</option>
            <option value="Pain">Pain</option>
            <option value="Inflammation">Inflammation</option>
            <option value="Endocrine">Endocrine</option>
            <option value="Infection">Infection</option>
          </select>
        </div>
      </div>
      <button id="fgSubmit" class="assign-btn" style="margin-top:12px;">Submit Guess</button>
      <p id="fgStatus" class="assign-error"></p>
    </section>

    <!-- Expert Huddle Box (single system) -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üë©‚Äç‚öïÔ∏è</span>
        <h2 class="section-title">Expert Huddle ‚Äì <span id="systemNameInline">System</span></h2>
      </div>

      <div class="huddle-box" id="huddleBox">
        <h3 id="huddleTitle">System Experts</h3>

        <div class="huddle-field">
          <label>#1 Safety Risk (What kills the patient first?)</label>
          <input type="text" id="safetyRisk" placeholder="e.g., Respiratory depression, Lithium toxicity, GI bleed">
        </div>

        <div class="huddle-field">
          <label>#1 Lab / Assessment to Monitor</label>
          <input type="text" id="priorityLab" placeholder="e.g., Lithium level, INR, Blood glucose, WBC">
        </div>

        <div class="huddle-field">
          <label>"Do Not Mix" Rule</label>
          <input type="text" id="doNotMix" placeholder="e.g., MAOIs + SSRIs, opioids + benzos, NSAIDs + anticoagulants">
        </div>

        <div class="huddle-field">
          <label>High-Yield Medication(s)</label>
          <input type="text" id="highYieldMed" placeholder="e.g., Lithium, Vancomycin, Morphine, Insulin">
        </div>

        <div class="huddle-field">
          <label>Scenario Prompts (at least 2)</label>
          <textarea id="scenarioPrompts" placeholder="Example:
1) Your patient on ___ develops ___. What is your first action?
2) Teaching point the patient MUST remember about this med."></textarea>
        </div>

        <div class="huddle-field">
          <label>Rationale: Why are these your Top 3 priorities?</label>
          <textarea id="rationale" placeholder="Connect back to ATI, safety, and NCLEX-style thinking."></textarea>
        </div>
      </div>
    </section>

    <!-- JIGSAW LEARNING TRACKER -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üîÑ</span>
        <h2 class="section-title">Jigsaw Learning ‚Äì Track Your Progress</h2>
      </div>

      <p style="color:#ccecff;font-size:14px;margin-bottom:15px;">
        As you rotate through each system station, check off what you've learned. 
        When you complete a system's teaching, click the checkbox below to mark it complete.
      </p>

      <div id="jigsawCheckboxes" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:15px;">
        <!-- Filled by JS -->
      </div>

      <div style="margin-top:15px;padding:12px;background:rgba(0,212,255,0.08);border-radius:10px;border-left:4px solid #00d4ff;">
        <p style="margin:0;font-size:13px;color:#ccecff;line-height:1.5;">
          <strong>üìù Pro Tip:</strong> Take notes on each system's #1 safety risk, critical lab, and do-not-mix rule. 
          You'll use this knowledge in the Lightning Round!
        </p>
      </div>
    </section>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBfJ4KBqpbP4tbtikAgMEdbT5P1rb3yhHo",
      authDomain: "ati-pharm-blitz.firebaseapp.com",
      databaseURL: "https://ati-pharm-blitz-default-rtdb.firebaseio.com",
      projectId: "ati-pharm-blitz",
      storageBucket: "ati-pharm-blitz.firebasestorage.app",
      messagingSenderId: "236104923394",
      appId: "1:236104923394:web:201f51f9ba162438b2aa1b"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Map group number -> system name + instructions
    const groupConfig = {
      1: {
        name: 'Neurological',
        label: 'Group 1 ‚Äì Neurological Experts',
        instructions: [
          'Focus on seizure meds, antiepileptics, and CNS depressants.',
          'Identify the biggest safety risk (airway, LOC, respiratory depression, etc.).',
          'Pick at least one high-yield drug (e.g., Phenytoin, Levetiracetam).',
          'Create two scenarios where neuro meds could rapidly become unsafe.',
          'Be ready to teach your Top 3 priorities to a mixed group.'
        ]
      },
      2: {
        name: 'Psychopharmacology',
        label: 'Group 2 ‚Äì Psychopharm Experts',
        instructions: [
          'Focus on antidepressants, antipsychotics, mood stabilizers, and anxiolytics.',
          'Think about suicide risk, serotonin syndrome, NMS, EPS, and sedation.',
          'Choose high-yield meds (e.g., Lithium, SSRIs, Clozapine).',
          'Create scenarios that force the group to choose the safest FIRST action.',
          'Prepare to explain why your rules prevent harm to the patient.'
        ]
      },
      3: {
        name: 'Pain Management',
        label: 'Group 3 ‚Äì Pain Management Experts',
        instructions: [
          'Focus on opioids, non-opioids, and adjunct pain meds.',
          'Zero in on respiratory depression, oversedation, and uncontrolled pain.',
          'Include at least one opioid and one non-opioid (e.g., Morphine + Ketorolac).',
          'Build scenarios where the wrong choice could tank breathing or perfusion.',
          'Be ready to explain how to safely combine or stagger pain meds.'
        ]
      },
      4: {
        name: 'Inflammation',
        label: 'Group 4 ‚Äì Inflammation / NSAID Experts',
        instructions: [
          'Focus on NSAIDs, steroids, and anti-inflammatory meds.',
          'Key risks: GI bleed, renal injury, immunosuppression.',
          'Pick common meds (e.g., Ibuprofen, Ketorolac, Prednisone).',
          'Create at least one scenario involving a patient on anticoagulants or with ulcers.',
          'Highlight labs and assessments that would make you HOLD the drug.'
        ]
      },
      5: {
        name: 'Endocrine',
        label: 'Group 5 ‚Äì Endocrine Experts',
        instructions: [
          'Focus on insulin, oral hypoglycemics, thyroid meds, and steroids.',
          'Watch for hypoglycemia, DKA/HHS, and thyroid storm/myxedema coma.',
          'Include at least one insulin and one oral agent or thyroid med.',
          'Create scenarios where timing of meds and meals matters.',
          'Be ready to explain which lab change is most deadly, the fastest.'
        ]
      },
      6: {
        name: 'Infection',
        label: 'Group 6 ‚Äì Infection / Antibiotic Experts',
        instructions: [
          'Focus on antibiotics, antivirals, and antifungals.',
          'Key risks: anaphylaxis, nephrotoxicity, C. diff, resistance.',
          'Choose high-yield meds (e.g., Vancomycin, Piperacillin-tazobactam).',
          'Write scenarios where cultures, trough levels, or allergies matter.',
          'Be ready to explain when you would STOP an antibiotic immediately.'
        ]
      }
    };

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    function initGroupView() {
      let groupNum = parseInt(getQueryParam('group'), 10);
      if (isNaN(groupNum) || groupNum < 1 || groupNum > 6) {
        groupNum = 1; // default to Group 1 if invalid
      }

      const config = groupConfig[groupNum];

      // Update header
      const systemLabel = document.getElementById('systemLabel');
      const groupLabel = document.getElementById('groupLabel');
      const systemNameInline = document.getElementById('systemNameInline');
      const huddleTitle = document.getElementById('huddleTitle');

      if (systemLabel) systemLabel.textContent = `System Focus: ${config.name}`;
      if (groupLabel) groupLabel.textContent = config.label;
      if (systemNameInline) systemNameInline.textContent = config.name;
      if (huddleTitle) huddleTitle.textContent = `${config.name} ‚Äì Top 3 Priorities`;

      // Instructions list
      const list = document.getElementById('instructionList');
      if (list) {
        list.innerHTML = '';
        config.instructions.forEach(text => {
          const li = document.createElement('li');
          li.textContent = text;
          list.appendChild(li);
        });
      }
    }

    document.addEventListener('DOMContentLoaded', initGroupView);

    // Auto-save to Firebase
    function setupFirebaseSync(groupNum) {
      const fields = ['safetyRisk', 'priorityLab', 'doNotMix', 'highYieldMed', 'scenarioPrompts', 'rationale'];
      const groupRef = database.ref('groups/' + groupNum);

      // Load existing data
      groupRef.once('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          fields.forEach(field => {
            const el = document.getElementById(field);
            if (el && data[field]) {
              el.value = data[field];
            }
          });
        }
      });

      // Save on input
      fields.forEach(fieldId => {
        const el = document.getElementById(fieldId);
        if (el) {
          el.addEventListener('input', () => {
            const updates = {};
            fields.forEach(field => {
              const input = document.getElementById(field);
              updates[field] = input ? input.value : '';
            });
            updates.systemName = groupConfig[groupNum].name;
            updates.timestamp = Date.now();
            groupRef.set(updates);
          });
        }
      });
    }

    function initGroupView() {
      let groupNum = parseInt(getQueryParam('group'), 10);
      if (isNaN(groupNum) || groupNum < 1 || groupNum > 6) {
        groupNum = 1; // default to Group 1 if invalid
      }

      const config = groupConfig[groupNum];

      // Update header
      const systemLabel = document.getElementById('systemLabel');
      const groupLabel = document.getElementById('groupLabel');
      const systemNameInline = document.getElementById('systemNameInline');
      const huddleTitle = document.getElementById('huddleTitle');

      if (systemLabel) systemLabel.textContent = `System Focus: ${config.name}`;
      if (groupLabel) groupLabel.textContent = config.label;
      if (systemNameInline) systemNameInline.textContent = config.name;
      if (huddleTitle) huddleTitle.textContent = `${config.name} ‚Äì Top 3 Priorities`;

      // Instructions list
      const list = document.getElementById('instructionList');
      if (list) {
        list.innerHTML = '';
        config.instructions.forEach(text => {
          const li = document.createElement('li');
          li.textContent = text;
          list.appendChild(li);
        });
      }

      // Setup Firebase sync
      setupFirebaseSync(groupNum);
    }

    document.addEventListener('DOMContentLoaded', initGroupView);

    // -----------------------------
    // GROUP ID HANDLING
    // -----------------------------

    let currentGroupId = null;

    function saveGroupId() {
      const input = document.getElementById('groupIdInput');
      const status = document.getElementById('groupIdStatus');
      const value = parseInt(input.value, 10);

      if (!value || value < 1 || value > 6) {
        status.style.color = '#ff99c2';
        status.textContent = 'Enter a valid Group # between 1 and 6.';
        return;
      }

      currentGroupId = value;
      status.style.color = '#00ffb3';
      status.textContent = 'Group set to #' + currentGroupId;

      // store locally so they don't retype
      try {
        localStorage.setItem('pharmBlitzGroupId', String(currentGroupId));
      } catch (e) {}

      // initialize stability in Firebase if not present
      const groupRef = database.ref('groups/' + currentGroupId);
      groupRef.child('stability').once('value').then(snap => {
        if (snap.val() == null) {
          groupRef.update({ stability: 100 });
        }
      });
    }

    const saveGroupBtn = document.getElementById('saveGroupIdBtn');
    if (saveGroupBtn) {
      saveGroupBtn.addEventListener('click', saveGroupId);
    }

    // Load saved groupId on page load
    (function loadSavedGroupId() {
      try {
        const saved = localStorage.getItem('pharmBlitzGroupId');
        if (saved) {
          currentGroupId = parseInt(saved, 10);
          const input = document.getElementById('groupIdInput');
          const status = document.getElementById('groupIdStatus');
          if (input) input.value = currentGroupId;
          if (status) {
            status.style.color = '#00ffb3';
            status.textContent = 'Group set to #' + currentGroupId;
          }
        }
      } catch (e) {}
    })();

    // -----------------------------
    // DECISION ENGINE + STABILITY
    // -----------------------------

    /**
     * recordDecision({
     *   phase: 'flashcard' | 'jigsaw' | 'lightning' | ...,
     *   itemId: 'card1' or 'scenarioA',
     *   isCorrect: true/false,
     *   severity: 'minor' | 'moderate' | 'critical',
     *   explanation: 'text shown to instructor'
     * })
     */
    function recordDecision(config) {
      if (!currentGroupId) {
        const status = document.getElementById('fgStatus') || document.getElementById('groupIdStatus');
        if (status) {
          status.style.color = '#ff99c2';
          status.textContent = 'Set your Group # first.';
        }
        return;
      }

      const { phase, itemId, isCorrect, severity, explanation } = config;
      const groupRef = database.ref('groups/' + currentGroupId);
      const eventsRef = database.ref('events');

      // Stability deltas
      let delta = 0;
      if (!isCorrect) {
        if (severity === 'critical') delta = -25;
        else if (severity === 'moderate') delta = -15;
        else delta = -5;
      } else {
        // small positive bump for correct decisions if you want
        delta = +2;
      }

      // Update stability atomically
      groupRef.child('stability').transaction(current => {
        if (typeof current !== 'number') current = 100;
        let next = current + delta;
        if (next > 100) next = 100;
        if (next < 0) next = 0;
        return next;
      });

      // Log event (for instructor alerts/consequence mapping)
      const payload = {
        groupId: currentGroupId,
        phase: phase,
        itemId: itemId,
        isCorrect: !!isCorrect,
        severity: severity,
        explanation: explanation,
        delta: delta,
        timestamp: Date.now()
      };

      eventsRef.push(payload);
    }

    // -----------------------------
    // FLASHCARD GUESS ‚Äì AUTO CHECK
    // -----------------------------

    // Map each card to the correct system
    const flashcardKey = {
      card1: 'Psychopharmacology',  // Haloperidol/Fluoxetine - EPS, serotonin syndrome
      card2: 'Neurological',        // Levodopa/Phenobarbital - on-off phenomenon
      card3: 'Pain',                // Fentanyl/Butorphanol - respiratory depression
      card4: 'Endocrine',           // PTU/Somatropin - agranulocytosis
      card5: 'Infection',           // Erythromycin/Rifampin/Amphotericin B - drug interactions
      card6: 'Inflammation'         // Belimumab/Allopurinol/Hydrocortisone - live vaccines
    };

    function submitFlashcardGuess() {
      const cardInput = document.getElementById('fgCard');
      const systemInput = document.getElementById('fgSystem');
      const statusEl = document.getElementById('fgStatus');

      statusEl.textContent = '';

      if (!currentGroupId) {
        statusEl.style.color = '#ff99c2';
        statusEl.textContent = 'Set your Group # first.';
        return;
      }

      const cardId = cardInput.value;
      const systemGuess = systemInput.value;

      if (!cardId) {
        statusEl.style.color = '#ff99c2';
        statusEl.textContent = 'Choose which card you are answering for.';
        return;
      }
      if (!systemGuess) {
        statusEl.style.color = '#ff99c2';
        statusEl.textContent = 'Select your system guess.';
        return;
      }

      const correctSystem = flashcardKey[cardId];
      const isCorrect = (systemGuess === correctSystem);

      if (isCorrect) {
        statusEl.style.color = '#00ffb3';
        statusEl.textContent = '‚úì Correct ‚Äì nice call. Card will now flip on the instructor view!';
        
        // Mark card as flipped in Firebase so instructor view auto-flips it
        database.ref('flashcards/' + cardId).set({
          groupId: currentGroupId,
          flipped: true,
          timestamp: Date.now()
        });
        
        recordDecision({
          phase: 'flashcard',
          itemId: cardId,
          isCorrect: true,
          severity: 'minor',
          explanation: `Correctly identified ${cardId} as ${correctSystem}.`
        });
      } else {
        statusEl.style.color = '#ffb300';
        statusEl.textContent = `Not quite ‚Äì you picked ${systemGuess}, but you'll see how that choice affects your patient later.`;
        recordDecision({
          phase: 'flashcard',
          itemId: cardId,
          isCorrect: false,
          severity: 'moderate',
          explanation: `Misclassified ${cardId}: guessed ${systemGuess}, correct was ${correctSystem}.`
        });
      }

      // Reset form after brief delay
      setTimeout(() => {
        cardInput.value = '';
        systemInput.value = '';
      }, 2000);
    }

    const fgBtn = document.getElementById('fgSubmit');
    if (fgBtn) {
      fgBtn.addEventListener('click', submitFlashcardGuess);
    }

    // -----------------------------
    // JIGSAW LEARNING CHECKBOXES
    // -----------------------------

    const systemNames = {
      1: 'Neurological üß†',
      2: 'Psychopharmacology üíä',
      3: 'Pain Management üò£',
      4: 'Inflammation üî•',
      5: 'Endocrine ü©∫',
      6: 'Infection ü¶†'
    };

    function setupJigsawCheckboxes() {
      const container = document.getElementById('jigsawCheckboxes');
      if (!container || !currentGroupId) return;

      const jigsawRef = database.ref('jigsaw/group' + currentGroupId);

      // Load existing progress
      jigsawRef.once('value', (snapshot) => {
        const data = snapshot.val() || {};

        for (let sysNum = 1; sysNum <= 6; sysNum++) {
          const systemKey = 'system' + sysNum;
          const isCompleted = data[systemKey] === true;

          const box = document.createElement('div');
          box.style.cssText = 'background:rgba(255,255,255,0.05);border-radius:10px;padding:12px;border:1px solid rgba(0,212,255,0.3);display:flex;align-items:center;gap:10px;cursor:pointer;transition:all 0.2s ease;';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = 'jigsaw-sys-' + sysNum;
          checkbox.checked = isCompleted;
          checkbox.style.cssText = 'width:18px;height:18px;cursor:pointer;';

          const label = document.createElement('label');
          label.htmlFor = 'jigsaw-sys-' + sysNum;
          label.textContent = systemNames[sysNum];
          label.style.cssText = 'flex:1;cursor:pointer;font-size:14px;color:#ccecff;';

          box.appendChild(checkbox);
          box.appendChild(label);
          container.appendChild(box);

          // Save to Firebase when checked/unchecked
          checkbox.addEventListener('change', () => {
            jigsawRef.update({
              [systemKey]: checkbox.checked
            });

            // Optional: log a decision event
            if (checkbox.checked) {
              recordDecision({
                phase: 'jigsaw',
                itemId: systemKey,
                isCorrect: true,
                severity: 'minor',
                explanation: `Group ${currentGroupId} completed learning ${systemNames[sysNum]}`
              });
            }
          });

          // Visual feedback on hover
          box.addEventListener('mouseenter', () => {
            box.style.background = 'rgba(0,212,255,0.1)';
          });
          box.addEventListener('mouseleave', () => {
            box.style.background = 'rgba(255,255,255,0.05)';
          });
        }
      });

      // Listen for changes from instructor or other devices
      jigsawRef.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        for (let sysNum = 1; sysNum <= 6; sysNum++) {
          const checkbox = document.getElementById('jigsaw-sys-' + sysNum);
          if (checkbox) {
            checkbox.checked = data['system' + sysNum] === true;
          }
        }
      });
    }

    // Initialize jigsaw when group ID is set
    const saveGroupBtn = document.getElementById('saveGroupIdBtn');
    if (saveGroupBtn) {
      saveGroupBtn.addEventListener('click', () => {
        setTimeout(() => {
          if (currentGroupId) {
            setupJigsawCheckboxes();
          }
        }, 500);
      });
    }

    // Also initialize on page load if group ID already exists
    if (currentGroupId) {
      setupJigsawCheckboxes();
    }
  </script>
</body>
</html>
