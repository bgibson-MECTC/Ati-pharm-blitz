<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ATI Pharm Blitz ‚Äì Group View</title>

  <style>
    /* ===== DEBUG BANNER ===== */
    #debugBanner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 20px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      z-index: 10000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      border-bottom: 2px solid #5568d3;
    }
    #debugBanner .status-ok { color: #4ade80; font-weight: bold; }
    #debugBanner .status-error { color: #f87171; font-weight: bold; }
    #debugBanner .status-warn { color: #fbbf24; font-weight: bold; }
    #debugBanner small { opacity: 0.8; margin-left: 10px; }
    
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a1128 0%, #1e3a5f 100%);
      color: #ffffff;
      overflow-x: hidden;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    .main-wrapper {
      width: 100%;
      min-height: 100vh;
      overflow-y: auto;
      padding: 40px 20px;
      max-width: 1100px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    .main-title {
      font-size: 36px;
      font-weight: 900;
      background: linear-gradient(90deg, #00d4ff, #00ffb3, #00d4ff);
      background-size: 200% auto;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 3s linear infinite;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 16px;
      color: #00ffb3;
      font-weight: 400;
      margin-bottom: 4px;
    }

    .group-label {
      font-size: 14px;
      color: #ccecff;
    }

      /* ===== PHASE BANNER ===== */
      .phase-banner {
        background: linear-gradient(90deg, #00d4ff 0%, #00ffb3 100%);
        color: #0a1128;
        padding: 15px 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        font-weight: 700;
        text-align: center;
        font-size: 16px;
      }
    
      .phase-banner.phase1 { background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); color: white; }
      .phase-banner.phase2 { background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%); color: white; }
      .phase-banner.phase3 { background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); color: #0a1128; }
    
      .phase-subtitle {
        font-size: 12px;
        opacity: 0.85;
        margin-top: 4px;
      }

      /* ===== STABILITY BAR (STUDENT VIEW) ===== */
      .stability-container {
        background: rgba(0,212,255,0.1);
        border: 2px solid #00d4ff;
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 20px;
      }
    
      .stability-label {
        font-size: 12px;
        color: #00d4ff;
        font-weight: 600;
        margin-bottom: 6px;
      }
    
      .stability-bar {
        height: 30px;
        background: rgba(0,0,0,0.3);
        border-radius: 15px;
        overflow: hidden;
        position: relative;
        border: 1px solid rgba(0,212,255,0.4);
      }
    
      .stability-fill {
        height: 100%;
        background: linear-gradient(90deg, #00ffb3, #00d4ff);
        width: 100%;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
        color: #0a1128;
      }
    
      .stability-fill.critical { background: linear-gradient(90deg, #ff006e, #cc0058); color: white; }
      .stability-fill.warning { background: linear-gradient(90deg, #ffb300, #ff8c00); color: #0a1128; }

      /* ===== FEEDBACK TOAST ===== */
      .feedback-toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 10px;
        font-weight: 600;
        z-index: 9000;
        animation: slideUp 0.4s ease-out;
        max-width: 300px;
      }
    
      @keyframes slideUp {
        from { transform: translateY(100px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    
      .feedback-toast.success { background: #00ffb3; color: #0a1128; }
      .feedback-toast.error { background: #ff006e; color: white; }
      .feedback-toast.warning { background: #ffb300; color: #0a1128; }
    @keyframes shimmer {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }

    @keyframes pulse-warning {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(255, 179, 0, 0.7); }
      50% { opacity: 0.85; box-shadow: 0 0 20px 10px rgba(255, 179, 0, 0); }
    }

    @keyframes pulse-critical {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(255, 0, 110, 0.9); }
      50% { opacity: 0.75; box-shadow: 0 0 30px 15px rgba(255, 0, 110, 0); }
    }

    @keyframes successPulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 179, 0.7); }
      50% { transform: scale(1.05); box-shadow: 0 0 20px 10px rgba(0, 255, 179, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 179, 0); }
    }

    @keyframes errorShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    @keyframes stabilityBounce {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-20px) scale(1.1); }
    }

    @keyframes celebration {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
      100% { transform: scale(1) rotate(360deg); opacity: 1; }
    }

    .success-flash {
      animation: successPulse 0.6s ease-out;
    }

    .error-flash {
      animation: errorShake 0.5s ease-out;
      border-color: #ff006e !important;
    }

    .stability-boost {
      animation: stabilityBounce 0.8s ease-out;
    }

    .celebration-icon {
      animation: celebration 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .stability-warning {
      animation: pulse-warning 2s ease-in-out infinite;
    }

    .stability-critical {
      animation: pulse-critical 1.5s ease-in-out infinite;
    }

    .section {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      border: 2px solid rgba(0, 212, 255, 0.3);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
      padding-bottom: 10px;
      border-bottom: 2px solid #00d4ff;
    }

    .section-icon {
      font-size: 28px;
    }

    .section-title {
      font-size: 22px;
      font-weight: 700;
      color: #00ffb3;
      margin: 0;
    }

    .huddle-box {
      background: rgba(0, 212, 255, 0.1);
      border: 2px solid #00d4ff;
      border-radius: 15px;
      padding: 20px;
      margin-top: 10px;
    }

    .huddle-box h3 {
      color: #00ffb3;
      font-size: 20px;
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
    }

    .huddle-field {
      margin-bottom: 15px;
    }

    .huddle-field label {
      display: block;
      color: #00d4ff;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .huddle-field input,
    .huddle-field textarea {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 8px;
      padding: 9px;
      color: #ffffff;
      font-size: 14px;
      font-family: inherit;
    }

    .huddle-field textarea {
      min-height: 70px;
      resize: vertical;
    }

    .huddle-field input:focus,
    .huddle-field textarea:focus {
      outline: none;
      border-color: #00ffb3;
      background: rgba(255, 255, 255, 0.15);
    }

    .instructions-list {
      color: #ccecff;
      font-size: 14px;
      padding-left: 18px;
    }

    .instructions-list li {
      margin-bottom: 6px;
    }

    .back-link {
      display: inline-block;
      margin-top: 10px;
      font-size: 13px;
      color: #00ffb3;
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,212,255,0.5);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #ccecff;
      margin-left: 6px;
    }

    @media (max-width: 768px) {
      .main-title {
        font-size: 26px;
      }
      .section-title {
        font-size: 19px;
      }
    }

    /* Flashcard Guess */
    .flashguess-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 10px;
    }

    .fg-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #00d4ff;
      margin-bottom: 5px;
    }

    .fg-input {
      width: 100%;
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      border: 1px solid rgba(0,212,255,0.4);
      color: #ffffff;
      padding: 8px 10px;
      font-size: 14px;
      font-family: inherit;
    }

    .fg-input option {
      background: #1e3a5f;
      color: #ffffff;
    }

    .fg-input:focus {
      outline: none;
      border-color: #00ffb3;
      background: rgba(255,255,255,0.12);
    }

    @media (max-width: 600px) {
      .flashguess-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Flashcards */
    .flashcard-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .flashcard {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      border-radius: 15px;
      padding: 25px 18px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      min-height: 180px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .flashcard.locked {
      cursor: not-allowed;
      opacity: 0.7;
      background: linear-gradient(135deg, #555 0%, #333 100%);
    }

    .flashcard.locked::after {
      content: 'üîí';
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
    }

    .flashcard:not(.locked):hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.5);
    }

    .flashcard.flipped {
      background: linear-gradient(135deg, #00ffb3 0%, #00cc88 100%);
    }

    .flashcard-front {
      font-size: 14px;
      font-weight: 600;
      color: #ffffff;
      line-height: 1.4;
    }

    .flashcard-back {
      display: none;
      font-size: 13px;
      font-weight: 600;
      color: #0a1128;
      line-height: 1.5;
      text-align: left;
    }

    .flashcard.flipped .flashcard-front {
      display: none;
    }

    .flashcard.flipped .flashcard-back {
      display: block;
    }

    .card-number {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.5);
      color: #00ffb3;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Group Selection Landing */
    .group-selection-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
      padding: 40px 20px;
      text-align: center;
    }

    .group-selection-screen.hidden {
      display: none;
    }

    .selection-title {
      font-size: 42px;
      font-weight: 900;
      background: linear-gradient(90deg, #00d4ff, #00ffb3);
      background-size: 200% auto;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 15px;
    }

    .selection-subtitle {
      font-size: 18px;
      color: #b8e0ff;
      margin-bottom: 40px;
    }

    .group-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      max-width: 900px;
      width: 100%;
    }

    .group-option {
      background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(0,255,179,0.05));
      border: 2px solid rgba(0,212,255,0.3);
      border-radius: 16px;
      padding: 30px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .group-option:hover {
      transform: translateY(-8px);
      border-color: #00d4ff;
      box-shadow: 0 15px 35px rgba(0,212,255,0.3);
      background: linear-gradient(135deg, rgba(0,212,255,0.15), rgba(0,255,179,0.1));
    }

    .group-number {
      font-size: 48px;
      font-weight: 900;
      color: #00d4ff;
      margin-bottom: 10px;
    }

    .group-system {
      font-size: 18px;
      font-weight: 600;
      color: #00ffb3;
      margin-bottom: 8px;
    }

    .group-icon {
      font-size: 36px;
      margin-bottom: 5px;
    }

    .group-activity-content {
      display: none;
    }

    .group-activity-content.active {
      display: block;
    }

    /* Role Selection Screen */
    .role-selection-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
      padding: 40px 20px;
      text-align: center;
    }

    .role-selection-screen.active {
      display: flex;
    }

    .role-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      max-width: 800px;
      width: 100%;
    }

    .role-option {
      background: linear-gradient(135deg, rgba(255,179,0,0.1), rgba(255,107,0,0.05));
      border: 2px solid rgba(255,179,0,0.3);
      border-radius: 16px;
      padding: 30px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .role-option:hover {
      transform: translateY(-8px);
      border-color: #ffb300;
      box-shadow: 0 15px 35px rgba(255,179,0,0.3);
      background: linear-gradient(135deg, rgba(255,179,0,0.15), rgba(255,107,0,0.1));
    }

    .role-option.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }

    .role-name {
      font-size: 22px;
      font-weight: 700;
      color: #ffb300;
      margin-bottom: 8px;
    }

    .role-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(0,212,255,0.2);
      color: #00d4ff;
      margin-top: 10px;
    }

    .role-description {
      font-size: 13px;
      color: #b8e0ff;
      line-height: 1.5;
      margin-top: 8px;
    }

    /* Mobile-first adjustments */
    @media (max-width: 640px) {
      .assign-btn,
      .back-link {
        width: 100%;
        text-align: center;
      }
      .flashguess-grid,
      .huddle-box,
      .role-selection,
      .group-grid {
        grid-template-columns: 1fr !important;
      }
      .section {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <!-- DEBUG BANNER -->
  <div id="debugBanner">
    <span class="status-warn">‚è≥ Loading...</span>
    <small>Script initializing</small>
  </div>
  
  <!-- PASSCODE MODAL -->
  <div id="passcodeModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:12000;align-items:center;justify-content:center;">
    <div style="background:#0a1128;border:2px solid #00d4ff;border-radius:16px;padding:24px;max-width:360px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,0.4);">
      <h3 style="color:#00d4ff;margin-top:0;margin-bottom:8px;">Leadership Access</h3>
      <p id="passcodeRoleLabel" style="color:#ccecff;font-size:14px;margin:0 0 12px 0;">Enter passcode to continue.</p>
      <input type="password" id="passcodeInput" placeholder="Enter passcode" style="width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(0,212,255,0.3);border-radius:8px;padding:10px;color:#fff;font-size:15px;" />
      <p id="passcodeError" style="color:#ff99c2;font-size:12px;margin:8px 0 0 0;display:none;">Incorrect passcode</p>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
        <button id="passcodeCancel" class="assign-btn" style="background:rgba(255,255,255,0.1);">Cancel</button>
        <button id="passcodeConfirm" class="assign-btn" style="background:#00d4ff;">Unlock</button>
      </div>
    </div>
  </div>

  <!-- ERROR SCREEN -->
  <div id="groupErrorScreen" style="display:none;padding:30px;text-align:center;color:#fff;">
    <h2 style="margin-bottom:10px;color:#ff99c2;">Missing group link</h2>
    <p style="color:#ccecff;font-size:15px;">Use the link your instructor provided (must include ?group=1‚Äì6).</p>
    <a href="select.html" style="display:inline-block;margin-top:20px;padding:12px 24px;background:#00d4ff;color:#0a1128;text-decoration:none;border-radius:8px;font-weight:600;">‚Üê Back to Role Selection</a>
  </div>
  
  <script>
    // ==========================================
    // PHASE 1: ROUTING & AUTHORIZATION (mednurse2024)
    // ==========================================
    
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // Hardcoded passcode for leadership roles
    const LEADERSHIP_PASSCODE = 'mednurse2024';
    let authRole = null;  // Will be 'student', 'charge', or 'rrt' after auth
    
    function showPasscodeModal(roleLabel) {
      return new Promise((resolve) => {
        const modal = document.getElementById('passcodeModal');
        const input = document.getElementById('passcodeInput');
        const error = document.getElementById('passcodeError');
        const roleText = document.getElementById('passcodeRoleLabel');
        roleText.textContent = `Enter passcode to access ${roleLabel.toUpperCase()} controls.`;
        error.style.display = 'none';
        input.value = '';
        modal.style.display = 'flex';
        input.focus();

        function cleanup() {
          document.getElementById('passcodeConfirm').removeEventListener('click', onConfirm);
          document.getElementById('passcodeCancel').removeEventListener('click', onCancel);
          input.removeEventListener('keyup', onKey);
        }
        function close(result) {
          modal.style.display = 'none';
          cleanup();
          resolve(result);
        }
        function onConfirm() {
          if (input.value === LEADERSHIP_PASSCODE) {
            close(true);
          } else {
            error.style.display = 'block';
          }
        }
        function onCancel() { close(false); }
        function onKey(e) { if (e.key === 'Enter') onConfirm(); if (e.key === 'Escape') onCancel(); }

        document.getElementById('passcodeConfirm').addEventListener('click', onConfirm);
        document.getElementById('passcodeCancel').addEventListener('click', onCancel);
        input.addEventListener('keyup', onKey);
      });
    }

    function initializeRole() {
      const roleParam = getQueryParam('role') || 'student';
      if (roleParam === 'charge1' || roleParam === 'charge2' || roleParam === 'rrt') {
        authRole = roleParam;
      } else {
        authRole = 'student';
      }
    }

    // Initialize role BEFORE Firebase (no modal here; bootstrap handles prompts)
    initializeRole();
    const banner = document.getElementById('debugBanner');
    if (banner) {
      banner.innerHTML = `<span class="status-warn">‚è≥ ${authRole.toUpperCase()} MODE | Waiting for Firebase...</span>`;
    }
  </script>
  
  <!-- GROUP SELECTION LANDING -->
  <div class="group-selection-screen" id="groupSelectionScreen">
    <h1 class="selection-title">Select Your Role</h1>
    <p class="selection-subtitle">Choose to join a student group or take a leadership role</p>
    
    <!-- Continue Prompt (shown when returning user) -->
    <!-- Continue prompt removed - roles lock on first selection -->
    
    <!-- Leadership Roles Section -->
    <div style="margin-bottom: 40px;" id="roleSelectionOptions">
      <h3 style="color: #ffb300; font-size: 20px; margin-bottom: 20px;">üéØ Leadership Roles</h3>
      <div class="role-grid">
        <div class="role-option" onclick="selectLeadership('charge1')" id="charge1Option">
          <div class="role-icon" style="font-size: 48px;">üë®‚Äç‚öïÔ∏è</div>
          <div class="role-name">Charge Nurse 1</div>
          <div class="role-badge">Oversee All Groups</div>
          <div class="role-description">Monitor all 6 groups, approve answers, trigger RRT</div>
        </div>
        
        <div class="role-option" onclick="selectLeadership('charge2')" id="charge2Option">
          <div class="role-icon" style="font-size: 48px;">üë©‚Äç‚öïÔ∏è</div>
          <div class="role-name">Charge Nurse 2</div>
          <div class="role-badge">Oversee All Groups</div>
          <div class="role-description">Monitor all 6 groups, approve answers, trigger RRT</div>
        </div>
        
        <div class="role-option" onclick="selectLeadership('rrt')" id="rrtOption">
          <div class="role-icon" style="font-size: 48px;">üö®</div>
          <div class="role-name">Rapid Response RN</div>
          <div class="role-badge">Emergency Response</div>
          <div class="role-description">Rescue crashing groups and stabilize patients</div>
        </div>
      </div>
    </div>

        </div>
        <div>
          <label class="fg-label">FIRST Action (required before reveal)</label>
          <select id="fgAction" class="fg-input">
            <option value="">Select first action‚Ä¶</option>
          </select>
    <!-- Student Groups Section -->
    <div>
      <h3 style="color: #00d4ff; font-size: 20px; margin-bottom: 20px;">üìö Student Groups</h3>
      <div class="group-grid">
        <div class="group-option" onclick="selectGroup(1)">
          <div class="group-icon">üß†</div>
          <div class="group-number">1</div>
          <div class="group-system">Neurological</div>
        </div>
        
        <div class="group-option" onclick="selectGroup(2)">
          <div class="group-icon">üíä</div>
          <div class="group-number">2</div>
          <div class="group-system">Psychopharmacology</div>
        </div>
        
        <div class="group-option" onclick="selectGroup(3)">
          <div class="group-icon">üò£</div>
          <div class="group-number">3</div>
          <div class="group-system">Pain Management</div>
        </div>
        
        <div class="group-option" onclick="selectGroup(4)">
          <div class="group-icon">üî•</div>
          <div class="group-number">4</div>
          <div class="group-system">Inflammation</div>
        </div>
        
        <div class="group-option" onclick="selectGroup(5)">
          <div class="group-icon">ü©∫</div>
          <div class="group-number">5</div>
          <div class="group-system">Endocrine</div>
        </div>
        
        <div class="group-option" onclick="selectGroup(6)">
          <div class="group-icon">ü¶†</div>
          <div class="group-number">6</div>
          <div class="group-system">Infection</div>
        </div>
      </div>
    </div>
    </div>  <!-- Close roleSelectionOptions -->
  </div>

  <!-- LEADERSHIP DASHBOARD (Charge/RRT) -->
  <div class="main-wrapper group-activity-content" id="leadershipDashboard" style="display:none;">
    <header>
      <h1 class="main-title">Leadership Command Center</h1>
      <p class="subtitle" id="leadershipRoleLabel">Role: ‚Ä¶</p>
      <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px;">
        <button onclick="returnToHome()" class="back-link" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 8px; cursor: pointer; color: #fff; font-size: 14px; text-decoration: none; display: inline-block;">üè† Home Screen</button>
        <button onclick="resetGame()" class="back-link" style="background: rgba(255,69,0,0.2); border: 1px solid rgba(255,69,0,0.5); padding: 10px 20px; border-radius: 8px; cursor: pointer; color: #ff6b6b; font-size: 14px; font-weight: 600;">üîÑ Reset Game</button>
      </div>
    </header>

    <!-- Group Messages Panel -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üì®</span>
        <h2 class="section-title">Messages & Conversations</h2>
      </div>
      
      <div style="background:rgba(255,140,0,0.1);border:2px solid rgba(255,140,0,0.4);border-radius:10px;padding:15px;margin-bottom:15px;">
        <h4 style="color:#ffb300;margin:0 0 10px 0;font-size:14px;">‚≠ê YOUR ROLE: Clinical Judgment Gatekeeper</h4>
        <div style="font-size:12px;color:#ccecff;line-height:1.6;">
          <strong>üî• NEVER give direct answers.</strong> Guide with questions:<br>
          ‚Ä¢ "What kills the patient FIRST?"<br>
          ‚Ä¢ "What medication triggered this?"<br>
          ‚Ä¢ "What's your FIRST nursing action ‚Äî no fluff?"<br>
          ‚Ä¢ "Which vital sign trend supports your suspicion?"<br>
          ‚Ä¢ "What lab would you expect to see?"<br>
          <br>
          <strong>‚úÖ Approval Criteria:</strong> Condition + First Action + Monitoring<br>
          <strong>‚ö†Ô∏è Escalate if:</strong> Missing components, unsafe assumptions, contradictory reasoning<br>
          <strong>üö® Call RRT if:</strong> Dangerous judgment, repeated errors, unstable vitals ignored
        </div>
      </div>
      
      <div id="chargeNurseMessages" style="max-height:600px;overflow-y:auto;background:rgba(0,0,0,0.3);border-radius:10px;padding:15px;">
        <div style="color:#888;text-align:center;padding:20px;">No messages yet</div>
      </div>
    </section>

    <!-- All Groups Stability Monitor -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üìä</span>
        <h2 class="section-title">All Groups ‚Äì Patient Stability</h2>
      </div>
      <div id="allGroupsStability" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;">
        <!-- Populated by JS -->
      </div>
    </section>

    <!-- Auto Alerts -->
    <section class="section" id="autoAlertsSection">
      <div class="section-header">
        <span class="section-icon">üö©</span>
        <h2 class="section-title">Auto Alerts</h2>
      </div>
      <div id="autoAlertsList" style="display:grid;gap:8px;" data-empty="true">
        <div style="color:#888;font-size:13px;">No alerts yet</div>
      </div>
    </section>

    <!-- Phase Controls (Charge/RRT) -->
    <section class="section" id="phaseControlSection">
      <div class="section-header">
        <span class="section-icon">‚è©</span>
        <h2 class="section-title">Phase Controls</h2>
      </div>
      <p style="color:#ccecff;font-size:14px;margin-bottom:10px;">Advance a group through phases. Phase 1 ‚Üí Flashcards; Phase 2 ‚Üí Expert Huddle unlocks; Phase 3 ‚Üí Jigsaw unlocks.</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <label for="phaseGroupSelect" style="color:#ccecff;font-size:14px;">Group #</label>
        <select id="phaseGroupSelect" class="fg-input" style="min-width:120px;">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
        <button class="assign-btn" style="background:#f093fb;" onclick="setGroupPhase('phase2')">Advance to Phase 2</button>
        <button class="assign-btn" style="background:#4facfe;" onclick="setGroupPhase('phase3')">Advance to Phase 3</button>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;">
        <button class="assign-btn" style="background:#00ffb3;" onclick="setAllGroupsPhase('phase1')">Start Phase 1 (All Groups)</button>
        <button class="assign-btn" style="background:#00d4ff;" onclick="setAllGroupsPhase('phase2')">Start Phase 2 (All Groups)</button>
        <button class="assign-btn" style="background:#ff9f43;" onclick="setAllGroupsPhase('phase3')">Start Phase 3 (All Groups)</button>
      </div>
      <p id="phaseControlStatus" style="color:#ccecff;font-size:12px;margin-top:8px;"></p>
    </section>

    <!-- Flashcard & Jigsaw Errors -->
    <section class="section" id="errorLogSection">
      <div class="section-header">
        <span class="section-icon">‚ö†Ô∏è</span>
        <h2 class="section-title">Error Log ‚Äì All Groups</h2>
      </div>
      <div id="allGroupsErrors" style="max-height:400px;overflow-y:auto;">
        <!-- Populated by JS -->
      </div>
    </section>

    <!-- Group Cases & Approval -->
    <section class="section" id="groupCasesSection">
      <div class="section-header">
        <span class="section-icon">üìã</span>
        <h2 class="section-title">Assigned Cases & Approval</h2>
      </div>
      <div id="groupCases">
        <!-- Populated by JS -->
      </div>
    </section>

    <!-- Debrief Board (Charge Nurses only) -->
    <section class="section" id="debriefBoard">
      <div class="section-header">
        <span class="section-icon">üìù</span>
        <h2 class="section-title">Debrief Board</h2>
      </div>
      <p style="color:#ccecff;font-size:14px;margin-bottom:15px;" id="debriefInstructions">
        Document key learnings and reflections for your assigned groups.
      </p>
      <div id="debriefGroups">
        <!-- Populated based on charge nurse role -->
      </div>
    </section>

    <!-- RRT Rescue Controls (Charge Nurse only) -->
    <section class="section" id="rrtControls">
      <div class="section-header">
        <span class="section-icon">üö®</span>
        <h2 class="section-title">Rapid Response Team Controls</h2>
      </div>
      <p style="color:#ccecff;font-size:14px;margin-bottom:15px;">
        Trigger an RRT call to rescue a crashing group. Complete the SBAR report for the RRT nurse.
      </p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;">
        <button class="assign-btn" onclick="openRRTReport(1)">üö® RRT to Group 1</button>
        <button class="assign-btn" onclick="openRRTReport(2)">üö® RRT to Group 2</button>
        <button class="assign-btn" onclick="openRRTReport(3)">üö® RRT to Group 3</button>
        <button class="assign-btn" onclick="openRRTReport(4)">üö® RRT to Group 4</button>
        <button class="assign-btn" onclick="openRRTReport(5)">üö® RRT to Group 5</button>
        <button class="assign-btn" onclick="openRRTReport(6)">üö® RRT to Group 6</button>
      </div>

      <!-- SBAR Report Modal -->
      <div id="sbarModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:600px;background:#0a1128;border-radius:20px;border:2px solid #00d4ff;padding:30px;max-height:90vh;overflow-y:auto;">
          <h2 style="color:#00d4ff;margin-top:0;">üö® RRT Call - SBAR Report</h2>
          <p style="color:#ccecff;font-size:14px;margin-bottom:20px;" id="sbarGroupInfo">Group: ‚Ä¶</p>

          <div style="margin-bottom:15px;">
            <label style="display:block;color:#00ffb3;font-weight:600;margin-bottom:5px;">Situation (What's happening?)</label>
            <textarea id="sbarSituation" rows="2" style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:8px;padding:10px;color:#fff;font-family:inherit;" placeholder="Patient status is declining, stability at..."></textarea>
          </div>

          <div style="margin-bottom:15px;">
            <label style="display:block;color:#00ffb3;font-weight:600;margin-bottom:5px;">Background (Relevant history)</label>
            <textarea id="sbarBackground" rows="2" style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:8px;padding:10px;color:#fff;font-family:inherit;" placeholder="Group made errors on..."></textarea>
          </div>

          <div style="margin-bottom:15px;">
            <label style="display:block;color:#00ffb3;font-weight:600;margin-bottom:5px;">Assessment (What do you think is wrong?)</label>
            <textarea id="sbarAssessment" rows="2" style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:8px;padding:10px;color:#fff;font-family:inherit;" placeholder="I believe the patient is..."></textarea>
          </div>

          <div style="margin-bottom:20px;">
            <label style="display:block;color:#00ffb3;font-weight:600;margin-bottom:5px;">Recommendation (What needs to happen?)</label>
            <textarea id="sbarRecommendation" rows="2" style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:8px;padding:10px;color:#fff;font-family:inherit;" placeholder="I recommend immediate intervention..."></textarea>
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="assign-btn" onclick="closeSBARModal()" style="background:rgba(255,255,255,0.1);">Cancel</button>
            <button class="assign-btn" onclick="submitRRTCall()" style="background:#ff006e;">üö® Send RRT Now</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RRT Active Calls (RRT role only) -->
    <section class="section" id="rrtCalls" style="display:none;">
      <div class="section-header">
        <span class="section-icon">üö®</span>
        <h2 class="section-title">Active RRT Calls</h2>
      </div>
      <div id="activeCalls">
        <p style="color:#ccecff;font-size:14px;">No active calls. Standby for charge nurse alerts.</p>
      </div>
    </section>

    <!-- RRT Intervention Selection -->
    <section class="section" id="rrtInterventions" style="display:none;">
      <div class="section-header">
        <span class="section-icon">üíâ</span>
        <h2 class="section-title">Available Interventions</h2>
      </div>
      <p style="color:#ccecff;font-size:14px;margin-bottom:15px;">Select the appropriate intervention based on the SBAR report above.</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;" id="interventionOptions">
        <!-- Populated when call is active -->
      </div>
    </section>
  </div>

  <!-- GROUP ACTIVITY CONTENT -->
  <div class="main-wrapper group-activity-content" id="groupActivityContent" style="display:none;">
    <header>
      <h1 class="main-title">ATI Pharm Blitz</h1>
      <p class="subtitle" id="systemLabel">Group System: ‚Ä¶</p>
      <p class="group-label" id="groupLabel">Group: ‚Ä¶</p>
      
        <!-- Patient Stability Bar -->
        <div class="stability-container">
          <label>Patient Stability</label>
          <div class="stability-bar">
            <div class="stability-fill" id="stabilityFill">100</div>
          </div>
        </div>
      
      <!-- Phase Timer Display -->
      <div id="phaseTimer" style="display:none;margin-top:20px;padding:15px;background:rgba(0,212,255,0.15);border:2px solid rgba(0,212,255,0.4);border-radius:15px;text-align:center;">
        <div style="font-size:14px;color:#00d4ff;font-weight:600;margin-bottom:5px;">CURRENT PHASE</div>
        <div id="phaseNameDisplay" style="font-size:20px;color:#00ffb3;font-weight:700;margin-bottom:8px;">Warm-Up</div>
        <div style="font-size:36px;font-weight:900;color:#ffffff;font-family:monospace;" id="timeRemaining">15:00</div>
        <div style="font-size:12px;color:#ccecff;margin-top:5px;">Time Remaining</div>
      </div>
      
      <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px;">
        <button onclick="returnToHome()" class="back-link" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 8px; cursor: pointer; color: #fff; font-size: 14px; text-decoration: none; display: inline-block;">üè† Home Screen</button>
      </div>
    </header>

    <!-- Instructions -->
    <section class="section" id="missionSection" style="display:none;">
      <div class="section-header">
        <span class="section-icon">üìã</span>
        <h2 class="section-title">Your Mission<span class="pill">Group View</span></h2>
      </div>
      <ul class="instructions-list" id="instructionList">
        <!-- Filled dynamically based on system -->
      </ul>
    </section>

    <!-- WARM-UP FLASHCARDS -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üî•</span>
        <h2 class="section-title">Warm-Up Flashcards</h2>
      </div>

      <p style="color:#ccecff;font-size:14px;margin-bottom:10px;">
        Click any card to flip it and see the answer. Cards are locked üîí until your group submits the correct system guess below.
      </p>

      <div class="flashcard-container">
        <!-- Card 1: Psychopharmacology -->
        <div class="flashcard locked" data-card-id="card1" data-system="psychopharmacology">
          <span class="card-number">Card 1</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on Haloperidol is showing muscle rigidity and tremors. What serious adverse effect requires immediate intervention? <em>(Psycho or Neuro?)</em>
          </div>
          <div class="flashcard-back">
            <em>Locked ‚Äì submit the correct system to reveal.</em>
          </div>
        </div>

        <!-- Card 2: Neurological -->
        <div class="flashcard locked" data-card-id="card2" data-system="neurological">
          <span class="card-number">Card 2</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on Levodopa/Carbidopa experiences sudden "on-off" phenomenon. What lab value is critical to monitor? <em>(Neuro or Endocrine?)</em>
          </div>
          <div class="flashcard-back">
            <em>Locked ‚Äì submit the correct system to reveal.</em>
          </div>
        </div>

        <!-- Card 3: Pain -->
        <div class="flashcard locked" data-card-id="card3" data-system="pain">
          <span class="card-number">Card 3</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A post-op patient on IV Fentanyl has a respiratory rate of 8. What is your FIRST action? <em>(Pain or Neuro?)</em>
          </div>
          <div class="flashcard-back">
            <em>Locked ‚Äì submit the correct system to reveal.</em>
          </div>
        </div>

        <!-- Card 4: Endocrine -->
        <div class="flashcard locked" data-card-id="card4" data-system="endocrine">
          <span class="card-number">Card 4</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on PTU (Propylthiouracil) develops a sore throat and fever. What life-threatening complication must you suspect? <em>(Endocrine or Infection?)</em>
          </div>
          <div class="flashcard-back">
            <em>Locked ‚Äì submit the correct system to reveal.</em>
          </div>
        </div>

        <!-- Card 5: Infection -->
        <div class="flashcard locked" data-card-id="card5" data-system="infection">
          <span class="card-number">Card 5</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on Erythromycin is also taking Warfarin. What dangerous interaction must you monitor? <em>(Infection or Inflammation?)</em>
          </div>
          <div class="flashcard-back">
            <em>Locked ‚Äì submit the correct system to reveal.</em>
          </div>
        </div>

        <!-- Card 6: Inflammation -->
        <div class="flashcard locked" data-card-id="card6" data-system="inflammation">
          <span class="card-number">Card 6</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on Belimumab (lupus treatment) is scheduled for a live vaccine. What is your nursing action? <em>(Inflammation or Infection?)</em>
          </div>
          <div class="flashcard-back">
            <em>Locked ‚Äì submit the correct system to reveal.</em>
          </div>
        </div>
      </div>
    </section>

    <!-- FLASHCARD GUESS SUBMISSION -->
    <section class="section" id="flashcardGuessSection">
      <div class="section-header">
        <span class="section-icon">üß†</span>
        <h2 class="section-title">Flashcard Guess ‚Äì Submit to Unlock</h2>
      </div>
      <p style="color:#ccecff;font-size:14px;margin-bottom:10px;">
        Submit your group's best guess for which system each card belongs to. When you get it right, the card unlocks and you can flip it!
      </p>

      <div class="flashguess-grid">
        <div>
          <label class="fg-label">Card ID</label>
          <select id="fgCard" class="fg-input">
            <option value="">Choose card‚Ä¶</option>
            <option value="card1">Card 1</option>
            <option value="card2">Card 2</option>
            <option value="card3">Card 3</option>
            <option value="card4">Card 4</option>
            <option value="card5">Card 5</option>
            <option value="card6">Card 6</option>
          </select>
        </div>
        <div>
          <label class="fg-label">System Guess</label>
          <select id="fgSystem" class="fg-input">
            <option value="">Select system‚Ä¶</option>
            <option value="Neurological">Neurological</option>
            <option value="Psychopharmacology">Psychopharmacology</option>
            <option value="Pain">Pain</option>
            <option value="Inflammation">Inflammation</option>
            <option value="Endocrine">Endocrine</option>
            <option value="Infection">Infection</option>
          </select>
        </div>
      </div>
      <button id="fgSubmit" class="assign-btn" style="margin-top:12px;">Submit Guess</button>
      <p id="fgStatus" class="assign-error"></p>
    </section>

    <!-- Expert Huddle Box (single system) -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üë©‚Äç‚öïÔ∏è</span>
        <h2 class="section-title">Expert Huddle ‚Äì <span id="systemNameInline">System</span></h2>
      </div>

      <div class="huddle-box" id="huddleBox">
        <h3 id="huddleTitle">System Experts</h3>

        <div class="huddle-field">
          <label>#1 Safety Risk (What kills the patient first?)</label>
          <input type="text" id="safetyRisk" placeholder="e.g., Respiratory depression, Lithium toxicity, GI bleed">
        </div>

        <div class="huddle-field">
          <label>#1 Lab / Assessment to Monitor</label>
          <input type="text" id="priorityLab" placeholder="e.g., Lithium level, INR, Blood glucose, WBC">
        </div>

        <div class="huddle-field">
          <label>"Do Not Mix" Rule</label>
          <input type="text" id="doNotMix" placeholder="e.g., MAOIs + SSRIs, opioids + benzos, NSAIDs + anticoagulants">
        </div>

        <div class="huddle-field">
          <label>High-Yield Medication(s)</label>
          <input type="text" id="highYieldMed" placeholder="e.g., Lithium, Vancomycin, Morphine, Insulin">
        </div>

        <div class="huddle-field">
          <label>Scenario Prompts (at least 2)</label>
          <textarea id="scenarioPrompts" placeholder="Example:
1) Your patient on ___ develops ___. What is your first action?
2) Teaching point the patient MUST remember about this med."></textarea>
        </div>

        <div class="huddle-field">
          <label>Rationale: Why are these your Top 3 priorities?</label>
          <textarea id="rationale" placeholder="Connect back to ATI, safety, and NCLEX-style thinking."></textarea>
        </div>
      </div>
    </section>

    <!-- JIGSAW LEARNING TRACKER -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üîÑ</span>
        <h2 class="section-title">Jigsaw Learning ‚Äì Track Your Progress</h2>
      </div>

      <p style="color:#ccecff;font-size:14px;margin-bottom:15px;">
        As you rotate through each system station, check off what you've learned. 
        When you complete a system's teaching, click the checkbox below to mark it complete.
      </p>

      <div id="jigsawCheckboxes" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:15px;">
        <!-- Checkboxes populated automatically when group is selected -->
      </div>

      <div style="margin-top:15px;padding:12px;background:rgba(0,212,255,0.08);border-radius:10px;border-left:4px solid #00d4ff;">
        <p style="margin:0;font-size:13px;color:#ccecff;line-height:1.5;">
          <strong>üìù Pro Tip:</strong> Take notes on each system's #1 safety risk, critical lab, and do-not-mix rule. 
          You'll use this knowledge in the Lightning Round!
        </p>
      </div>
    </section>

    <!-- TEAM COMMUNICATION -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">ÔøΩ</span>
        <h2 class="section-title">Contact Charge Nurse</h2>
      </div>

      <div style="padding:12px;background:rgba(138,43,226,0.08);border-radius:10px;border-left:4px solid #8a2be2;">
        <p style="margin:0 0 12px 0;font-size:14px;color:#ccecff;"><strong>üìû Structured Escalation to Charge Nurse</strong></p>
        <div style="display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
          <div>
            <label style="display:block;font-size:12px;color:#ccecff;margin-bottom:4px;">We think it‚Äôs‚Ä¶</label>
            <input id="chargeHypothesis" class="fg-input" placeholder="Suspected condition/diagnosis" />
          </div>
          <div>
            <label style="display:block;font-size:12px;color:#ccecff;margin-bottom:4px;">Because‚Ä¶</label>
            <input id="chargeBecause" class="fg-input" placeholder="Key evidence: vitals, labs, symptoms" />
          </div>
          <div>
            <label style="display:block;font-size:12px;color:#ccecff;margin-bottom:4px;">First action is‚Ä¶</label>
            <input id="chargeAction" class="fg-input" placeholder="e.g., Hold med, give Naloxone, call provider" />
          </div>
          <div>
            <label style="display:block;font-size:12px;color:#ccecff;margin-bottom:4px;">We‚Äôre monitoring‚Ä¶</label>
            <input id="chargeMonitoring" class="fg-input" placeholder="e.g., RR/SpO2, neuro checks, BP/HR" />
          </div>
          <div>
            <label style="display:block;font-size:12px;color:#ccecff;margin-bottom:4px;">We request‚Ä¶</label>
            <select id="chargeRequestType" class="fg-input" style="width:100%;">
              <option value="">Choose one‚Ä¶</option>
              <option value="Approve">Approve</option>
              <option value="Check our priority">Check our priority</option>
              <option value="Need RRT">Need RRT</option>
            </select>
          </div>
        </div>

        <button onclick="sendChargeRequest()" class="assign-btn" style="margin-top:12px;background:#00d4ff;">Send Structured Request</button>
        
        <p style="margin:10px 0 0 0;font-size:11px;color:#888;">Groups 1-3 ‚Üí Charge Nurse 1 | Groups 4-6 ‚Üí Charge Nurse 2</p>
      </div>
      
      <!-- Conversation History -->
      <div id="conversationHistory" style="margin-top:15px;display:none;">
        <h4 style="color:#00d4ff;font-size:14px;margin-bottom:10px;">üí¨ Conversation with Charge Nurse</h4>
        <div id="conversationMessages" style="background:rgba(0,0,0,0.3);border-radius:10px;padding:15px;max-height:300px;overflow-y:auto;">
          <!-- Messages appear here -->
        </div>
      </div>
    </section>

    <!-- JIGSAW SPEED ROUND ‚Äì CASE REVEAL -->
    <section class="section" id="jigsawSection">
      <div class="section-header">
        <span class="section-icon">üß©</span>
        <h2 class="section-title">Jigsaw Speed Round ‚Äì Get Your Case</h2>
      </div>

      <p style="color:#ccecff;font-size:14px;margin-bottom:10px;">
        Each <strong>system expert</strong> will generate one case for their group.
        Select your expert role below and click <strong>"Get My Case"</strong>.
        The system will assign either a standard scenario or a consequence scenario based on your group's earlier decisions.
      </p>

      <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px;">
        <label for="jigsawSystemSelect" style="font-size:14px;color:#00d4ff;font-weight:600;">
          I am the expert for:
        </label>
        <select id="jigsawSystemSelect" class="fg-input" style="min-width:220px;">
          <option value="">Select your system‚Ä¶</option>
          <option value="psych">Psych / Haloperidol‚ÄìFluoxetine</option>
          <option value="neuro">Neuro / Levodopa‚ÄìPhenobarbital</option>
          <option value="pain">Pain / Fentanyl‚ÄìButorphanol</option>
          <option value="endocrine">Endocrine / PTU‚ÄìSomatropin</option>
          <option value="infection">Infection / Antibiotics‚ÄìAntifungals</option>
          <option value="inflammation">Inflammation / Belimumab‚ÄìAllopurinol‚ÄìSteroids</option>
        </select>

        <button id="jigsawCaseBtn" class="assign-btn">
          Get My Case
        </button>
      </div>

      <p id="jigsawStatus" class="assign-error"></p>

      <div id="jigsawCaseDisplay"
           style="margin-top:16px;padding:16px;border-radius:12px;border:1px solid rgba(0,212,255,0.4);background:rgba(255,255,255,0.04);min-height:80px;">
        <em style="color:#ccecff;font-size:13px;">Your case will appear here once generated. Do not refresh or you may lose your assigned scenario.</em>
      </div>
    </section>

    <!-- PHASE 3 REFLECTIONS -->
    <section class="section" id="reflectionSection" style="display:none;">
      <div class="section-header">
        <span class="section-icon">üß≠</span>
        <h2 class="section-title">End-of-Round Reflection</h2>
      </div>
      <p style="color:#ccecff;font-size:14px;margin-bottom:10px;">Required at end of Phase 3.</p>
      <div style="display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));">
        <div>
          <label style="display:block;font-size:12px;color:#ccecff;margin-bottom:4px;">What almost killed the patient?</label>
          <textarea id="reflectionNearMiss" class="fg-input" placeholder="e.g., Missed opioid RR drop, delayed lab check"></textarea>
        </div>
        <div>
          <label style="display:block;font-size:12px;color:#ccecff;margin-bottom:4px;">What will you do differently next time?</label>
          <textarea id="reflectionNextTime" class="fg-input" placeholder="e.g., Check RR before giving opioid, call provider sooner"></textarea>
        </div>
      </div>
      <button class="assign-btn" id="reflectionSubmit" style="margin-top:12px;" onclick="submitReflection()">Submit Reflection</button>
      <p id="reflectionStatus" class="assign-error"></p>
    </section>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    // IMMEDIATE: Test if this script even runs
    (function() {
      const banner = document.getElementById('debugBanner');
      if (banner) {
        banner.innerHTML = '<span class="status-warn">‚è≥ Main script started | Testing Firebase...</span>';
      }
    })();
    
    console.log('Script loading started...');
    
    // Update debug banner - define FIRST, outside try-catch
    function updateDebugBanner(status, message) {
      const banner = document.getElementById('debugBanner');
      if (banner) {
        let statusClass = 'status-warn';
        let icon = '‚è≥';
        if (status === 'ok') {
          statusClass = 'status-ok';
          icon = '‚úÖ';
        } else if (status === 'error') {
          statusClass = 'status-error';
          icon = '‚ùå';
        }
        banner.innerHTML = `<span class="${statusClass}">${icon} ${message}</span>`;
        console.log('Banner updated:', status, message);
      }
    }
    
    try {
      // Check if Firebase loaded
      if (typeof firebase === 'undefined') {
        updateDebugBanner('error', 'Firebase SDK failed to load - check internet connection');
        throw new Error('Firebase SDK not loaded');
      }
    
      updateDebugBanner('warn', 'Firebase initializing...');
      console.log('Firebase object found, initializing...');
      
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBfJ4KBqpbP4tbtikAgMEdbT5P1rb3yhHo",
        authDomain: "ati-pharm-blitz.firebaseapp.com",
        databaseURL: "https://ati-pharm-blitz-default-rtdb.firebaseio.com",
        projectId: "ati-pharm-blitz",
        storageBucket: "ati-pharm-blitz.firebasestorage.app",
        messagingSenderId: "236104923394",
        appId: "1:236104923394:web:201f51f9ba162438b2aa1b"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      window.database = firebase.database();  // Make globally accessible

      updateDebugBanner('warn', 'Firebase connected | Loading functions...');
      
      // CRITICAL: Define selection functions FIRST for onclick handlers - make globally accessible
      // DON'T initialize to null - let them be undefined until actually set
      if (typeof window.currentGroupId === 'undefined') window.currentGroupId = null;
      if (typeof window.selectedGroupNumber === 'undefined') window.selectedGroupNumber = null;
      if (typeof window.selectedRole === 'undefined') window.selectedRole = null;
    
    console.log('Functions will be defined later in script...');

      // ==========================================
      // PHASE LOCKING & STABILITY FEEDBACK
      // ==========================================

      // Make database accessible throughout the script
      const database = window.database;

      let currentPhase = 'phase1';
      let currentStability = 100;

      function getPhaseLabel(phase) {
        const labels = {
          phase1: { title: 'PHASE 1 ‚Äì System ID & Priority Check', desc: 'Identify the drug class and most critical safety concern.' },
          phase2: { title: 'PHASE 2 ‚Äì Expert Huddle', desc: 'Collaborate with peers to build your teaching points.' },
          phase3: { title: 'PHASE 3 ‚Äì Jigsaw Case', desc: 'Apply your expertise to solve a complex clinical scenario.' }
        };
        return labels[phase] || labels.phase1;
      }

      function renderPhaseBanner(wrapper, phase) {
        const phaseLabel = getPhaseLabel(phase);
        const banner = document.createElement('div');
        banner.className = `phase-banner ${phase}`;
        banner.innerHTML = `<div>${phaseLabel.title}</div><div class="phase-subtitle">${phaseLabel.desc}</div>`;
        wrapper.insertBefore(banner, wrapper.firstChild);
      }

      function isPhaseActive(requiredPhase) {
        const phaseOrder = { phase1: 1, phase2: 2, phase3: 3 };
        const currentOrder = phaseOrder[currentPhase] || 1;
        const requiredOrder = phaseOrder[requiredPhase] || 1;
        return currentOrder >= requiredOrder;
      }

      function showFeedbackToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `feedback-toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transition = 'opacity 0.4s ease';
          setTimeout(() => toast.remove(), 400);
        }, 2000);
      }

      function updateStabilityDisplay(stability) {
        currentStability = Math.max(0, Math.min(100, stability));
        const fillEl = document.getElementById('stabilityFill');
        if (fillEl) {
          const percent = currentStability;
          fillEl.style.width = percent + '%';
          fillEl.textContent = percent;
          fillEl.classList.remove('critical', 'warning');
          if (percent < 50) fillEl.classList.add('critical');
          else if (percent < 75) fillEl.classList.add('warning');
        }
      }

      function setFlashcardsReadonly(isReadOnly) {
        const ids = ['caseGuess', 'highestPriority', 'safetyFlag', 'nextStep', 'whyBetter', 'systemSelect'];
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.disabled = isReadOnly;
        });
        const submit = document.getElementById('fgSubmit');
        if (submit) {
          submit.disabled = isReadOnly;
          submit.textContent = isReadOnly ? 'Locked this phase' : 'Submit Guess';
        }
      }

      function applyPhaseLocks() {
        const flashcardSection = document.getElementById('flashcardGuessSection');
        const huddleBox = document.getElementById('huddleBox');
        const huddleSection = huddleBox ? huddleBox.closest('section') : null;
        const jigsawSection = document.getElementById('jigsawSection');
        const reflectionSection = document.getElementById('reflectionSection');

        if (currentPhase === 'phase1') {
          if (huddleSection) huddleSection.style.display = 'none';
          if (jigsawSection) jigsawSection.style.display = 'none';
          if (reflectionSection) reflectionSection.style.display = 'none';
          if (flashcardSection) flashcardSection.style.display = 'block';
          setFlashcardsReadonly(false);
        } else if (currentPhase === 'phase2') {
          if (huddleSection) huddleSection.style.display = 'block';
          if (jigsawSection) jigsawSection.style.display = 'none';
          if (reflectionSection) reflectionSection.style.display = 'none';
          if (flashcardSection) flashcardSection.style.display = 'block';
          setFlashcardsReadonly(true);
        } else if (currentPhase === 'phase3') {
          if (huddleSection) huddleSection.style.display = 'block';
          if (jigsawSection) jigsawSection.style.display = 'block';
          if (reflectionSection) reflectionSection.style.display = 'block';
          if (flashcardSection) flashcardSection.style.display = 'block';
          setFlashcardsReadonly(true);
          // Lock huddle inputs to read-only
          const ids = ['safetyRisk','priorityLab','doNotMix','highYieldMed','scenarioPrompts','rationale'];
          ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = true;
          });
        }
      }
    // Map group number -> system name + instructions
    const groupConfig = {
      1: {
        name: 'Neurological',
        label: 'Group 1 ‚Äì Neurological Experts',
        instructions: [
          'Focus on seizure meds, antiepileptics, and CNS depressants.',
          'Identify the biggest safety risk (airway, LOC, respiratory depression, etc.).',
          'Pick at least one high-yield drug (e.g., Phenytoin, Levetiracetam).',
          'Create two scenarios where neuro meds could rapidly become unsafe.',
          'Be ready to teach your Top 3 priorities to a mixed group.'
        ]
      },
      2: {
        name: 'Psychopharmacology',
        label: 'Group 2 ‚Äì Psychopharm Experts',
        instructions: [
          'Focus on antidepressants, antipsychotics, mood stabilizers, and anxiolytics.',
          'Think about suicide risk, serotonin syndrome, NMS, EPS, and sedation.',
          'Choose high-yield meds (e.g., Lithium, SSRIs, Clozapine).',
          'Create scenarios that force the group to choose the safest FIRST action.',
          'Prepare to explain why your rules prevent harm to the patient.'
        ]
      },
      3: {
        name: 'Pain Management',
        label: 'Group 3 ‚Äì Pain Management Experts',
        instructions: [
          'Focus on opioids, non-opioids, and adjunct pain meds.',
          'Zero in on respiratory depression, oversedation, and uncontrolled pain.',
          'Include at least one opioid and one non-opioid (e.g., Morphine + Ketorolac).',
          'Build scenarios where the wrong choice could tank breathing or perfusion.',
          'Be ready to explain how to safely combine or stagger pain meds.'
        ]
      },
      4: {
        name: 'Inflammation',
        label: 'Group 4 ‚Äì Inflammation / NSAID Experts',
        instructions: [
          'Focus on NSAIDs, steroids, and anti-inflammatory meds.',
          'Key risks: GI bleed, renal injury, immunosuppression.',
          'Pick common meds (e.g., Ibuprofen, Ketorolac, Prednisone).',
          'Create at least one scenario involving a patient on anticoagulants or with ulcers.',
          'Highlight labs and assessments that would make you HOLD the drug.'
        ]
      },
      5: {
        name: 'Endocrine',
        label: 'Group 5 ‚Äì Endocrine Experts',
        instructions: [
          'Focus on insulin, oral hypoglycemics, thyroid meds, and steroids.',
          'Watch for hypoglycemia, DKA/HHS, and thyroid storm/myxedema coma.',
          'Include at least one insulin and one oral agent or thyroid med.',
          'Create scenarios where timing of meds and meals matters.',
          'Be ready to explain which lab change is most deadly, the fastest.'
        ]
      },
      6: {
        name: 'Infection',
        label: 'Group 6 ‚Äì Infection / Antibiotic Experts',
        instructions: [
          'Focus on antibiotics, antivirals, and antifungals.',
          'Key risks: anaphylaxis, nephrotoxicity, C. diff, resistance.',
          'Choose high-yield meds (e.g., Vancomycin, Piperacillin-tazobactam).',
          'Write scenarios where cultures, trough levels, or allergies matter.',
          'Be ready to explain when you would STOP an antibiotic immediately.'
        ]
      }
    };

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    function initGroupView() {
      let groupNum = parseInt(getQueryParam('group'), 10);
      if (isNaN(groupNum) || groupNum < 1 || groupNum > 6) {
        showMissingGroupError();
        return;
      }

      const config = groupConfig[groupNum];

      // Update header
      const systemLabel = document.getElementById('systemLabel');
      const groupLabel = document.getElementById('groupLabel');
      const systemNameInline = document.getElementById('systemNameInline');
      const huddleTitle = document.getElementById('huddleTitle');

      if (systemLabel) systemLabel.textContent = `System Focus: ${config.name}`;
      if (groupLabel) groupLabel.textContent = config.label;
      if (systemNameInline) systemNameInline.textContent = config.name;
      if (huddleTitle) huddleTitle.textContent = `${config.name} ‚Äì Top 3 Priorities`;

      // Instructions list
      const list = document.getElementById('instructionList');
      if (list) {
        list.innerHTML = '';
        config.instructions.forEach(text => {
          const li = document.createElement('li');
          li.textContent = text;
          list.appendChild(li);
        });
      }
    }

    // DISABLED: Now using role selection screen instead
    // document.addEventListener('DOMContentLoaded', initGroupView);

    // Auto-save to Firebase
    function setupFirebaseSync(groupNum) {
      const fields = ['safetyRisk', 'priorityLab', 'doNotMix', 'highYieldMed', 'scenarioPrompts', 'rationale'];
      const groupRef = database.ref('groups/' + groupNum);

      // Load existing data
      groupRef.once('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          fields.forEach(field => {
            const el = document.getElementById(field);
            if (el && data[field]) {
              el.value = data[field];
            }
          });
        }
      });

      // Save on input
      fields.forEach(fieldId => {
        const el = document.getElementById(fieldId);
        if (el) {
          el.addEventListener('input', () => {
            const updates = {};
            fields.forEach(field => {
              const input = document.getElementById(field);
              updates[field] = input ? input.value : '';
            });
            updates.systemName = groupConfig[groupNum].name;
            updates.timestamp = Date.now();
            groupRef.set(updates);
          });
        }
      });
    }

    function initGroupView() {
      let groupNum = parseInt(getQueryParam('group'), 10);
      if (isNaN(groupNum) || groupNum < 1 || groupNum > 6) {
        groupNum = 1; // default to Group 1 if invalid
      }

      const config = groupConfig[groupNum];

      // Update header
      const systemLabel = document.getElementById('systemLabel');
      const groupLabel = document.getElementById('groupLabel');
      const systemNameInline = document.getElementById('systemNameInline');
      const huddleTitle = document.getElementById('huddleTitle');

      if (systemLabel) systemLabel.textContent = `System Focus: ${config.name}`;
      if (groupLabel) groupLabel.textContent = config.label;
      if (systemNameInline) systemNameInline.textContent = config.name;
      if (huddleTitle) huddleTitle.textContent = `${config.name} ‚Äì Top 3 Priorities`;

      // Instructions list
      const list = document.getElementById('instructionList');
      if (list) {
        list.innerHTML = '';
        config.instructions.forEach(text => {
          const li = document.createElement('li');
          li.textContent = text;
          list.appendChild(li);
        });
      }

      // Setup Firebase sync
      setupFirebaseSync(groupNum);
    }

    // DISABLED: Now using role selection screen instead
    // document.addEventListener('DOMContentLoaded', initGroupView);

    // -----------------------------
    // GROUP ID HANDLING (Legacy - kept for compatibility)
    // -----------------------------

    // currentGroupId already declared at top of script

    // Note: Group selection now handled by selectGroup() function
    // This legacy code kept for any direct references

    // -----------------------------
    // DECISION ENGINE + STABILITY
    // -----------------------------

    /**
     * recordDecision({
     *   phase: 'flashcard' | 'jigsaw' | 'lightning' | ...,
     *   itemId: 'card1' or 'scenarioA',
     *   isCorrect: true/false,
     *   severity: 'minor' | 'moderate' | 'critical',
     *   explanation: 'text shown to instructor'
     * })
     */
    function recordDecision(config) {
      const currentGroupId = window.currentGroupId;
      if (!currentGroupId) {
        const status = document.getElementById('fgStatus') || document.getElementById('groupIdStatus');
        if (status) {
          status.style.color = '#ff99c2';
          status.textContent = 'Set your Group # first.';
        }
        return;
      }

      const { phase, itemId, isCorrect, severity, explanation, followUpReason } = config;
      const database = window.database;
      const groupRef = database.ref('groups/' + currentGroupId);
      const eventsRef = database.ref('events');

      // Get difficulty settings from Firebase, then apply penalty
      database.ref('settings/difficulty').once('value').then(diffSnap => {
        const diffSettings = diffSnap.val();
        let delta = 0;
        
        if (!isCorrect) {
          if (diffSettings) {
            // Use instructor-set difficulty
            if (severity === 'critical') delta = -diffSettings.criticalPenalty;
            else if (severity === 'moderate') delta = -diffSettings.moderatePenalty;
            else delta = -diffSettings.minorPenalty;
          } else {
            // Default values if no difficulty set
            if (severity === 'critical') delta = -25;
            else if (severity === 'moderate') delta = -20;
            else delta = -5;
          }
        } else {
          // small positive bump for correct decisions
          delta = +2;
        }

        // Update stability atomically
        groupRef.child('stability').transaction(current => {
          if (typeof current !== 'number') current = 100;
          let next = current + delta;
          if (next > 100) next = 100;
          if (next < 0) next = 0;
          return next;
        }).then(() => {
          // Show visual feedback for stability change
          if (delta !== 0) {
            showStabilityFeedback(delta);
          }
          const msg = isCorrect
            ? `‚úÖ Correct ‚Äì Stability +${Math.abs(delta)}`
            : `‚ö† Unsafe: Stability ${delta}. Consequence risk increased.`;
          showFeedbackToast(msg, isCorrect ? 'success' : 'error');
        });

        // Log event (for instructor alerts/consequence mapping)
        const payload = {
          groupId: currentGroupId,
          phase: phase,
          itemId: itemId,
          isCorrect: !!isCorrect,
          severity: severity,
          explanation: explanation,
          delta: delta,
          followUp: !isCorrect,
          followUpReason: followUpReason || null,
          timestamp: Date.now()
        };

        eventsRef.push(payload);
      });
    }
    
    function showStabilityFeedback(delta) {
      const feedbackDiv = document.createElement('div');
      const isPositive = delta > 0;
      const icon = isPositive ? 'üìà' : 'üìâ';
      const color = isPositive ? '#00ffb3' : '#ff006e';
      const sign = isPositive ? '+' : '';
      
      feedbackDiv.textContent = `${icon} ${sign}${delta}`;
      feedbackDiv.style.cssText = `position:fixed;top:20%;right:20px;font-size:48px;font-weight:900;color:${color};z-index:10000;pointer-events:none;text-shadow:0 0 20px ${color};`;
      feedbackDiv.classList.add('stability-boost');
      document.body.appendChild(feedbackDiv);
      
      setTimeout(() => {
        feedbackDiv.style.transition = 'opacity 0.5s ease';
        feedbackDiv.style.opacity = '0';
        setTimeout(() => feedbackDiv.remove(), 500);
      }, 1500);
    }

    // -----------------------------
    // FLASHCARD DISPLAY + SYNC
    // -----------------------------

    function setupFlashcardSync() {
      const flashcards = document.querySelectorAll('.flashcard[data-card-id]');
      
      flashcards.forEach(card => {
        const cardId = card.dataset.cardId;
        if (!cardId) return;
        
        // Listen to Firebase for flip state
        database.ref('flashcards/' + cardId).on('value', (snapshot) => {
          const data = snapshot.val();
          if (data && data.flipped) {
            // Unlock and can be flipped
            card.classList.remove('locked');
            const back = card.querySelector('.flashcard-back');
            if (back && back.dataset.loaded !== 'true') {
              back.innerHTML = flashcardBackContent[cardId] || '<em>Content not found.</em>';
              back.dataset.loaded = 'true';
            }
            
            // Add visual feedback
            card.style.animation = 'pulse 0.5s ease';
            setTimeout(() => {
              card.style.animation = '';
            }, 500);
          }
        });
        
        // Allow manual toggle only if unlocked
        card.addEventListener('click', () => {
          if (!card.classList.contains('locked')) {
            card.classList.toggle('flipped');
          }
        });
      });
    }

    // Initialize flashcard sync
    setupFlashcardSync();
    
    // Randomize flashcard display order
    function randomizeFlashcards() {
      const container = document.querySelector('.flashcard-container');
      if (!container) return;
      
      const cards = Array.from(container.querySelectorAll('.flashcard'));
      
      // Fisher-Yates shuffle
      for (let i = cards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [cards[i], cards[j]] = [cards[j], cards[i]];
      }
      
      // Reappend in shuffled order
      cards.forEach(card => container.appendChild(card));
    }
    
    // Randomize on page load
    document.addEventListener('DOMContentLoaded', randomizeFlashcards);

    // -----------------------------
    // FLASHCARD GUESS ‚Äì AUTO CHECK
    // -----------------------------

    // Map each card to the correct system
    const flashcardKey = {
      card1: 'Psychopharmacology',  // Haloperidol/Fluoxetine - EPS, serotonin syndrome
      card2: 'Neurological',        // Levodopa/Phenobarbital - on-off phenomenon
      card3: 'Pain',                // Fentanyl/Butorphanol - respiratory depression
      card4: 'Endocrine',           // PTU/Somatropin - agranulocytosis
      card5: 'Infection',           // Erythromycin/Rifampin/Amphotericin B - drug interactions
      card6: 'Inflammation'         // Belimumab/Allopurinol/Hydrocortisone - live vaccines
    };

    // Lazy-loaded flashcard answers to avoid initial HTML leakage
    const flashcardBackContent = {
      card1: `
        <strong>System:</strong> Psychopharmacology<br>
        <strong>Answer:</strong> Extrapyramidal symptoms (EPS) - requires immediate benztropine or dose adjustment<br>
        <strong>Priority:</strong> Watch for tardive dyskinesia (irreversible)<br>
        <strong>Safety Tip:</strong> Avoid combining with anticholinergics unless treating EPS<br>
        <strong>High-Yield Med:</strong> Fluoxetine - risk of serotonin syndrome with MAOIs
      `,
      card2: `
        <strong>System:</strong> Neurological<br>
        <strong>Answer:</strong> Vitamin B6 (pyridoxine) levels - can decrease Levodopa effectiveness<br>
        <strong>Priority:</strong> Monitor for dyskinesias and orthostatic hypotension<br>
        <strong>Safety Tip:</strong> Avoid high-protein meals (competes with absorption)<br>
        <strong>High-Yield Med:</strong> Phenobarbital - monitor therapeutic levels (10-40 mcg/mL)
      `,
      card3: `
        <strong>System:</strong> Pain<br>
        <strong>Answer:</strong> Administer Naloxone (Narcan) immediately - opioid reversal agent<br>
        <strong>Priority:</strong> Monitor respiratory rate &lt;12 = critical<br>
        <strong>Do NOT Mix:</strong> Fentanyl + benzodiazepines (respiratory depression)<br>
        <strong>High-Yield Med:</strong> Butorphanol - mixed agonist-antagonist, can precipitate withdrawal
      `,
      card4: `
        <strong>System:</strong> Endocrine<br>
        <strong>Answer:</strong> Agranulocytosis - obtain STAT CBC with differential<br>
        <strong>Priority:</strong> Monitor WBC &lt;3,000 = hold medication<br>
        <strong>Safety Tip:</strong> Teach patient to report signs of infection immediately<br>
        <strong>High-Yield Med:</strong> Somatropin - monitor blood glucose (causes hyperglycemia)
      `,
      card5: `
        <strong>System:</strong> Infection<br>
        <strong>Answer:</strong> Increased bleeding risk - Erythromycin inhibits Warfarin metabolism (elevated INR)<br>
        <strong>Priority:</strong> Monitor INR closely, target 2-3 for most indications<br>
        <strong>Do NOT Mix:</strong> Rifampin + oral contraceptives (decreases effectiveness)<br>
        <strong>High-Yield Med:</strong> Amphotericin B - monitor potassium (causes severe hypokalemia)
      `,
      card6: `
        <strong>System:</strong> Inflammation<br>
        <strong>Answer:</strong> HOLD vaccine - immunosuppressed patients cannot receive live vaccines<br>
        <strong>Priority:</strong> Screen for infections before each dose<br>
        <strong>Safety Tip:</strong> Avoid NSAIDs with immunosuppressants (GI bleeding risk)<br>
        <strong>High-Yield Meds:</strong> Allopurinol (monitor uric acid), Hydrocortisone (taper slowly - adrenal crisis)
      `
    };

    function populateFirstActionOptions(cardId) {
      const actionSelect = document.getElementById('fgAction');
      if (!actionSelect) return;
      actionSelect.innerHTML = '<option value="">Select first action‚Ä¶</option>';
      const config = flashcardActions[cardId];
      if (!config) return;
      config.options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        actionSelect.appendChild(option);
      });
    }

    // First-action requirements per flashcard
    const flashcardActions = {
      card1: {
        options: [
          'Give benztropine, hold haloperidol, notify provider',
          'Reassure and continue haloperidol',
          'Give lorazepam for anxiety',
          'Increase haloperidol dose'
        ],
        correct: 'Give benztropine, hold haloperidol, notify provider',
        rationale: 'EPS first action is benztropine + hold/notify to prevent progression to NMS.'
      },
      card2: {
        options: [
          'Check Vitamin B6 interactions and adjust dosing',
          'Increase protein intake',
          'Give PRN opioid for tremors',
          'Stop levodopa immediately without consult'
        ],
        correct: 'Check Vitamin B6 interactions and adjust dosing',
        rationale: 'High B6 or protein blocks levodopa; adjust and monitor to prevent wearing off.'
      },
      card3: {
        options: [
          'Give Naloxone now and support airway',
          'Call provider and wait',
          'Give morphine for pain',
          'Place patient flat and reassess later'
        ],
        correct: 'Give Naloxone now and support airway',
        rationale: 'RR 8 on fentanyl = opioid toxicity. First action is Naloxone + airway support.'
      },
      card4: {
        options: [
          'Hold PTU and order STAT CBC with diff',
          'Give next PTU dose early',
          'Give acetaminophen only',
          'Ignore and recheck in 24h'
        ],
        correct: 'Hold PTU and order STAT CBC with diff',
        rationale: 'Sore throat+fever on PTU = agranulocytosis until proven otherwise. Hold and lab check.'
      },
      card5: {
        options: [
          'Call provider, check INR, anticipate dose reduction',
          'Double the warfarin dose',
          'Stop antibiotics immediately without consult',
          'No action needed'
        ],
        correct: 'Call provider, check INR, anticipate dose reduction',
        rationale: 'Erythromycin raises INR; first action is assess INR and adjust/hold per provider.'
      },
      card6: {
        options: [
          'Hold live vaccine and assess for infection',
          'Proceed with vaccine now',
          'Give NSAID premedication and vaccinate',
          'Increase steroid dose and vaccinate'
        ],
        correct: 'Hold live vaccine and assess for infection',
        rationale: 'Immunosuppressed patients cannot receive live vaccines; hold and reassess infection risk.'
      }
    };

    function submitFlashcardGuess() {
      // Access global Firebase database and group ID
      const database = window.database;
      let currentGroupId = window.currentGroupId;
      
      // Fallback: try to get from localStorage if not set
      if (!currentGroupId) {
        const stored = localStorage.getItem('pharmBlitzGroupId');
        if (stored) {
          currentGroupId = parseInt(stored, 10);
          window.currentGroupId = currentGroupId;
          console.log('Recovered currentGroupId from localStorage:', currentGroupId);
        }
      }
      
      console.log('submitFlashcardGuess - database:', !!database, 'currentGroupId:', currentGroupId);
      
      if (!database) {
        console.error('Firebase database not initialized');
        return;
      }
      
      const cardInput = document.getElementById('fgCard');
      const systemInput = document.getElementById('fgSystem');
      const actionInput = document.getElementById('fgAction');
      const statusEl = document.getElementById('fgStatus');
      const submitBtn = document.getElementById('fgSubmit');
      const guessSection = document.getElementById('flashcardGuessSection');

      statusEl.textContent = '';

      if (!currentGroupId) {
        console.error('currentGroupId is not set! window.currentGroupId:', window.currentGroupId);
        console.error('All window properties:', Object.keys(window).filter(k => k.includes('roup')));
        statusEl.style.color = '#ff99c2';
        statusEl.textContent = `Set your Group # first. (Debug: window.currentGroupId = ${window.currentGroupId})`;
        submitBtn?.classList.add('error-flash');
        setTimeout(() => submitBtn?.classList.remove('error-flash'), 500);
        return;
      }

      const cardId = cardInput.value;
      const systemGuess = systemInput.value;
      const actionGuess = actionInput.value;

      if (!cardId) {
        statusEl.style.color = '#ff99c2';
        statusEl.textContent = 'Choose which card you are answering for.';
        cardInput?.classList.add('error-flash');
        setTimeout(() => cardInput?.classList.remove('error-flash'), 500);
        return;
      }
      if (!systemGuess) {
        statusEl.style.color = '#ff99c2';
        statusEl.textContent = 'Select your system guess.';
        systemInput?.classList.add('error-flash');
        setTimeout(() => systemInput?.classList.remove('error-flash'), 500);
        return;
      }
      if (!actionGuess) {
        statusEl.style.color = '#ff99c2';
        statusEl.textContent = 'Select your FIRST nursing action before reveal.';
        actionInput?.classList.add('error-flash');
        setTimeout(() => actionInput?.classList.remove('error-flash'), 500);
        return;
      }

      const correctSystem = flashcardKey[cardId];
      const actionConfig = flashcardActions[cardId] || { correct: '', rationale: '' };
      const isSystemCorrect = (systemGuess === correctSystem);
      const isActionCorrect = (actionGuess === actionConfig.correct);
      const isFullyCorrect = isSystemCorrect && isActionCorrect;

      if (isFullyCorrect) {
        statusEl.style.color = '#00ffb3';
        statusEl.textContent = `‚úì Correct ‚Äì stability protected. Rationale: ${actionConfig.rationale}`;
        
        // Unlock flashcard answer across the cohort
        database.ref('flashcards/' + cardId).set({
          flipped: true,
          unlockedBy: currentGroupId,
          timestamp: Date.now()
        });

        // Visual success feedback
        guessSection?.classList.add('success-flash');
        setTimeout(() => guessSection?.classList.remove('success-flash'), 600);
        
        // Show celebration icon
        showCelebration('‚úÖ');
        
        // Record correct decision (affects patient stability only)
        recordDecision({
          phase: 'flashcard',
          itemId: cardId,
          isCorrect: true,
          severity: 'minor',
          explanation: `Correctly identified ${cardId} as ${correctSystem}; first action: ${actionGuess}.`
        });
      } else {
        const misses = [];
        if (!isSystemCorrect) misses.push(`System guess ${systemGuess} (needs ${correctSystem})`);
        if (!isActionCorrect) misses.push(`First action '${actionGuess}' (needs ${actionConfig.correct || 'correct first action'})`);
        statusEl.style.color = '#ff006e';
        statusEl.textContent = `Wrong ‚Äì ${misses.join(' | ')}. Patient stability drops.`;
        
        // Visual error feedback
        guessSection?.classList.add('error-flash');
        setTimeout(() => guessSection?.classList.remove('error-flash'), 500);
        
        showCelebration('‚ùå');
        
        // INCREASED DIFFICULTY: Wrong flashcard now treated as critical error (-20 stability)
        recordDecision({
          phase: 'flashcard',
          itemId: cardId,
          isCorrect: false,
          severity: 'critical',
          explanation: `CRITICAL miss on ${cardId}: ${misses.join(' | ')}`,
          followUpReason: `Earlier miss on ${correctSystem} action will return as a consequence.`
        });
      }

      // Reset form after brief delay
      setTimeout(() => {
        cardInput.value = '';
        systemInput.value = '';
        actionInput.value = '';
      }, 2000);
    }
    
    function showCelebration(icon) {
      const celebDiv = document.createElement('div');
      celebDiv.textContent = icon;
      celebDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:120px;z-index:10000;pointer-events:none;';
      celebDiv.classList.add('celebration-icon');
      document.body.appendChild(celebDiv);
      
      setTimeout(() => celebDiv.remove(), 800);
    }

    const fgBtn = document.getElementById('fgSubmit');
    if (fgBtn) {
      fgBtn.addEventListener('click', submitFlashcardGuess);
    }

    const fgCardSelect = document.getElementById('fgCard');
    if (fgCardSelect) {
      fgCardSelect.addEventListener('change', (e) => populateFirstActionOptions(e.target.value));
    }

    // -----------------------------
    // JIGSAW LEARNING CHECKBOXES
    // -----------------------------

    const systemNames = {
      1: 'Neurological üß†',
      2: 'Psychopharmacology üíä',
      3: 'Pain Management üò£',
      4: 'Inflammation üî•',
      5: 'Endocrine ü©∫',
      6: 'Infection ü¶†'
    };

    let jigsawCheckboxesInitialized = false;

    function setupJigsawCheckboxes() {
      const container = document.getElementById('jigsawCheckboxes');
      const currentGroupId = window.currentGroupId;
      const database = window.database;
      if (!container || !currentGroupId) return;
      
      // Prevent duplicate initialization
      if (jigsawCheckboxesInitialized) {
        console.log('‚ö†Ô∏è Jigsaw checkboxes already initialized, skipping...');
        return;
      }
      
      console.log('üîÑ Initializing jigsaw checkboxes for group', currentGroupId);
      jigsawCheckboxesInitialized = true;

      // Clear any existing content
      container.innerHTML = '';

      const jigsawRef = database.ref('jigsaw/group' + currentGroupId);

      // Load existing progress
      jigsawRef.once('value', (snapshot) => {
        const data = snapshot.val() || {};

        for (let sysNum = 1; sysNum <= 6; sysNum++) {
          const systemKey = 'system' + sysNum;
          const isCompleted = data[systemKey] === true;

          const box = document.createElement('div');
          box.style.cssText = 'background:rgba(255,255,255,0.05);border-radius:10px;padding:12px;border:1px solid rgba(0,212,255,0.3);display:flex;align-items:center;gap:10px;cursor:pointer;transition:all 0.2s ease;';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = 'jigsaw-sys-' + sysNum;
          checkbox.checked = isCompleted;
          checkbox.style.cssText = 'width:18px;height:18px;cursor:pointer;';

          const label = document.createElement('label');
          label.htmlFor = 'jigsaw-sys-' + sysNum;
          label.textContent = systemNames[sysNum];
          label.style.cssText = 'flex:1;cursor:pointer;font-size:14px;color:#ccecff;';

          box.appendChild(checkbox);
          box.appendChild(label);
          container.appendChild(box);

          // Save to Firebase when checked/unchecked
          checkbox.addEventListener('change', () => {
            jigsawRef.update({
              [systemKey]: checkbox.checked
            });

            // Optional: log a decision event
            if (checkbox.checked) {
              recordDecision({
                phase: 'jigsaw',
                itemId: systemKey,
                isCorrect: true,
                severity: 'minor',
                explanation: `Group ${currentGroupId} completed learning ${systemNames[sysNum]}`
              });
            }
          });

          // Visual feedback on hover
          box.addEventListener('mouseenter', () => {
            box.style.background = 'rgba(0,212,255,0.1)';
          });
          box.addEventListener('mouseleave', () => {
            box.style.background = 'rgba(255,255,255,0.05)';
          });
        }
      });

      // Listen for changes from instructor or other devices
      jigsawRef.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        for (let sysNum = 1; sysNum <= 6; sysNum++) {
          const checkbox = document.getElementById('jigsaw-sys-' + sysNum);
          if (checkbox) {
            checkbox.checked = data['system' + sysNum] === true;
          }
        }
      });
    }

    // Also initialize on page load if group ID already exists
    if (currentGroupId) {
      setupJigsawCheckboxes();
    }

    // Try again after a short delay in case group ID loads from localStorage
    setTimeout(() => {
      if (currentGroupId && document.getElementById('jigsawCheckboxes').children.length <= 1) {
        setupJigsawCheckboxes();
      }
    }, 1000);

    // -----------------------------
    // JIGSAW SPEED ROUND ‚Äì CASE ASSIGNMENT
    // -----------------------------

    // Map systems ‚Üí their flashcard card ID
    const systemToCard = {
      psych: 'card1',
      neuro: 'card2',
      pain: 'card3',
      endocrine: 'card4',
      infection: 'card5',
      inflammation: 'card6'
    };

    const cardToSystemKey = Object.fromEntries(Object.entries(systemToCard).map(([sys, card]) => [card, sys]));

    // JIGSAW CASE BANK
    const jigsawCases = {
      psych: {
        standard: {
          title: 'Psych ‚Äì Standard Case: Haloperidol (NMS Risk)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>You receive a new patient with schizophrenia started on <strong>Haloperidol</strong> 48 hours ago.</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Temperature: <strong>100.9¬∞F</strong></li>
              <li>Increasing <strong>muscle rigidity</strong></li>
              <li>BP: <strong>168/94</strong>, HR <strong>128</strong></li>
              <li>Patient looks confused and diaphoretic.</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority concern</strong>, and what is your <strong>first action</strong> as the nurse?</p>
          `
        },
        consequence: {
          title: 'Psych ‚Äì NGN Multi-Step Case: Fluoxetine + Tramadol (Serotonin Syndrome)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>Patient on <strong>fluoxetine</strong> for depression and <strong>tramadol</strong> for chronic pain presents with:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Temperature: <strong>102.6¬∞F</strong></li>
              <li><strong>Clonus</strong> and hyperreflexia</li>
              <li>Agitation, flushed skin, heavy sweating</li>
              <li>BP <strong>154/90</strong>, HR <strong>132</strong></li>
            </ul>
            <div style="background:rgba(255,107,107,0.15);padding:15px;border-radius:10px;border-left:4px solid #ff006e;margin:15px 0;">
              <p style="color:#ff99c2;font-weight:700;margin-bottom:10px;">‚ö†Ô∏è NGN-STYLE MULTI-STEP CLINICAL JUDGMENT</p>
              <p style="color:#fff;margin-bottom:8px;"><strong>As a group, complete ALL of the following steps:</strong></p>
              <ol style="margin-left:20px;color:#ccecff;line-height:1.8;">
                <li><strong>IDENTIFY:</strong> What is the most likely condition this patient is experiencing?</li>
                <li><strong>PRIORITIZE:</strong> What is your FIRST nursing action? (Choose one specific intervention)</li>
                <li><strong>ANALYZE:</strong> Which provider order would you question or hold immediately?</li>
                <li><strong>EDUCATE:</strong> Identify ONE priority teaching point for this patient before discharge to prevent recurrence.</li>
              </ol>
              <p style="color:#ffb300;font-size:12px;margin-top:10px;">‚ö° Charge Nurse: ALL 4 steps must be addressed correctly to APPROVE.</p>
            </div>
          `
        }
      },

      neuro: {
        standard: {
          title: 'Neuro ‚Äì Standard Case: Levodopa/Carbidopa (Fall Risk)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A Parkinson's patient taking <strong>levodopa-carbidopa</strong> reports:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Improved tremors</li>
              <li><strong>Dizziness</strong> when standing</li>
              <li>Nausea</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority nursing focus</strong> for this patient to prevent harm?</p>
          `
        },
        consequence: {
          title: 'Neuro ‚Äì Consequence Case: Phenobarbital Toxicity',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A seizure patient taking <strong>phenobarbital</strong> is found:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Very lethargic, difficult to arouse</li>
              <li>RR <strong>8</strong></li>
              <li>BP <strong>90/60</strong></li>
              <li>Pupils sluggish</li>
              <li>Admits: "I took a little extra dose because I felt a seizure coming."</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority action</strong>, and what is the likely cause of this decline?</p>
          `
        }
      },

      pain: {
        standard: {
          title: 'Pain ‚Äì Standard Case: Fentanyl Monitoring',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>Post-op patient received IV <strong>fentanyl</strong> 20 minutes ago.</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Pain decreases from 9/10 ‚Üí 3/10</li>
              <li>RR <strong>10</strong>, shallow but arousable</li>
              <li>SpO‚ÇÇ <strong>92%</strong> on 2 L/min NC</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>next nursing action</strong> and what should you watch closely?</p>
          `
        },
        consequence: {
          title: 'Pain ‚Äì Consequence Case: Fentanyl Overdose',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>Same post-op patient now:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>RR <strong>6</strong></li>
              <li>Unresponsive to voice</li>
              <li>SpO‚ÇÇ <strong>84%</strong></li>
              <li>Pinpoint pupils</li>
              <li>An empty fentanyl PCA vial is in the bed.</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>first priority action</strong>, and what medication do you anticipate administering?</p>
          `
        }
      },

      endocrine: {
        standard: {
          title: 'Endocrine ‚Äì Standard Case: PTU (Agranulocytosis Risk)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A patient on <strong>PTU</strong> for hyperthyroidism reports:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Sore throat</li>
              <li>Mild fever</li>
              <li>Fatigue</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What lab value is your <strong>priority</strong>, and why?</p>
          `
        },
        consequence: {
          title: 'Endocrine ‚Äì Consequence Case: PTU Agranulocytosis',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>Same PTU patient now presents with:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Temp <strong>101.8¬∞F</strong></li>
              <li>Severe sore throat</li>
              <li>WBC <strong>1,200</strong></li>
              <li>BP <strong>92/54</strong>, HR <strong>130</strong></li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What condition are you most concerned about and what is your <strong>immediate nursing action</strong>?</p>
          `
        }
      },

      infection: {
        standard: {
          title: 'Infection ‚Äì Standard Case: Rifampin (Liver Monitoring)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A TB patient on <strong>rifampin</strong> reports:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Orange-colored urine and tears</li>
              <li>Mild fatigue</li>
              <li>Mild abdominal discomfort</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            Which lab values are your <strong>priority</strong> to monitor, and why?</p>
          `
        },
        consequence: {
          title: 'Infection ‚Äì NGN Multi-Step Case: Amphotericin B Nephrotoxicity + Hyperkalemia',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A patient on IV <strong>Amphotericin B</strong> for fungal infection now has:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Creatinine rising from 0.9 ‚Üí <strong>2.4</strong></li>
              <li>K‚Å∫ <strong>6.1</strong></li>
              <li>EKG showing <strong>peaked T waves</strong></li>
              <li>Rigors and fevers with infusions</li>
            </ul>
            <div style="background:rgba(255,107,107,0.15);padding:15px;border-radius:10px;border-left:4px solid #ff006e;margin:15px 0;">
              <p style="color:#ff99c2;font-weight:700;margin-bottom:10px;">‚ö†Ô∏è NGN-STYLE MULTI-STEP CLINICAL JUDGMENT</p>
              <p style="color:#fff;margin-bottom:8px;"><strong>As a group, complete ALL of the following steps:</strong></p>
              <ol style="margin-left:20px;color:#ccecff;line-height:1.8;">
                <li><strong>IDENTIFY:</strong> What TWO critical conditions is this patient experiencing? (List both)</li>
                <li><strong>PRIORITIZE:</strong> Which condition poses the most IMMEDIATE life threat and why?</li>
                <li><strong>INTERVENE:</strong> State your FIRST nursing action before calling the provider.</li>
                <li><strong>PREVENT:</strong> What earlier monitoring (specific lab + frequency) could have prevented this crisis?</li>
              </ol>
              <p style="color:#ffb300;font-size:12px;margin-top:10px;">‚ö° Charge Nurse: ALL 4 steps must show critical thinking to APPROVE.</p>
            </div>
          `
        }
      },

      inflammation: {
        standard: {
          title: 'Inflammation ‚Äì Standard Case: Belimumab (Infection Risk)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A lupus patient on <strong>belimumab</strong> reports:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>New fatigue</li>
              <li>Mild sore throat</li>
              <li>Low-grade temp 99.9¬∞F</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority teaching</strong> for this patient?</p>
          `
        },
        consequence: {
          title: 'Inflammation ‚Äì Consequence Case: Allopurinol (SJS/TEN)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A gout patient on <strong>allopurinol</strong> develops:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Widespread painful rash</li>
              <li>Blistering lesions</li>
              <li>Fever</li>
              <li>Oral and mucosal involvement</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority concern</strong>, and what should you do immediately?</p>
          `
        }
      }
    };

    // Decide which variant a group gets: standard vs consequence
    function decideJigsawVariantForGroup(systemKey) {
      return new Promise((resolve, reject) => {
        if (!currentGroupId) {
          return reject(new Error('Group # not set. Make sure your group has already used the site for Phase 1.'));
        }

        const cardId = systemToCard[systemKey];
        if (!cardId) return reject(new Error('Unknown system selection.'));

        const groupRef = database.ref('groups/' + currentGroupId + '/stability');
        const eventsRef = database.ref('events').orderByChild('groupId').equalTo(currentGroupId);

        // Get stability + events in parallel
        Promise.all([
          groupRef.once('value'),
          eventsRef.once('value')
        ]).then(([stabilitySnap, eventsSnap]) => {
          const stability = typeof stabilitySnap.val() === 'number' ? stabilitySnap.val() : 100;
          let hadFlashcardMiss = false;
          let followUpReason = null;

          const eventsVal = eventsSnap.val() || {};
          Object.values(eventsVal).forEach(ev => {
            if (
              ev.phase === 'flashcard' &&
              ev.itemId === cardId &&
              ev.isCorrect === false
            ) {
              hadFlashcardMiss = true;
            }

            // Capture earliest consequence reason tied to this system
            const evSystemKey = cardToSystemKey[ev.itemId];
            if (!ev.isCorrect && evSystemKey === systemKey && (ev.followUp || ev.followUpReason)) {
              followUpReason = ev.followUpReason || ev.explanation;
            }
          });

          // RULE (INCREASED DIFFICULTY):
          // If they missed the flashcard for this system ‚Üí ALWAYS consequence case.
          // Else, if stability < 90 ‚Üí consequence case.
          // Only assign standard if: no flashcard miss AND stability >= 90
          if (hadFlashcardMiss) {
            resolve({ variant: 'consequence', followUpReason });
          } else if (stability < 90) {
            resolve({ variant: 'consequence', followUpReason });
          } else {
            resolve({ variant: 'standard', followUpReason });
          }

        }).catch(err => reject(err));
      });
    }

    // Hook up the "Get My Case" button
    const jigsawCaseBtn = document.getElementById('jigsawCaseBtn');
    const jigsawSystemSelect = document.getElementById('jigsawSystemSelect');
    const jigsawCaseDisplay = document.getElementById('jigsawCaseDisplay');
    const jigsawStatus = document.getElementById('jigsawStatus');

    if (jigsawCaseBtn && jigsawSystemSelect && jigsawCaseDisplay) {
      jigsawCaseBtn.addEventListener('click', () => {
        jigsawStatus.textContent = '';
        jigsawCaseDisplay.innerHTML = '<em style="color:#ccecff;font-size:13px;">Loading case...</em>';

        const systemKey = jigsawSystemSelect.value;
        if (!systemKey) {
          jigsawStatus.style.color = '#ff99c2';
          jigsawStatus.textContent = 'Please select your expert system first.';
          jigsawCaseDisplay.innerHTML = '<em style="color:#ccecff;font-size:13px;">No case loaded.</em>';
          return;
        }

        if (!jigsawCases[systemKey]) {
          jigsawStatus.style.color = '#ff99c2';
          jigsawStatus.textContent = 'Case bank not configured for that system.';
          return;
        }

        decideJigsawVariantForGroup(systemKey)
          .then(result => {
            const { variant, followUpReason } = result;
            const caseData = jigsawCases[systemKey][variant];
            if (!caseData) {
              throw new Error('No case configured for that variant.');
            }
            jigsawCaseDisplay.innerHTML = `
              <h3 style="color:#00ffb3;margin-top:0;">${caseData.title}</h3>
              ${caseData.html}
              <p style="margin-top:12px;font-size:12px;color:#ccecff;">
                <em>Note for your group:</em> This scenario was assigned based on your earlier decisions in Phase 1.
              </p>
              ${variant === 'consequence' && followUpReason ? `<div style="margin-top:10px;padding:10px;border-radius:8px;background:rgba(255,0,110,0.12);border:1px solid rgba(255,0,110,0.3);color:#ff99c2;font-size:12px;">Because earlier you missed: ${followUpReason}</div>` : ''}
            `;
          })
          .catch(err => {
            console.error(err);
            jigsawStatus.style.color = '#ff99c2';
            jigsawStatus.textContent = 'Unable to assign case. Check your group number and Firebase connection.';
            jigsawCaseDisplay.innerHTML = '<em style="color:#ff9f9f;font-size:13px;">Error loading case.</em>';
          });
      });
    }

    // -----------------------------
    // GROUP & LEADERSHIP SELECTION (Define immediately for onclick handlers)
    // -----------------------------
    // selectedGroupNumber and selectedRole already declared at top of script

    // Define functions IMMEDIATELY on window object
    window.selectLeadership = function(role) {
      console.log('selectLeadership called with role:', role);
      selectedRole = role;
      authRole = role; // Set auth role for this leadership role
      
      // Store role in localStorage
      try {
        localStorage.setItem('pharmBlitzRole', role);
        localStorage.removeItem('pharmBlitzGroupId'); // Clear group if switching to leadership
      } catch (e) {}

      // Claim this leadership role in Firebase
      const leadershipRef = database.ref('leadership/' + role);
      leadershipRef.set({
        claimed: true,
        timestamp: Date.now()
      });

      // Hide selection, show leadership dashboard
      document.getElementById('groupSelectionScreen').classList.add('hidden');
      document.getElementById('leadershipDashboard').style.display = 'block';

      // Set role label
      const roleNames = {
        charge1: 'Charge Nurse 1',
        charge2: 'Charge Nurse 2',
        rrt: 'Rapid Response RN'
      };
      document.getElementById('leadershipRoleLabel').textContent = 'Role: ' + roleNames[role];

      // Show appropriate sections
      if (role === 'rrt') {
        document.getElementById('rrtControls').style.display = 'none';
        document.getElementById('rrtCalls').style.display = 'block';
        document.getElementById('debriefBoard').style.display = 'none';
        document.getElementById('errorLogSection').style.display = 'none';
        document.getElementById('groupCasesSection').style.display = 'none';
        setupRRTListener();
      } else {
        document.getElementById('rrtControls').style.display = 'block';
        document.getElementById('rrtCalls').style.display = 'none';
        document.getElementById('debriefBoard').style.display = 'block';
        document.getElementById('errorLogSection').style.display = 'block';
        document.getElementById('groupCasesSection').style.display = 'block';
        setupDebriefBoard(role);
      }

      // Initialize dashboards
      setupAllGroupsMonitor(role);
      setupEventAlerts(role);
      setupChargeNurseMessages(role); // Add message listener
      if (role !== 'rrt') {
        setupErrorLog(role);
        setupGroupCasesMonitor(role);
      }
    }

    window.selectGroup = function(groupNumber) {
      console.log('=== selectGroup START ===');
      console.log('selectGroup called with groupNumber:', groupNumber);
      console.log('Before assignment - window.currentGroupId:', window.currentGroupId);
      window.currentGroupId = groupNumber;
      window.selectedGroupNumber = groupNumber;
      console.log('After assignment - window.currentGroupId:', window.currentGroupId);
      console.log('=== selectGroup END ===');
      
      // Reset jigsaw checkboxes flag when switching groups
      jigsawCheckboxesInitialized = false;
      
      // Get config for this group
      const config = groupConfig[groupNumber];
      if (!config) {
        console.error('No config found for group:', groupNumber);
        showMissingGroupError();
        return;
      }
      
      // Store group in localStorage
      try {
        localStorage.setItem('pharmBlitzGroupId', String(groupNumber));
        localStorage.removeItem('pharmBlitzRole'); // Clear leadership role if joining group
      } catch (e) {}

      // Hide selection screen, show group activity content
      document.getElementById('groupSelectionScreen').classList.add('hidden');
      document.getElementById('groupActivityContent').style.display = 'block';

      // Update UI labels
      const systemLabel = document.getElementById('systemLabel');
      const groupLabel = document.getElementById('groupLabel');
      if (systemLabel) systemLabel.textContent = 'System Focus: ' + config.name;
      if (groupLabel) groupLabel.textContent = 'Group: ' + groupNumber;

      // Update mission instructions
      const instructionList = document.getElementById('instructionList');
      if (instructionList && config.instructions) {
        instructionList.innerHTML = '';
        config.instructions.forEach(text => {
          const li = document.createElement('li');
          li.textContent = text;
          instructionList.appendChild(li);
        });
      }

      // Update huddle title
      const huddleTitle = document.getElementById('huddleTitle');
      if (huddleTitle) {
        huddleTitle.textContent = config.name + ' ‚Äì Top 3 Priorities';
      }

      // Show mission section
      const missionSection = document.getElementById('missionSection');
      if (missionSection) {
        missionSection.style.display = 'block';
      }

      // Initialize stability in Firebase
      const database = window.database;
      const groupRef = database.ref('groups/' + groupNumber);
      groupRef.child('stability').once('value').then(snap => {
        if (snap.val() == null) {
          groupRef.update({ stability: 100 });
        }
      });

      // Listen for stability updates
      groupRef.child('stability').on('value', snap => {
        const val = typeof snap.val() === 'number' ? snap.val() : 100;
        updateStabilityDisplay(val);
      });

      // Listen for phase updates
      groupRef.child('phase').on('value', snap => {
        currentPhase = snap.val() || 'phase1';
        const wrapper = document.querySelector('.main-wrapper.group-activity-content');
        if (wrapper) {
          wrapper.querySelectorAll('.phase-banner').forEach(el => el.remove());
          renderPhaseBanner(wrapper, currentPhase);
        }
        applyPhaseLocks();
      });

      // Initial render
      const wrapper = document.querySelector('.main-wrapper.group-activity-content');
      if (wrapper) {
        wrapper.querySelectorAll('.phase-banner').forEach(el => el.remove());
        renderPhaseBanner(wrapper, currentPhase);
      }
      applyPhaseLocks();
      updateStabilityDisplay(100);

      // Setup Firebase sync for this group
      if (typeof setupFirebaseSync === 'function') {
        setupFirebaseSync(groupNumber);
      }
      
      // Show conversation history for students
      showConversationHistory();

      // Initialize jigsaw checkboxes
      if (typeof setupJigsawCheckboxes === 'function') {
        setupJigsawCheckboxes();
      }
      
      // Chat listener disabled (feature removed)
    }
    
    console.log('selectLeadership and selectGroup functions defined');
    console.log('window.selectLeadership:', typeof window.selectLeadership);
    console.log('window.selectGroup:', typeof window.selectGroup);

    // -----------------------------
    // PARAM ROUTING
    // -----------------------------
    function getUrlGroupId() {
      const g = parseInt(getQueryParam('group'), 10);
      if (Number.isNaN(g)) return null;
      return g >= 1 && g <= 6 ? g : null;
    }

    function showMissingGroupError() {
      const err = document.getElementById('groupErrorScreen');
      const selection = document.getElementById('groupSelectionScreen');
      const student = document.getElementById('groupActivityContent');
      const leader = document.getElementById('leadershipDashboard');
      if (selection) selection.style.display = 'none';
      if (student) student.style.display = 'none';
      if (leader) leader.style.display = 'none';
      if (err) err.style.display = 'block';
    }

    function bootstrapFromParams() {
      console.log('üîµ BOOTSTRAP START');
      // ===== ROUTER / VIEW GATING (DROP-IN FIX) =====
      const params = new URLSearchParams(window.location.search);
      const role = (params.get("role") || "student").toLowerCase();
      const groupId = params.get("group");
      
      console.log('üîµ Router params - role:', role, 'groupId:', groupId);
      console.log('üîµ window.selectGroup exists?', typeof window.selectGroup);

      const elRoleSelect = document.getElementById("groupSelectionScreen");
      const elStudent = document.getElementById("groupActivityContent");
      const elLeadership = document.getElementById("leadershipDashboard");
      const elMissingGroup = document.getElementById("groupErrorScreen");
      const elUnlockModal = document.getElementById("passcodeModal");

      function showOnly(...els) {
        [elRoleSelect, elStudent, elLeadership, elMissingGroup].forEach(e => {
          if (e) e.style.display = "none";
        });
        els.forEach(e => {
          if (e) e.style.display = "block";
        });
      }

      function requireLeadershipPasscode(onSuccess) {
        if (!elUnlockModal) return;
        elUnlockModal.style.display = "flex";

        const input = document.getElementById("passcodeInput");
        const btnUnlock = document.getElementById("passcodeConfirm");
        const btnCancel = document.getElementById("passcodeCancel");
        const err = document.getElementById("passcodeError");
        const PASSCODE = "CHAOSQUEEN";

        function cleanup() {
          btnUnlock?.removeEventListener("click", onUnlock);
          btnCancel?.removeEventListener("click", onCancel);
        }

        function onCancel() {
          cleanup();
          elUnlockModal.style.display = "none";
          window.location.href = "group.html";
        }

        function onUnlock() {
          const val = (input?.value || "").trim();
          if (val !== PASSCODE) {
            if (err) err.style.display = "block";
            return;
          }
          if (err) err.style.display = "none";
          cleanup();
          elUnlockModal.style.display = "none";
          onSuccess();
        }

        btnUnlock?.addEventListener("click", onUnlock);
        btnCancel?.addEventListener("click", onCancel);
      }

      // Leadership routes
      if (role === "charge" || role === "charge1" || role === "charge2" || role === "rrt") {
        requireLeadershipPasscode(() => {
          authRole = role === "charge" ? "charge1" : role;
          showOnly(elLeadership);
          selectLeadership(authRole);
        });
        return;
      }

      // Student route requires ?group=1‚Äì6
      if (!groupId) {
        console.log('üî¥ No groupId in URL - showing role select');
        showOnly(elRoleSelect);
        return;
      }

      // Student view
      console.log('üü¢ Student route - groupId:', groupId);
      authRole = "student";
      showOnly(elStudent);
      const parsedGroupId = parseInt(groupId, 10);
      console.log('üü¢ Bootstrap calling selectGroup with:', parsedGroupId);
      console.log('üü¢ Before calling selectGroup, window.currentGroupId:', window.currentGroupId);
      
      if (typeof window.selectGroup !== 'function') {
        console.error('‚ùå window.selectGroup is NOT a function!');
        return;
      }
      
      selectGroup(parsedGroupId);
      console.log('üü¢ After selectGroup, window.currentGroupId:', window.currentGroupId);
    }

    // Helper functions for router
    function selectLeadership(role) {
      authRole = role;
      console.log('Leadership view activated:', role);
      // Leadership dashboard is already visible via showOnly
      // Initialize leadership-specific features if needed
      if (typeof setupEventAlerts === 'function') setupEventAlerts();
      if (typeof setupGroupCasesMonitor === 'function') setupGroupCasesMonitor();
      if (typeof setupErrorLog === 'function') setupErrorLog();
      if (typeof setupDebriefBoard === 'function') setupDebriefBoard(role);
    }

    function selectGroup(gid) {
      if (!gid || gid < 1 || gid > 6) {
        console.error('Invalid group ID:', gid);
        return;
      }
      groupId = gid;
      authRole = 'student';
      console.log('Student view activated for group:', gid);
      // Initialize student view - connect to Firebase for this group
      const groupRef = database.ref('groups/' + groupId);
      
      groupRef.child('stability').on('value', snap => {
        const val = typeof snap.val() === 'number' ? snap.val() : 100;
        updateStabilityDisplay(val);
      });

      // Listen for phase updates
      groupRef.child('phase').on('value', snap => {
        currentPhase = snap.val() || 'phase1';
        const wrapper = document.querySelector('.main-wrapper.group-activity-content');
        if (wrapper) {
          wrapper.querySelectorAll('.phase-banner').forEach(el => el.remove());
          renderPhaseBanner(wrapper, currentPhase);
        }
        applyPhaseLocks();
      });

      // Initial render
      const wrapper = document.querySelector('.main-wrapper.group-activity-content');
      if (wrapper) {
        wrapper.querySelectorAll('.phase-banner').forEach(el => el.remove());
        renderPhaseBanner(wrapper, currentPhase);
      }
      applyPhaseLocks();
      updateStabilityDisplay(100);

      // Setup Firebase sync for this group
      if (typeof setupFirebaseSync === 'function') {
        setupFirebaseSync(groupId);
      }
    }

    document.addEventListener('DOMContentLoaded', bootstrapFromParams);

    // Debug: Check if currentGroupId stays set
    setInterval(() => {
      if (window.currentGroupId) {
        console.log('‚úì window.currentGroupId is still:', window.currentGroupId);
      } else {
        console.warn('‚úó window.currentGroupId is', window.currentGroupId);
      }
    }, 3000);

    // -----------------------------
    // LEADERSHIP DASHBOARD FUNCTIONS
    // -----------------------------

    const lowStabilityAlerted = {};
    const criticalStreak = {};
    function setupAllGroupsMonitor(role) {
      const container = document.getElementById('allGroupsStability');
      const groupNames = ['Neuro', 'Psych', 'Pain', 'Inflam', 'Endo', 'Infection'];
      
      // Charge 1 sees groups 1-3, Charge 2 sees groups 4-6, RRT sees all
      let groupsToShow = [1, 2, 3, 4, 5, 6];
      if (role === 'charge1') {
        groupsToShow = [1, 2, 3];
      } else if (role === 'charge2') {
        groupsToShow = [4, 5, 6];
      }
      
      groupsToShow.forEach(i => {
        const groupRef = database.ref('groups/' + i + '/stability');
        const groupDiv = document.createElement('div');
        groupDiv.id = 'groupStability' + i;
        groupDiv.style.cssText = 'padding:15px;background:rgba(255,255,255,0.05);border-radius:12px;border:2px solid rgba(0,212,255,0.3);';
        groupDiv.innerHTML = `
          <div style="font-size:18px;font-weight:700;color:#00d4ff;margin-bottom:8px;">Group ${i}: ${groupNames[i-1]}</div>
          <div style="font-size:32px;font-weight:900;color:#00ffb3;" id="stabilityValue${i}">100</div>
          <div style="font-size:12px;color:#ccecff;margin-top:4px;">Patient Stability</div>
        `;
        container.appendChild(groupDiv);
        
        groupRef.on('value', snap => {
          const stability = snap.val() || 100;
          const valueEl = document.getElementById('stabilityValue' + i);
          const parentDiv = document.getElementById('groupStability' + i);
          if (valueEl) {
            valueEl.textContent = stability;
            valueEl.style.color = stability >= 75 ? '#00ffb3' : stability >= 50 ? '#ffb300' : '#ff006e';
            
            // Add pulsing animation for critical levels
            if (parentDiv) {
              parentDiv.classList.remove('stability-warning', 'stability-critical');
              if (stability < 25) {
                parentDiv.classList.add('stability-critical');
              } else if (stability < 50) {
                parentDiv.classList.add('stability-warning');
              }
            }
          }

          // Auto-alert when stability is concerning
          if (stability < 70 && !lowStabilityAlerted[i]) {
            lowStabilityAlerted[i] = true;
            pushAutoAlert(`Group ${i}: Stability ${stability}% ‚Äì check now`, 'critical', 'stabilityLow');
          }
          if (stability >= 75) {
            lowStabilityAlerted[i] = false;
          }
        });
      });
    }

    const alertCooldowns = { stabilityLow: 60000, criticalStreak: 120000, needRRT: 120000 };
    const lastAlertAt = { stabilityLow: 0, criticalStreak: 0, needRRT: 0 };

    function pushAutoAlert(message, level = 'warning', type = 'generic') {
      const list = document.getElementById('autoAlertsList');
      if (!list) return;
      const now = Date.now();
      if (type !== 'generic') {
        const last = lastAlertAt[type] || 0;
        const cd = alertCooldowns[type] || 60000;
        if (now - last < cd) return;
        lastAlertAt[type] = now;
      }
      if (list.dataset.empty === 'true') {
        list.innerHTML = '';
        delete list.dataset.empty;
      }
      const div = document.createElement('div');
      div.style.cssText = 'padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);font-size:13px;color:#ccecff;';
      if (level === 'critical') {
        div.style.borderColor = 'rgba(255,0,110,0.6)';
        div.style.background = 'rgba(255,0,110,0.12)';
        div.style.color = '#ff99c2';
      } else if (level === 'info') {
        div.style.borderColor = 'rgba(0,212,255,0.6)';
        div.style.background = 'rgba(0,212,255,0.08)';
        div.style.color = '#ccecff';
      }
      div.textContent = message;
      list.prepend(div);
    }

    const lastFollowUpByGroup = {};

    function setupEventAlerts(role) {
      const allowedGroups = role === 'charge1' ? [1,2,3] : role === 'charge2' ? [4,5,6] : [1,2,3,4,5,6];
      const eventsRef = database.ref('events').orderByChild('timestamp').limitToLast(100);

      eventsRef.on('child_added', snap => {
        const ev = snap.val();
        if (!ev || !allowedGroups.includes(ev.groupId)) return;

        if (ev && ev.groupId && ev.followUpReason) {
          lastFollowUpByGroup[ev.groupId] = ev.followUpReason;
        }

        // Critical streak detection
        if (!ev.isCorrect && ev.severity === 'critical') {
          criticalStreak[ev.groupId] = (criticalStreak[ev.groupId] || 0) + 1;
          if (criticalStreak[ev.groupId] >= 2) {
            pushAutoAlert(`Group ${ev.groupId}: 2 critical errors in a row`, 'critical', 'criticalStreak');
            criticalStreak[ev.groupId] = 0; // avoid spamming
          }
        } else if (ev.isCorrect) {
          criticalStreak[ev.groupId] = 0;
        }

        // Need RRT request
        if (ev.phase === 'chargeRequest' && ev.itemId === 'Need RRT') {
          pushAutoAlert(`Group ${ev.groupId}: NEED RRT requested`, 'critical', 'needRRT');
        }
      });
    }

    function setupErrorLog(role) {
      const container = document.getElementById('allGroupsErrors');
      const eventsRef = database.ref('events').orderByChild('timestamp').limitToLast(50);
      
      // Determine which groups this charge nurse oversees
      let allowedGroups = [1, 2, 3, 4, 5, 6];
      if (role === 'charge1') {
        allowedGroups = [1, 2, 3];
      } else if (role === 'charge2') {
        allowedGroups = [4, 5, 6];
      }
      
      eventsRef.on('child_added', snap => {
        const event = snap.val();
        // Only show errors for assigned groups
        if (!event.isCorrect && allowedGroups.includes(event.groupId)) {
          const div = document.createElement('div');
          div.style.cssText = 'padding:10px;margin-bottom:8px;background:rgba(255,255,255,0.05);border-radius:8px;border-left:4px solid #ff006e;';
          div.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <strong style="color:#ff99c2;">Group ${event.groupId} ‚Äì ${event.phase}</strong>
              <span style="font-size:11px;color:#ccecff;">${new Date(event.timestamp).toLocaleTimeString()}</span>
            </div>
            <div style="font-size:13px;color:#ccecff;">${event.explanation || 'Error recorded'}</div>
            ${event.followUpReason ? `<div style="font-size:12px;color:#ccecff;margin-top:4px;background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.3);padding:6px;border-radius:6px;">Follow-up consequence: ${event.followUpReason}</div>` : ''}
            <div style="font-size:12px;color:#ffb300;margin-top:4px;">Stability: ${event.delta}</div>
          `;
          container.prepend(div);
        }
      });
    }

    function setupGroupCasesMonitor(role) {
      const container = document.getElementById('groupCases');
      container.innerHTML = '<p style="color:#ccecff;font-size:14px;">Group case assignments will appear here during Jigsaw Speed Round.</p>';
      
      // Determine which groups this charge nurse oversees
      let groupsToMonitor = [1, 2, 3, 4, 5, 6];
      if (role === 'charge1') {
        groupsToMonitor = [1, 2, 3];
      } else if (role === 'charge2') {
        groupsToMonitor = [4, 5, 6];
      }
      
      // Monitor jigsaw cases for assigned groups only
      groupsToMonitor.forEach(i => {
        const caseRef = database.ref('jigsaw/group' + i + '/assignedCase');
        caseRef.on('value', snap => {
          const caseData = snap.val();
          if (caseData) {
            // Show case with approve/escalate buttons
            const caseDiv = document.createElement('div');
            caseDiv.style.cssText = 'padding:15px;margin-bottom:12px;background:rgba(255,255,255,0.05);border-radius:12px;border:2px solid rgba(0,212,255,0.3);';
            caseDiv.innerHTML = `
              <h4 style="color:#00d4ff;margin:0 0 10px 0;">Group ${i} ‚Äì ${caseData.system || 'System'}</h4>
              <div style="font-size:13px;color:#ccecff;margin-bottom:12px;">${caseData.title || 'Case assigned'}</div>
              ${caseData.followUpReason ? `<div style="margin:8px 0 12px 0;padding:10px;border-radius:8px;background:rgba(255,0,110,0.12);border:1px solid rgba(255,0,110,0.3);color:#ff99c2;font-size:12px;">Consequence context: ${caseData.followUpReason}</div>` : ''}
              
              <!-- STRICT GRADING RUBRIC (INCREASED DIFFICULTY) -->
              <div style="background:rgba(255,179,0,0.1);padding:12px;border-radius:8px;border-left:3px solid #ffb300;margin-bottom:12px;font-size:12px;color:#ffd27f;">
                <strong style="color:#ffb300;">‚ö†Ô∏è STRICT GRADING RUBRIC:</strong><br>
                <div style="margin-top:6px;line-height:1.6;">
                  ‚úì <strong>APPROVE</strong> only if group correctly identifies:<br>
                  <span style="margin-left:15px;">1) The condition (diagnosis/syndrome)</span><br>
                  <span style="margin-left:15px;">2) The correct FIRST action (specific intervention)</span><br>
                  <span style="margin-left:15px;">3) One key lab/monitoring OR teaching point</span><br>
                  <br>
                  ‚ö†Ô∏è <strong>ESCALATE</strong> if they miss ANY of the above or reasoning is incomplete/unsafe.
                </div>
              </div>
              
              <div style="display:flex;gap:10px;">
                <button class="assign-btn" onclick="approveAnswer(${i})" style="background:#00ffb3;">‚úì Approve</button>
                <button class="assign-btn" onclick="escalateAnswer(${i})" style="background:#ff006e;">‚ö† Escalate</button>
              </div>
            `;
            document.getElementById('groupCases').appendChild(caseDiv);
          }
        });
      });
    }

    // Leadership phase advancement controls
    function setGroupPhase(nextPhase) {
      const allowedRoles = ['charge', 'charge1', 'charge2', 'rrt'];
      if (!allowedRoles.includes(authRole)) {
        showFeedbackToast('Phase control is leadership-only', 'error');
        return;
      }
      const select = document.getElementById('phaseGroupSelect');
      const statusEl = document.getElementById('phaseControlStatus');
      const groupId = select ? parseInt(select.value, 10) : NaN;
      if (!groupId || groupId < 1 || groupId > 6) {
        if (statusEl) statusEl.textContent = 'Choose a valid group (1-6).';
        return;
      }
      database.ref('groups/' + groupId + '/phase').set(nextPhase).then(() => {
        if (statusEl) {
          statusEl.style.color = '#00ffb3';
          statusEl.textContent = `Group ${groupId} ‚Üí ${nextPhase.toUpperCase()} applied.`;
        }
        // Also sync the visible timer to match the selected phase for clarity
        try {
          const map = {
            phase1: { label: 'Warm-Up', minutes: 15 },
            phase2: { label: 'Expert Huddle', minutes: 20 },
            phase3: { label: 'Jigsaw', minutes: 25 }
          };
          const timerDefaults = map[nextPhase] || { label: 'Activity', minutes: 15 };
          if (typeof startPhaseTimer === 'function') {
            startPhaseTimer(timerDefaults.label, timerDefaults.minutes);
          }
        } catch (e) { /* no-op */ }
        showFeedbackToast(`Group ${groupId} advanced to ${nextPhase.toUpperCase()}`, 'success');
      }).catch(() => {
        if (statusEl) {
          statusEl.style.color = '#ff006e';
          statusEl.textContent = 'Failed to update phase. Check connection.';
        }
        showFeedbackToast('Failed to update phase', 'error');
      });
    }

    function setAllGroupsPhase(nextPhase) {
      const allowedRoles = ['charge', 'charge1', 'charge2', 'rrt'];
      if (!allowedRoles.includes(authRole)) {
        showFeedbackToast('Phase control is leadership-only', 'error');
        return;
      }
      const statusEl = document.getElementById('phaseControlStatus');
      const updates = [];
      for (let i = 1; i <= 6; i++) {
        updates.push(database.ref('groups/' + i + '/phase').set(nextPhase));
      }
      Promise.all(updates).then(() => {
        if (statusEl) {
          statusEl.style.color = '#00ffb3';
          statusEl.textContent = `All groups ‚Üí ${nextPhase.toUpperCase()} applied.`;
        }
        // Also sync the visible timer for leadership view to the selected phase
        try {
          const map = {
            phase1: { label: 'Warm-Up', minutes: 15 },
            phase2: { label: 'Expert Huddle', minutes: 20 },
            phase3: { label: 'Jigsaw', minutes: 25 }
          };
          const timerDefaults = map[nextPhase] || { label: 'Activity', minutes: 15 };
          if (typeof startPhaseTimer === 'function') {
            startPhaseTimer(timerDefaults.label, timerDefaults.minutes);
          }
        } catch (e) { /* no-op */ }
        showFeedbackToast(`All groups set to ${nextPhase.toUpperCase()}`, 'success');
      }).catch(() => {
        if (statusEl) {
          statusEl.style.color = '#ff006e';
          statusEl.textContent = 'Failed to update all groups.';
        }
        showFeedbackToast('Failed to update all groups', 'error');
      });
    }

    function setupDebriefBoard(role) {
      const container = document.getElementById('debriefGroups');
      const groupNames = {1: 'Neurological', 2: 'Psychopharmacology', 3: 'Pain', 4: 'Inflammation', 5: 'Endocrine', 6: 'Infection'};
      
      // Charge 1 gets groups 1-3, Charge 2 gets groups 4-6
      const assignedGroups = role === 'charge1' ? [1, 2, 3] : [4, 5, 6];
      
      assignedGroups.forEach(groupId => {
        const groupDiv = document.createElement('div');
        groupDiv.style.cssText = 'padding:15px;margin-bottom:15px;background:rgba(255,255,255,0.05);border-radius:12px;border:2px solid rgba(0,212,255,0.3);';
        
        groupDiv.innerHTML = `
          <h4 style="color:#00d4ff;margin:0 0 10px 0;">Group ${groupId}: ${groupNames[groupId]}</h4>
          <textarea 
            id="debrief${groupId}" 
            rows="4" 
            placeholder="What did this group do well? What challenges did they face? Key learning points..."
            style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:8px;padding:10px;color:#fff;font-family:inherit;font-size:13px;resize:vertical;"
          ></textarea>
          <div style="display:flex;gap:10px;margin-top:8px;align-items:center;">
            <button class="assign-btn" onclick="saveDebrief(${groupId})" style="background:#00ffb3;">üíæ Save</button>
            <span id="debriefStatus${groupId}" style="font-size:12px;color:#00ffb3;"></span>
          </div>
          <div id="reflectionDisplay${groupId}" style="margin-top:10px;padding:10px;border-radius:8px;background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.2);color:#ccecff;font-size:12px;">
            <strong style="color:#00d4ff;">Student Reflection</strong>
            <div class="reflection-body${groupId}" style="margin-top:6px;">
              <em style="color:#888;">No reflection submitted.</em>
            </div>
          </div>
        `;
        
        container.appendChild(groupDiv);
        
        // Load existing debrief if any
        const debriefRef = database.ref('debrief/group' + groupId);
        debriefRef.on('value', snap => {
          const data = snap.val();
          const textarea = document.getElementById('debrief' + groupId);
          if (data && data.content && textarea) {
            textarea.value = data.content;
          }
        });

        const reflectionRef = database.ref('reflections/group' + groupId);
        reflectionRef.on('value', snap => {
          const data = snap.val();
          const target = document.querySelector('.reflection-body' + groupId);
          if (!target) return;
          if (!data) {
            target.innerHTML = '<em style="color:#888;">No reflection submitted.</em>';
            return;
          }
          const latest = Object.values(data).sort((a,b) => (b.timestamp||0) - (a.timestamp||0))[0];
          target.innerHTML = `
            <div><strong>Near miss:</strong> ${latest.nearMiss || '‚Äî'}</div>
            <div><strong>Next time:</strong> ${latest.nextTime || '‚Äî'}</div>
            <div style="font-size:11px;color:#888;margin-top:4px;">Updated at ${latest.timestamp ? new Date(latest.timestamp).toLocaleTimeString() : ''}</div>
          `;
        });
      });
    }

    function saveDebrief(groupId) {
      const textarea = document.getElementById('debrief' + groupId);
      const status = document.getElementById('debriefStatus' + groupId);
      const content = textarea.value;
      
      if (!content.trim()) {
        status.style.color = '#ff99c2';
        status.textContent = 'Please enter some notes first';
        return;
      }
      
      database.ref('debrief/group' + groupId).set({
        content: content,
        chargeNurse: selectedRole,
        timestamp: Date.now()
      }).then(() => {
        status.style.color = '#00ffb3';
        status.textContent = '‚úì Saved';
        setTimeout(() => {
          status.textContent = '';
        }, 2000);
      }).catch(err => {
        status.style.color = '#ff006e';
        status.textContent = 'Error saving';
      });
    }

    // Structured escalation to Charge Nurse / RRT
    function sendChargeRequest() {
      if (!currentGroupId) {
        alert('Set your Group # first.');
        return;
      }

      const hypothesis = (document.getElementById('chargeHypothesis')?.value || '').trim();
      const because = (document.getElementById('chargeBecause')?.value || '').trim();
      const action = (document.getElementById('chargeAction')?.value || '').trim();
      const monitoring = (document.getElementById('chargeMonitoring')?.value || '').trim();
      const requestType = (document.getElementById('chargeRequestType')?.value || '').trim();

      if (!hypothesis || !because || !action || !monitoring || !requestType) {
        showFeedbackToast('Please complete all fields', 'warning');
        return;
      }

      const severity = requestType === 'Need RRT' ? 'critical' : 'moderate';
      const explanation = `We think it is ${hypothesis} because ${because}. First action: ${action}. Monitoring: ${monitoring}. Request: ${requestType}.`;

      // Log to events for instructor/charge visibility
      database.ref('events').push({
        groupId: currentGroupId,
        phase: 'chargeRequest',
        itemId: requestType,
        isCorrect: false,
        severity,
        explanation,
        timestamp: Date.now()
      });

      // Also send to charge nurse message stream for continuity
      const messageId = database.ref('messages/toChargeNurse').push().key;
      database.ref('messages/toChargeNurse/' + messageId).set({
        from: 'Group ' + currentGroupId,
        groupNumber: currentGroupId,
        message: explanation,
        requestType,
        severity,
        timestamp: Date.now(),
        read: false,
        conversationId: 'group' + currentGroupId + '_' + Date.now(),
        responses: {}
      });

      showFeedbackToast('Request sent to Charge Nurse', 'success');
      showConversationHistory();
    }

    // Student reflections (Phase 3)
    function submitReflection() {
      if (!currentGroupId) {
        showFeedbackToast('Set your Group # first.', 'error');
        return;
      }
      const nearMiss = (document.getElementById('reflectionNearMiss')?.value || '').trim();
      const nextTime = (document.getElementById('reflectionNextTime')?.value || '').trim();
      const status = document.getElementById('reflectionStatus');
      if (!nearMiss || !nextTime) {
        if (status) {
          status.style.color = '#ff99c2';
          status.textContent = 'Please answer both reflection prompts.';
        }
        return;
      }

      const entry = {
        groupId: currentGroupId,
        nearMiss,
        nextTime,
        timestamp: Date.now()
      };

      database.ref('reflections/group' + currentGroupId).push(entry).then(() => {
        if (status) {
          status.style.color = '#00ffb3';
          status.textContent = 'Reflection submitted.';
        }
        showFeedbackToast('Reflection submitted', 'success');
        setTimeout(() => { if (status) status.textContent = ''; }, 2500);
      }).catch(() => {
        if (status) {
          status.style.color = '#ff006e';
          status.textContent = 'Could not submit reflection.';
        }
        showFeedbackToast('Failed to submit reflection', 'error');
      });
    }
    
    function showConversationHistory() {
      const currentGroupId = window.currentGroupId;
      const database = window.database;
      if (!currentGroupId) return;
      
      const historySection = document.getElementById('conversationHistory');
      const messagesContainer = document.getElementById('conversationMessages');
      
      if (historySection) historySection.style.display = 'block';
      if (!messagesContainer) return;
      
      // Listen for messages and responses
      database.ref('messages/toChargeNurse').orderByChild('groupNumber').equalTo(currentGroupId).on('value', snap => {
        messagesContainer.innerHTML = '';
        const messages = [];
        
        snap.forEach(msgSnap => {
          messages.push({ key: msgSnap.key, ...msgSnap.val() });
        });
        
        messages.sort((a, b) => a.timestamp - b.timestamp);
        
        messages.forEach(msg => {
          const time = new Date(msg.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
          
          // Student message
          const msgDiv = document.createElement('div');
          msgDiv.style.cssText = 'padding:10px;margin-bottom:8px;background:rgba(0,212,255,0.1);border-radius:8px;border-left:3px solid #00d4ff;';
          msgDiv.innerHTML = `
            <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
              <strong style="color:#00ffb3;font-size:12px;">You</strong>
              <span style="color:#888;font-size:11px;">${time}</span>
            </div>
            <div style="color:#fff;font-size:13px;">${msg.message}</div>
          `;
          messagesContainer.appendChild(msgDiv);
          
          // Charge nurse responses
          if (msg.responses) {
            Object.values(msg.responses).forEach(response => {
              const respTime = new Date(response.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
              const respDiv = document.createElement('div');
              respDiv.style.cssText = 'padding:10px;margin:8px 0 8px 20px;background:rgba(138,43,226,0.15);border-radius:8px;border-left:3px solid #8a2be2;';
              
              const actionColors = {
                'approved_excellent': '#00ff88',
                'approved': '#00ffb3',
                'approved_caution': '#88d400',
                'escalated': '#ff8c00',
                'rrt': '#ff4444'
              };
              
              const actionLabels = {
                'approved_excellent': '‚≠ê APPROVED - EXCELLENT (+15)',
                'approved': '‚úÖ APPROVED - ADEQUATE (+10)',
                'approved_caution': '‚ö†Ô∏è APPROVED WITH CAUTION (+5)',
                'escalated': '‚ö†Ô∏è ESCALATED - RETRY (-15)',
                'rrt': 'üö® ESCALATED + RRT CALLED (-25)'
              };
              
              const escalationContext = (response.action === 'escalated' || response.action === 'rrt') && lastFollowUpByGroup[msg.groupNumber]
                ? `<div style="margin-top:6px;padding:6px 10px;background:rgba(255,0,110,0.12);border:1px solid rgba(255,0,110,0.3);border-radius:6px;font-size:11px;color:#ff99c2;">Prior consequence context: ${lastFollowUpByGroup[msg.groupNumber]}</div>`
                : '';

              respDiv.innerHTML = `
                <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                  <strong style="color:#ba55d3;font-size:12px;">Charge Nurse</strong>
                  <span style="color:#888;font-size:11px;">${respTime}</span>
                </div>
                <div style="color:#fff;font-size:13px;">${response.message}</div>
                ${response.action ? `<div style="margin-top:6px;padding:6px 10px;background:rgba(0,0,0,0.3);border-radius:6px;font-size:11px;font-weight:600;color:${actionColors[response.action] || '#ccc'};">
                  ${actionLabels[response.action] || response.action.toUpperCase()}
                </div>` : ''}
                ${escalationContext}
              `;
              messagesContainer.appendChild(respDiv);
            });
          }
        });
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });
    }
    
    // Setup message listener for Charge Nurses
    function setupChargeNurseMessages(role) {
      const container = document.getElementById('chargeNurseMessages');
      if (!container) return;
      
      // Determine which groups this charge nurse monitors
      const myGroups = role === 'charge1' ? [1, 2, 3] : [4, 5, 6];
      
      database.ref('messages/toChargeNurse').on('value', snap => {
        container.innerHTML = '';
        const messages = [];
        
        snap.forEach(msgSnap => {
          const msg = msgSnap.val();
          if (myGroups.includes(msg.groupNumber)) {
            messages.push({ key: msgSnap.key, ...msg });
          }
        });
        
        if (messages.length === 0) {
          container.innerHTML = '<div style="color:#888;text-align:center;padding:20px;">No messages yet</div>';
          return;
        }
        
        messages.sort((a, b) => b.timestamp - a.timestamp);
        
        messages.forEach(msg => {
          const time = new Date(msg.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
          const msgDiv = document.createElement('div');
          
          const responseCount = msg.responses ? Object.keys(msg.responses).length : 0;
          const hasResponded = responseCount > 0;
          
          msgDiv.style.cssText = `padding:15px;margin-bottom:12px;background:${hasResponded ? 'rgba(0,212,255,0.08)' : 'rgba(138,43,226,0.15)'};border-radius:10px;border-left:4px solid ${hasResponded ? '#00d4ff' : '#8a2be2'};`;
          
          let conversationHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <strong style="color:#00ffb3;font-size:15px;">${msg.from}</strong>
              <span style="color:#888;font-size:11px;">${time}</span>
            </div>
            <div style="color:#fff;font-size:14px;margin-bottom:12px;padding:10px;background:rgba(0,0,0,0.3);border-radius:6px;">${msg.message}</div>
          `;
          
          // Show previous responses
          if (msg.responses) {
            conversationHTML += '<div style="margin-bottom:12px;padding-left:10px;border-left:2px solid rgba(138,43,226,0.3);">';
            Object.values(msg.responses).forEach(resp => {
              const respTime = new Date(resp.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
              conversationHTML += `
                <div style="margin-bottom:8px;padding:8px;background:rgba(186,85,211,0.1);border-radius:6px;">
                  <div style="font-size:11px;color:#ba55d3;margin-bottom:4px;">You responded (${respTime}):</div>
                  <div style="font-size:13px;color:#ddd;">${resp.message}</div>
                  ${resp.action ? `<div style="margin-top:4px;font-size:11px;color:${resp.action === 'approved' ? '#00ffb3' : '#ff6b6b'};">
                    ${resp.action === 'approved' ? '‚úÖ APPROVED' : resp.action === 'escalated' ? '‚ö†Ô∏è ESCALATED' : 'üö® ESCALATED + RRT'}
                  </div>` : ''}
                </div>
              `;
            });
            conversationHTML += '</div>';
          }
          
          // Response input
          conversationHTML += `
            <div style="margin-top:12px;">
              <div style="margin-bottom:10px;padding:10px;background:rgba(255,140,0,0.08);border-radius:6px;border-left:3px solid #ffb300;">
                <div style="font-size:11px;color:#ffb300;font-weight:600;margin-bottom:6px;">üí° SUGGESTED GUIDING QUESTIONS (Don't give direct answers!):</div>
                <div style="font-size:11px;color:#ddd;line-height:1.5;">
                  ‚Ä¢ "What will kill this patient FIRST?"<br>
                  ‚Ä¢ "What medication/condition triggered this?"<br>
                  ‚Ä¢ "What vital sign trend tells you this is urgent?"<br>
                  ‚Ä¢ "What's your FIRST nursing action?"<br>
                  ‚Ä¢ "Who do you call? Provider? RRT? No one?"<br>
                  ‚Ä¢ "What lab would confirm your suspicion?"<br>
                  ‚Ä¢ "Which order would you question?"
                </div>
              </div>
              
              <input type="text" id="response_${msg.key}" placeholder="Ask Socratic questions or provide cryptic guidance..." 
                style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:8px;padding:10px;color:#fff;font-family:inherit;font-size:13px;margin-bottom:10px;" />
              
              <div style="margin-bottom:8px;font-size:12px;color:#00ffb3;font-weight:600;">Actions:</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
                <button onclick="respondToMessage('${msg.key}', ${msg.groupNumber}, 'question')" class="assign-btn" style="font-size:12px;padding:8px 14px;background:#ffb300;">‚ùì Ask Question</button>
                <button onclick="respondToMessage('${msg.key}', ${msg.groupNumber}, 'approved_excellent')" class="assign-btn" style="font-size:12px;padding:8px 14px;background:#00ff88;">‚≠ê Approve - Excellent</button>
                <button onclick="respondToMessage('${msg.key}', ${msg.groupNumber}, 'approved')" class="assign-btn" style="font-size:12px;padding:8px 14px;background:#00d4a0;">‚úÖ Approve - Adequate</button>
                <button onclick="respondToMessage('${msg.key}', ${msg.groupNumber}, 'approved_caution')" class="assign-btn" style="font-size:12px;padding:8px 14px;background:#88d400;">‚ö†Ô∏è Approve w/ Caution</button>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button onclick="respondToMessage('${msg.key}', ${msg.groupNumber}, 'escalated')" class="assign-btn" style="font-size:12px;padding:8px 14px;background:#ff8c00;">‚ö†Ô∏è Escalate - Retry</button>
                <button onclick="respondToMessage('${msg.key}', ${msg.groupNumber}, 'rrt')" class="assign-btn" style="font-size:12px;padding:8px 14px;background:#ff4444;">üö® Escalate + RRT</button>
              </div>
              <div style="margin-top:8px;font-size:10px;color:#888;line-height:1.4;">
                <strong>Require all 3:</strong> Condition ID + First Action + Monitoring | 
                <strong>Excellent:</strong> +15 stability | <strong>Adequate:</strong> +10 | <strong>Caution:</strong> +5 | 
                <strong>Escalate:</strong> -15 | <strong>RRT:</strong> -25
              </div>
            </div>
          `;
          
          msgDiv.innerHTML = conversationHTML;
          container.appendChild(msgDiv);
        });
      });
    }
    
    function respondToMessage(messageKey, groupNumber, action) {
      const input = document.getElementById('response_' + messageKey);
      const response = input?.value?.trim() || '';
      
      if (!response && action === 'question') {
        alert('Please enter a Socratic question to guide the group (avoid direct answers)');
        return;
      }
      
      const actionMessages = {
        'question': response,
        'approved_excellent': response || '‚≠ê Exceptional clinical reasoning! All 3 components met. Condition identified, priority action correct, monitoring plan solid. Proceed with confidence.',
        'approved': response || '‚úÖ Good clinical reasoning. All required components present. Approved to proceed.',
        'approved_caution': response || '‚ö†Ô∏è Reasoning is acceptable but could be stronger. Review your monitoring plan. Approved with caution.',
        'escalated': response || '‚ö†Ô∏è Missing critical components or unsafe assumptions. Review and resubmit with: Condition + First Action + Monitoring.',
        'rrt': response || 'üö® UNSAFE clinical judgment detected. RRT has been called. Review chain of command and clinical priorities.'
      };
      
      const stabilityChanges = {
        'approved_excellent': 15,
        'approved': 10,
        'approved_caution': 5,
        'escalated': -15,
        'rrt': -25
      };
      
      // Save response
      const responseId = database.ref('messages/toChargeNurse/' + messageKey + '/responses').push().key;
      database.ref('messages/toChargeNurse/' + messageKey + '/responses/' + responseId).set({
        message: actionMessages[action],
        action: action !== 'question' ? action : null,
        timestamp: Date.now(),
        by: selectedRole
      });
      
      // Take action based on response
      if (action !== 'question') {
        // Update stability
        const stabilityChange = stabilityChanges[action] || 0;
        database.ref('groups/' + groupNumber + '/stability').once('value').then(snap => {
          const current = snap.val() || 50;
          const newStability = Math.max(0, Math.min(100, current + stabilityChange));
          database.ref('groups/' + groupNumber + '/stability').set(newStability);
        });
        
        // Log appropriate event
        if (action.startsWith('approved')) {
          database.ref('events').push({
            group: groupNumber,
            type: action === 'approved_excellent' ? 'approved_excellent' : action === 'approved_caution' ? 'approved_caution' : 'approved',
            message: action === 'approved_excellent' ? 'Charge Nurse: Exceptional reasoning (+15)' : 
                     action === 'approved_caution' ? 'Charge Nurse: Approved with caution (+5)' :
                     'Charge Nurse: Approved clinical reasoning (+10)',
            timestamp: Date.now()
          });
        } else if (action === 'escalated') {
          database.ref('events').push({
            group: groupNumber,
            type: 'escalated',
            message: 'Charge Nurse: Missing components or unsafe reasoning (-15)',
            timestamp: Date.now()
          });
        } else if (action === 'rrt') {
          database.ref('groups/' + groupNumber + '/rrtCalled').set(true);
          database.ref('rrt/calls').push({
            group: groupNumber,
            reason: 'Unsafe clinical judgment - Charge Nurse escalation',
            calledBy: selectedRole,
            timestamp: Date.now(),
            resolved: false
          });
          database.ref('events').push({
            group: groupNumber,
            type: 'rrt_called',
            message: 'RRT called by Charge Nurse: Dangerous reasoning detected (-25)',
            timestamp: Date.now()
          });
        }
      }
      
      input.value = '';
    }
    
    function markMessageRead(messageKey) {
      database.ref('messages/toChargeNurse/' + messageKey).update({ read: true });
      event.target.closest('div').style.opacity = '0.5';
      event.target.remove();
    }
    
    
    // Remove old chat listener (no longer used)
    function setupChatListener() {
      // Disabled - chat feature removed
    }
    
    // Chat input - send on Enter key (disabled)
    document.addEventListener('DOMContentLoaded', () => {
      // Chat feature removed
    });

    function setupRRTListener() {
      const container = document.getElementById('activeCalls');
      const interventionsSection = document.getElementById('rrtInterventions');
      const interventionOptions = document.getElementById('interventionOptions');
      const rrtRef = database.ref('rrt/calls');
      
      rrtRef.on('child_added', snap => {
        const call = snap.val();
        const callDiv = document.createElement('div');
        callDiv.id = 'rrtCall' + snap.key;
        callDiv.style.cssText = 'padding:20px;margin-bottom:12px;background:rgba(255,0,110,0.1);border-radius:12px;border:2px solid #ff006e;animation:pulse 2s infinite;';
        callDiv.innerHTML = `
          <h4 style="color:#ff006e;margin:0 0 15px 0;">üö® RRT CALL: Group ${call.groupId}</h4>
          
          <div style="background:rgba(0,0,0,0.3);padding:15px;border-radius:8px;margin-bottom:15px;">
            <h5 style="color:#00ffb3;margin:0 0 10px 0;">SBAR Report from ${call.calledBy || 'Charge Nurse'}</h5>
            
            <div style="margin-bottom:8px;">
              <strong style="color:#00d4ff;">Situation:</strong>
              <p style="margin:4px 0;color:#ccecff;font-size:13px;">${call.sbar.situation || 'Not provided'}</p>
            </div>
            
            <div style="margin-bottom:8px;">
              <strong style="color:#00d4ff;">Background:</strong>
              <p style="margin:4px 0;color:#ccecff;font-size:13px;">${call.sbar.background || 'Not provided'}</p>
            </div>
            
            <div style="margin-bottom:8px;">
              <strong style="color:#00d4ff;">Assessment:</strong>
              <p style="margin:4px 0;color:#ccecff;font-size:13px;">${call.sbar.assessment || 'Not provided'}</p>
            </div>
            
            <div>
              <strong style="color:#00d4ff;">Recommendation:</strong>
              <p style="margin:4px 0;color:#ccecff;font-size:13px;">${call.sbar.recommendation || 'Not provided'}</p>
            </div>
          </div>
          
          <div style="font-size:14px;color:#ffb300;font-weight:600;">Patient Stability: ${call.stability || 'Unknown'}</div>
        `;
        container.innerHTML = '';
        container.appendChild(callDiv);
        
        // Show intervention options
        interventionsSection.style.display = 'block';
        interventionOptions.innerHTML = `
          <div class="role-option" onclick="applyIntervention(${call.groupId}, '${snap.key}', 'stabilize', 30)">
            <div style="font-size:36px;margin-bottom:8px;">üíâ</div>
            <div style="font-size:16px;font-weight:700;color:#00ffb3;margin-bottom:5px;">Stabilize Patient</div>
            <div style="font-size:12px;color:#b8e0ff;">+30 stability</div>
          </div>
          
          <div class="role-option" onclick="applyIntervention(${call.groupId}, '${snap.key}', 'medication', 20)">
            <div style="font-size:36px;margin-bottom:8px;">üíä</div>
            <div style="font-size:16px;font-weight:700;color:#00ffb3;margin-bottom:5px;">Administer Medication</div>
            <div style="font-size:12px;color:#b8e0ff;">+20 stability</div>
          </div>
          
          <div class="role-option" onclick="applyIntervention(${call.groupId}, '${snap.key}', 'oxygen', 15)">
            <div style="font-size:36px;margin-bottom:8px;">üòÆ‚Äçüí®</div>
            <div style="font-size:16px;font-weight:700;color:#00ffb3;margin-bottom:5px;">Oxygen Support</div>
            <div style="font-size:12px;color:#b8e0ff;">+15 stability</div>
          </div>
          
          <div class="role-option" onclick="applyIntervention(${call.groupId}, '${snap.key}', 'monitoring', 10)">
            <div style="font-size:36px;margin-bottom:8px;">üìä</div>
            <div style="font-size:16px;font-weight:700;color:#00ffb3;margin-bottom:5px;">Enhanced Monitoring</div>
            <div style="font-size:12px;color:#b8e0ff;">+10 stability</div>
          </div>
        `;
      });
      
      rrtRef.on('child_removed', () => {
        container.innerHTML = '<p style="color:#ccecff;font-size:14px;">No active calls. Standby for charge nurse alerts.</p>';
        interventionsSection.style.display = 'none';
      });
    }

    let currentRRTGroup = null;

    function openRRTReport(groupId) {
      currentRRTGroup = groupId;
      const groupNames = {1: 'Neurological', 2: 'Psychopharmacology', 3: 'Pain', 4: 'Inflammation', 5: 'Endocrine', 6: 'Infection'};
      document.getElementById('sbarGroupInfo').textContent = `Group ${groupId}: ${groupNames[groupId]}`;
      document.getElementById('sbarModal').style.display = 'block';
    }

    function closeSBARModal() {
      document.getElementById('sbarModal').style.display = 'none';
      document.getElementById('sbarSituation').value = '';
      document.getElementById('sbarBackground').value = '';
      document.getElementById('sbarAssessment').value = '';
      document.getElementById('sbarRecommendation').value = '';
      currentRRTGroup = null;
    }

    function submitRRTCall() {
      const situation = document.getElementById('sbarSituation').value;
      const background = document.getElementById('sbarBackground').value;
      const assessment = document.getElementById('sbarAssessment').value;
      const recommendation = document.getElementById('sbarRecommendation').value;

      if (!situation || !background || !assessment || !recommendation) {
        alert('Please complete all SBAR fields before calling RRT.');
        return;
      }

      const rrtRef = database.ref('rrt/calls').push();
      const groupRef = database.ref('groups/' + currentRRTGroup + '/stability');
      
      groupRef.once('value').then(snap => {
        const stability = snap.val() || 100;
        rrtRef.set({
          groupId: currentRRTGroup,
          stability: stability,
          timestamp: Date.now(),
          calledBy: selectedRole,
          sbar: {
            situation: situation,
            background: background,
            assessment: assessment,
            recommendation: recommendation
          }
        });
        
        closeSBARModal();
        alert(`RRT called to Group ${currentRRTGroup}. Rapid Response RN has been notified with your SBAR report.`);
      });
    }

    function applyIntervention(groupId, callKey, interventionType, stabilityBoost) {
      const groupRef = database.ref('groups/' + groupId + '/stability');
      const callRef = database.ref('rrt/calls/' + callKey);
      
      // Get call data for metrics
      callRef.once('value').then(callSnap => {
        const callData = callSnap.val();
        const responseTime = Date.now() - callData.timestamp;
        const stabilityBefore = callData.stability || 0;
        
        groupRef.transaction(current => {
          const newStability = (current || 0) + stabilityBoost;
          
          // INCREASED DIFFICULTY: Cap RRT recovery for critically ill patients
          // If patient was critical (<50), they can't jump straight to 100
          // Cap at 50-80 range to maintain "rescued but still sick" state
          if (stabilityBefore < 50) {
            // Critical patients max out at 80 even with intervention
            return Math.min(80, Math.max(50, newStability));
          } else {
            // Non-critical patients can recover more fully
            return Math.min(100, newStability);
          }
        }).then((result) => {
          const stabilityAfter = result.snapshot.val();
          
          // Remove the call
          callRef.remove();
          
          // Log intervention with metrics
          database.ref('events').push({
            groupId: groupId,
            phase: 'rrt-intervention',
            isCorrect: true,
            delta: stabilityBoost,
            explanation: `RRT applied ${interventionType} intervention`,
            timestamp: Date.now()
          });
          
          // Store RRT metrics
          database.ref('rrt/metrics').push({
            groupId: groupId,
            interventionType: interventionType,
            stabilityBefore: stabilityBefore,
            stabilityAfter: stabilityAfter,
            stabilityGain: stabilityBoost,
            responseTimeMs: responseTime,
            timestamp: Date.now()
          });
          
          alert(`Intervention applied to Group ${groupId}! ${interventionType.toUpperCase()}: +${stabilityBoost} stability.`);
          
          // Show reflection prompt to the group
          showReflectionPrompt(groupId, interventionType, stabilityBefore, stabilityAfter);
        });
      });
    }
    
    function showReflectionPrompt(groupId, interventionType, stabilityBefore, stabilityAfter) {
      // Only show to the affected group
      if (selectedGroupNumber === groupId) {
        const reflectionDiv = document.createElement('div');
        reflectionDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#0a1128,#1e3a5f);padding:30px;border-radius:20px;border:3px solid #00d4ff;z-index:10000;max-width:600px;box-shadow:0 20px 60px rgba(0,212,255,0.4);';
        reflectionDiv.innerHTML = `
          <h3 style="color:#00ffb3;margin:0 0 20px 0;text-align:center;">ü§î Reflection Moment</h3>
          <div style="background:rgba(255,179,0,0.1);padding:15px;border-radius:10px;margin-bottom:20px;border-left:4px solid #ffb300;">
            <div style="color:#ffb300;font-weight:600;margin-bottom:8px;">RRT just intervened with ${interventionType}</div>
            <div style="color:#ccecff;font-size:13px;">Patient stability: ${stabilityBefore} ‚Üí ${stabilityAfter}</div>
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="display:block;color:#00d4ff;font-weight:600;margin-bottom:8px;">Why did your patient's stability drop?</label>
            <textarea id="reflectionWhy" style="width:100%;height:60px;background:rgba(255,255,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:8px;padding:10px;color:#fff;font-family:inherit;resize:vertical;" placeholder="Consider errors made, timing, medications..."></textarea>
          </div>
          
          <div style="margin-bottom:20px;">
            <label style="display:block;color:#00d4ff;font-weight:600;margin-bottom:8px;">What could your team do differently to prevent this next time?</label>
            <textarea id="reflectionPrevent" style="width:100%;height:60px;background:rgba(255,255,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:8px;padding:10px;color:#fff;font-family:inherit;resize:vertical;" placeholder="Think about safety checks, communication, prioritization..."></textarea>
          </div>
          
          <div style="display:flex;gap:10px;justify-content:center;">
            <button onclick="submitReflection(${groupId})" class="assign-btn" style="background:#00ffb3;">Submit Reflection</button>
            <button onclick="closeReflection()" class="assign-btn" style="background:#888;">Skip</button>
          </div>
        `;
        
        const overlay = document.createElement('div');
        overlay.id = 'reflectionOverlay';
        overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;';
        overlay.appendChild(reflectionDiv);
        document.body.appendChild(overlay);
      }
    }
    
    function submitReflection(groupId) {
      const why = document.getElementById('reflectionWhy').value;
      const prevent = document.getElementById('reflectionPrevent').value;
      
      if (why && prevent) {
        database.ref('reflections').push({
          groupId: groupId,
          why: why,
          prevent: prevent,
          timestamp: Date.now()
        });
        
        alert('‚úì Great reflection! These insights will help improve patient safety.');
      }
      
      closeReflection();
    }
    
    function closeReflection() {
      const overlay = document.getElementById('reflectionOverlay');
      if (overlay) {
        overlay.remove();
      }
    }

    function approveAnswer(groupId) {
      database.ref('groups/' + groupId + '/approval').set({
        status: 'approved',
        by: selectedRole,
        timestamp: Date.now()
      });
      alert(`Group ${groupId} answer approved!`);
    }

    function escalateAnswer(groupId) {
      database.ref('groups/' + groupId + '/approval').set({
        status: 'escalated',
        by: selectedRole,
        timestamp: Date.now()
      });
      alert(`Group ${groupId} case escalated for review.`);
    }

    // -----------------------------
    // PAGE LOAD: CHECK EXISTING ROLE
    // -----------------------------
    
    // Store pending selection
    let pendingRole = null;
    let pendingGroup = null;
    
    window.confirmContinue = function() {
      console.log('confirmContinue called - pendingRole:', pendingRole, 'pendingGroup:', pendingGroup);
      if (pendingRole) {
        window.selectLeadership(pendingRole);
      } else if (pendingGroup) {
        window.selectGroup(pendingGroup);
      }
    };
    
    window.chooseDifferent = function() {
      console.log('chooseDifferent disabled - roles are locked after selection');
      // Role changes disabled
    };
    
    window.returnToHome = function() {
      console.log('returnToHome called');
      // Clear saved data
      try {
        localStorage.removeItem('pharmBlitzRole');
        localStorage.removeItem('pharmBlitzGroupId');
      } catch (e) {}
      // Reload page to show role selection
      window.location.href = 'group.html';
    };
    
    window.resetGame = function() {
      if (!confirm('‚ö†Ô∏è Reset all game data? This will clear all groups, events, flashcards, and progress. This action cannot be undone!')) {
        return;
      }
      
      console.log('resetGame called - clearing all Firebase data');
      
      // Clear all Firebase data
      const resetPromises = [
        database.ref('groups').remove(),
        database.ref('events').remove(),
        database.ref('flashcards').remove(),
        database.ref('jigsaw').remove(),
        database.ref('debrief').remove(),
        database.ref('leadership').remove(),
        database.ref('rrt/calls').remove(),
        database.ref('timer').remove(),
        database.ref('chat').remove(),
        database.ref('messages').remove(),
        database.ref('reflections').remove(),
        database.ref('rrt/metrics').remove()
      ];
      
      Promise.all(resetPromises).then(() => {
        console.log('All Firebase data cleared');
        alert('‚úÖ Game reset complete! Returning to home screen...');
        // Clear localStorage and return to home
        try {
          localStorage.removeItem('pharmBlitzRole');
          localStorage.removeItem('pharmBlitzGroupId');
        } catch (e) {}
        window.location.href = 'group.html';
      }).catch(err => {
        console.error('Error resetting game:', err);
        alert('‚ùå Error resetting game. Please try again.');
      });
    };
    
    // Check which leadership roles are already claimed
    // TEMPORARILY DISABLED FOR TESTING
    /*
    (function checkLeadershipAvailability() {
      // Wait a moment for Firebase to be ready
      setTimeout(() => {
        const leadershipRef = database.ref('leadership');
        leadershipRef.once('value').then(snapshot => {
          const leadership = snapshot.val() || {};
          
          // Only disable if explicitly claimed with timestamp in last hour
          const oneHourAgo = Date.now() - (60 * 60 * 1000);
          
          if (leadership.charge1 && leadership.charge1.claimed && leadership.charge1.timestamp > oneHourAgo) {
            const el = document.getElementById('charge1Option');
            if (el) el.classList.add('disabled');
          }
          if (leadership.charge2 && leadership.charge2.claimed && leadership.charge2.timestamp > oneHourAgo) {
            const el = document.getElementById('charge2Option');
            if (el) el.classList.add('disabled');
          }
          if (leadership.rrt && leadership.rrt.claimed && leadership.rrt.timestamp > oneHourAgo) {
            const el = document.getElementById('rrtOption');
            if (el) el.classList.add('disabled');
          }
        }).catch(err => {
          console.log('Leadership check failed:', err);
        });
      }, 500);
    })();
    */
    
    // -----------------------------
    // PHASE TIMER SYSTEM
    // -----------------------------
    let timerInterval = null;
    let currentPhaseEndTime = null;

    function startPhaseTimer(phaseName, durationMinutes) {
      const timerDisplay = document.getElementById('phaseTimer');
      const phaseNameDisplay = document.getElementById('phaseNameDisplay');
      const timeRemaining = document.getElementById('timeRemaining');
      
      if (!timerDisplay || !phaseNameDisplay || !timeRemaining) return;
      
      // Show timer
      timerDisplay.style.display = 'block';
      phaseNameDisplay.textContent = phaseName;
      
      // Calculate end time
      currentPhaseEndTime = Date.now() + (durationMinutes * 60 * 1000);
      
      // Save to Firebase so all groups see same timer
      database.ref('timer').set({
        phase: phaseName,
        endTime: currentPhaseEndTime,
        duration: durationMinutes
      });
      
      // Clear existing interval
      if (timerInterval) clearInterval(timerInterval);
      
      // Update timer display every second
      timerInterval = setInterval(() => {
        const now = Date.now();
        const remaining = currentPhaseEndTime - now;
        
        if (remaining <= 0) {
          clearInterval(timerInterval);
          timeRemaining.textContent = '0:00';
          timeRemaining.style.color = '#ff006e';
          
          // Flash the timer
          timerDisplay.style.animation = 'pulse-critical 0.5s ease-in-out 3';
          
          // Optionally auto-advance or notify
          setTimeout(() => {
            timerDisplay.style.animation = '';
          }, 1500);
        } else {
          const minutes = Math.floor(remaining / 60000);
          const seconds = Math.floor((remaining % 60000) / 1000);
          timeRemaining.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          
          // Color coding based on time remaining
          if (remaining < 60000) { // < 1 minute
            timeRemaining.style.color = '#ff006e';
          } else if (remaining < 180000) { // < 3 minutes
            timeRemaining.style.color = '#ffb300';
          } else {
            timeRemaining.style.color = '#ffffff';
          }
        }
      }, 1000);
    }

    function stopPhaseTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      const timerDisplay = document.getElementById('phaseTimer');
      if (timerDisplay) {
        timerDisplay.style.display = 'none';
      }
    }

    // Listen for timer updates from Firebase (instructor controlled)
    database.ref('timer').on('value', snap => {
      const timerData = snap.val();
      if (timerData && timerData.endTime) {
        const timerDisplay = document.getElementById('phaseTimer');
        const phaseNameDisplay = document.getElementById('phaseNameDisplay');
        const timeRemaining = document.getElementById('timeRemaining');
        
        if (!timerDisplay || !selectedGroupNumber) return; // Only show for active groups
        
        timerDisplay.style.display = 'block';
        phaseNameDisplay.textContent = timerData.phase || 'Activity';
        currentPhaseEndTime = timerData.endTime;
        
        // Start the display update if not already running
        if (!timerInterval) {
          timerInterval = setInterval(() => {
            const now = Date.now();
            const remaining = currentPhaseEndTime - now;
            
            if (remaining <= 0) {
              clearInterval(timerInterval);
              timerInterval = null;
              timeRemaining.textContent = '0:00';
              timeRemaining.style.color = '#ff006e';
              timerDisplay.style.animation = 'pulse-critical 0.5s ease-in-out 3';
              setTimeout(() => timerDisplay.style.animation = '', 1500);
            } else {
              const minutes = Math.floor(remaining / 60000);
              const seconds = Math.floor((remaining % 60000) / 1000);
              timeRemaining.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
              
              if (remaining < 60000) {
                timeRemaining.style.color = '#ff006e';
              } else if (remaining < 180000) {
                timeRemaining.style.color = '#ffb300';
              } else {
                timeRemaining.style.color = '#ffffff';
              }
            }
          }, 1000);
        }
      } else {
        // Timer cleared/stopped
        stopPhaseTimer();
      }
    });
    
    // Handle URL parameters and localStorage
    // DISABLED: bootstrapFromParams handles this now
    /*
    (function checkExistingGroup() {
      console.log('=== checkExistingGroup running ===');
      console.log('window.selectLeadership available?', typeof window.selectLeadership);
      console.log('window.selectGroup available?', typeof window.selectGroup);
      
      try {
        const urlParams = new URLSearchParams(window.location.search);
        console.log('URL search params:', window.location.search);
        
        const roleNames = {
          charge1: 'Charge Nurse 1',
          charge2: 'Charge Nurse 2',
          rrt: 'Rapid Response RN'
        };
        
        // Check if URL has ?role parameter (from select.html)
        const roleParam = urlParams.get('role');
        console.log('roleParam:', roleParam);
        if (roleParam && ['charge1', 'charge2', 'rrt'].includes(roleParam)) {
          console.log('Found role parameter, showing continue prompt');
          pendingRole = roleParam;
          document.getElementById('continueMessage').textContent = `Continue as ${roleNames[roleParam]}?`;
          document.getElementById('continuePrompt').style.display = 'block';
          // Keep role selection visible so users can change their mind
          return;
        }
        
        // Check if URL has ?group parameter (from select.html)
        const groupParam = urlParams.get('group');
        console.log('groupParam:', groupParam);
        if (groupParam) {
          const groupNum = parseInt(groupParam, 10);
          if (groupNum >= 1 && groupNum <= 6) {
            console.log('Found group parameter, showing continue prompt');
            pendingGroup = groupNum;
            const groupNames = {1: 'Neurological', 2: 'Psychopharmacology', 3: 'Pain Management', 4: 'Inflammation', 5: 'Endocrine', 6: 'Infection'};
            document.getElementById('continueMessage').textContent = `Continue to Group ${groupNum} (${groupNames[groupNum]})?`;
            document.getElementById('continuePrompt').style.display = 'block';
            // Keep role selection visible so users can change their mind
            return;
          }
        }
        
        // No URL params - check localStorage
        const savedRole = localStorage.getItem('pharmBlitzRole');
        if (savedRole && ['charge1', 'charge2', 'rrt'].includes(savedRole)) {
          console.log('Found saved role in localStorage, showing continue prompt');
          pendingRole = savedRole;
          document.getElementById('continueMessage').textContent = `Continue as ${roleNames[savedRole]}?`;
          document.getElementById('continuePrompt').style.display = 'block';
          // Keep role selection visible so users can change their mind
          return;
        }
        
        const savedGroup = localStorage.getItem('pharmBlitzGroupId');
        if (savedGroup) {
          const groupNum = parseInt(savedGroup, 10);
          if (groupNum >= 1 && groupNum <= 6) {
            console.log('Found saved group in localStorage, showing continue prompt');
            pendingGroup = groupNum;
            const groupNames = {1: 'Neurological', 2: 'Psychopharmacology', 3: 'Pain Management', 4: 'Inflammation', 5: 'Endocrine', 6: 'Infection'};
            document.getElementById('continueMessage').textContent = `Continue to Group ${groupNum} (${groupNames[groupNum]})?`;
            document.getElementById('continuePrompt').style.display = 'block';
            // Keep role selection visible so users can change their mind
            return;
          }
        }
        
        // Nothing found - show the built-in role selection screen
        console.log('No role/group found - showing selection screen');
        // The groupSelectionScreen is already visible by default
        
      } catch (e) {
        console.error('Error in checkExistingGroup:', e);
      }
    })();
    */
    
    console.log('Script loading completed - all functions should be ready');
    updateDebugBanner('ok', '‚úÖ Ready | Firebase connected | All functions loaded');
    
    } catch (error) {
      console.error('CRITICAL SCRIPT ERROR:', error);
      updateDebugBanner('error', 'Script Error: ' + error.message);
    }
  </script>
</body>
</html>
