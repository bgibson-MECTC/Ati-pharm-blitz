<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ATI Pharm Blitz ‚Äì Group View</title>

  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a1128 0%, #1e3a5f 100%);
      color: #ffffff;
      overflow-x: hidden;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    .main-wrapper {
      width: 100%;
      min-height: 100vh;
      overflow-y: auto;
      padding: 40px 20px;
      max-width: 1100px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    .main-title {
      font-size: 36px;
      font-weight: 900;
      background: linear-gradient(90deg, #00d4ff, #00ffb3, #00d4ff);
      background-size: 200% auto;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 3s linear infinite;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 16px;
      color: #00ffb3;
      font-weight: 400;
      margin-bottom: 4px;
    }

    .group-label {
      font-size: 14px;
      color: #ccecff;
    }

    @keyframes shimmer {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }

    .section {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      border: 2px solid rgba(0, 212, 255, 0.3);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
      padding-bottom: 10px;
      border-bottom: 2px solid #00d4ff;
    }

    .section-icon {
      font-size: 28px;
    }

    .section-title {
      font-size: 22px;
      font-weight: 700;
      color: #00ffb3;
      margin: 0;
    }

    .huddle-box {
      background: rgba(0, 212, 255, 0.1);
      border: 2px solid #00d4ff;
      border-radius: 15px;
      padding: 20px;
      margin-top: 10px;
    }

    .huddle-box h3 {
      color: #00ffb3;
      font-size: 20px;
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
    }

    .huddle-field {
      margin-bottom: 15px;
    }

    .huddle-field label {
      display: block;
      color: #00d4ff;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .huddle-field input,
    .huddle-field textarea {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 8px;
      padding: 9px;
      color: #ffffff;
      font-size: 14px;
      font-family: inherit;
    }

    .huddle-field textarea {
      min-height: 70px;
      resize: vertical;
    }

    .huddle-field input:focus,
    .huddle-field textarea:focus {
      outline: none;
      border-color: #00ffb3;
      background: rgba(255, 255, 255, 0.15);
    }

    .instructions-list {
      color: #ccecff;
      font-size: 14px;
      padding-left: 18px;
    }

    .instructions-list li {
      margin-bottom: 6px;
    }

    .back-link {
      display: inline-block;
      margin-top: 10px;
      font-size: 13px;
      color: #00ffb3;
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,212,255,0.5);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #ccecff;
      margin-left: 6px;
    }

    @media (max-width: 768px) {
      .main-title {
        font-size: 26px;
      }
      .section-title {
        font-size: 19px;
      }
    }

    /* Flashcard Guess */
    .flashguess-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 10px;
    }

    .fg-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #00d4ff;
      margin-bottom: 5px;
    }

    .fg-input {
      width: 100%;
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      border: 1px solid rgba(0,212,255,0.4);
      color: #ffffff;
      padding: 8px 10px;
      font-size: 14px;
      font-family: inherit;
    }

    .fg-input option {
      background: #1e3a5f;
      color: #ffffff;
    }

    .fg-input:focus {
      outline: none;
      border-color: #00ffb3;
      background: rgba(255,255,255,0.12);
    }

    @media (max-width: 600px) {
      .flashguess-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Flashcards */
    .flashcard-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .flashcard {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      border-radius: 15px;
      padding: 25px 18px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      min-height: 180px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .flashcard.locked {
      cursor: not-allowed;
      opacity: 0.7;
      background: linear-gradient(135deg, #555 0%, #333 100%);
    }

    .flashcard.locked::after {
      content: 'üîí';
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
    }

    .flashcard:not(.locked):hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.5);
    }

    .flashcard.flipped {
      background: linear-gradient(135deg, #00ffb3 0%, #00cc88 100%);
    }

    .flashcard-front {
      font-size: 14px;
      font-weight: 600;
      color: #ffffff;
      line-height: 1.4;
    }

    .flashcard-back {
      display: none;
      font-size: 13px;
      font-weight: 600;
      color: #0a1128;
      line-height: 1.5;
      text-align: left;
    }

    .flashcard.flipped .flashcard-front {
      display: none;
    }

    .flashcard.flipped .flashcard-back {
      display: block;
    }

    .card-number {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.5);
      color: #00ffb3;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <header>
      <h1 class="main-title">ATI Pharm Blitz</h1>
      <p class="subtitle" id="systemLabel">Group System: ‚Ä¶</p>
      <p class="group-label" id="groupLabel">Group: ‚Ä¶</p>
      <a href="index.html" class="back-link">‚¨Ö Back to Instructor View</a>
    </header>

    <!-- Instructions -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üìã</span>
        <h2 class="section-title">Your Mission<span class="pill">Group View</span></h2>
      </div>
      <ul class="instructions-list" id="instructionList">
        <!-- Filled dynamically based on system -->
      </ul>
    </section>

    <!-- GROUP IDENTIFIER -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üè∑Ô∏è</span>
        <h2 class="section-title">Group Identity</h2>
      </div>
      <p style="color:#ccecff;font-size:14px;margin-bottom:10px;">
        One device per table: enter your Group # exactly as assigned (1‚Äì6). The site will track your patient's stability based on your decisions.
      </p>
      <input id="groupIdInput" type="number" min="1" max="6"
             placeholder="Enter your Group #"
             style="background:rgba(255,255,255,0.08);border-radius:8px;border:1px solid rgba(0,212,255,0.4);color:#ffffff;padding:8px 10px;font-size:14px;">
      <button id="saveGroupIdBtn" class="assign-btn" style="margin-left:8px;">Set Group</button>
      <p id="groupIdStatus" class="assign-error"></p>
    </section>

    <!-- WARM-UP FLASHCARDS -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üî•</span>
        <h2 class="section-title">Warm-Up Flashcards</h2>
      </div>

      <p style="color:#ccecff;font-size:14px;margin-bottom:10px;">
        Click any card to flip it and see the answer. Cards are locked üîí until your group submits the correct system guess below.
      </p>

      <div class="flashcard-container">
        <!-- Card 1: Psychopharmacology -->
        <div class="flashcard locked" data-card-id="card1" data-system="psychopharmacology">
          <span class="card-number">Card 1</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on Haloperidol is showing muscle rigidity and tremors. What serious adverse effect requires immediate intervention? <em>(Psycho or Neuro?)</em>
          </div>
          <div class="flashcard-back">
            <strong>System:</strong> Psychopharmacology<br>
            <strong>Answer:</strong> Extrapyramidal symptoms (EPS) - requires immediate benztropine or dose adjustment<br>
            <strong>Priority:</strong> Watch for tardive dyskinesia (irreversible)<br>
            <strong>Safety Tip:</strong> Avoid combining with anticholinergics unless treating EPS<br>
            <strong>High-Yield Med:</strong> Fluoxetine - risk of serotonin syndrome with MAOIs
          </div>
        </div>

        <!-- Card 2: Neurological -->
        <div class="flashcard locked" data-card-id="card2" data-system="neurological">
          <span class="card-number">Card 2</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on Levodopa/Carbidopa experiences sudden "on-off" phenomenon. What lab value is critical to monitor? <em>(Neuro or Endocrine?)</em>
          </div>
          <div class="flashcard-back">
            <strong>System:</strong> Neurological<br>
            <strong>Answer:</strong> Vitamin B6 (pyridoxine) levels - can decrease Levodopa effectiveness<br>
            <strong>Priority:</strong> Monitor for dyskinesias and orthostatic hypotension<br>
            <strong>Safety Tip:</strong> Avoid high-protein meals (competes with absorption)<br>
            <strong>High-Yield Med:</strong> Phenobarbital - monitor therapeutic levels (10-40 mcg/mL)
          </div>
        </div>

        <!-- Card 3: Pain -->
        <div class="flashcard locked" data-card-id="card3" data-system="pain">
          <span class="card-number">Card 3</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A post-op patient on IV Fentanyl has a respiratory rate of 8. What is your FIRST action? <em>(Pain or Neuro?)</em>
          </div>
          <div class="flashcard-back">
            <strong>System:</strong> Pain<br>
            <strong>Answer:</strong> Administer Naloxone (Narcan) immediately - opioid reversal agent<br>
            <strong>Priority:</strong> Monitor respiratory rate &lt;12 = critical<br>
            <strong>Do NOT Mix:</strong> Fentanyl + benzodiazepines (respiratory depression)<br>
            <strong>High-Yield Med:</strong> Butorphanol - mixed agonist-antagonist, can precipitate withdrawal
          </div>
        </div>

        <!-- Card 4: Endocrine -->
        <div class="flashcard locked" data-card-id="card4" data-system="endocrine">
          <span class="card-number">Card 4</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on PTU (Propylthiouracil) develops a sore throat and fever. What life-threatening complication must you suspect? <em>(Endocrine or Infection?)</em>
          </div>
          <div class="flashcard-back">
            <strong>System:</strong> Endocrine<br>
            <strong>Answer:</strong> Agranulocytosis - obtain STAT CBC with differential<br>
            <strong>Priority:</strong> Monitor WBC &lt;3,000 = hold medication<br>
            <strong>Safety Tip:</strong> Teach patient to report signs of infection immediately<br>
            <strong>High-Yield Med:</strong> Somatropin - monitor blood glucose (causes hyperglycemia)
          </div>
        </div>

        <!-- Card 5: Infection -->
        <div class="flashcard locked" data-card-id="card5" data-system="infection">
          <span class="card-number">Card 5</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on Erythromycin is also taking Warfarin. What dangerous interaction must you monitor? <em>(Infection or Inflammation?)</em>
          </div>
          <div class="flashcard-back">
            <strong>System:</strong> Infection<br>
            <strong>Answer:</strong> Increased bleeding risk - Erythromycin inhibits Warfarin metabolism (elevated INR)<br>
            <strong>Priority:</strong> Monitor INR closely, target 2-3 for most indications<br>
            <strong>Do NOT Mix:</strong> Rifampin + oral contraceptives (decreases effectiveness)<br>
            <strong>High-Yield Med:</strong> Amphotericin B - monitor potassium (causes severe hypokalemia)
          </div>
        </div>

        <!-- Card 6: Inflammation -->
        <div class="flashcard locked" data-card-id="card6" data-system="inflammation">
          <span class="card-number">Card 6</span>
          <div class="flashcard-front">
            <strong>Clinical Case:</strong> A patient on Belimumab (lupus treatment) is scheduled for a live vaccine. What is your nursing action? <em>(Inflammation or Infection?)</em>
          </div>
          <div class="flashcard-back">
            <strong>System:</strong> Inflammation<br>
            <strong>Answer:</strong> HOLD vaccine - immunosuppressed patients cannot receive live vaccines<br>
            <strong>Priority:</strong> Screen for infections before each dose<br>
            <strong>Safety Tip:</strong> Avoid NSAIDs with immunosuppressants (GI bleeding risk)<br>
            <strong>High-Yield Meds:</strong> Allopurinol (monitor uric acid), Hydrocortisone (taper slowly - adrenal crisis)
          </div>
        </div>
      </div>
    </section>

    <!-- FLASHCARD GUESS SUBMISSION -->
    <section class="section" id="flashcardGuessSection">
      <div class="section-header">
        <span class="section-icon">üß†</span>
        <h2 class="section-title">Flashcard Guess ‚Äì Submit to Unlock</h2>
      </div>
      <p style="color:#ccecff;font-size:14px;margin-bottom:10px;">
        Submit your group's best guess for which system each card belongs to. When you get it right, the card unlocks and you can flip it!
      </p>

      <div class="flashguess-grid">
        <div>
          <label class="fg-label">Card ID</label>
          <select id="fgCard" class="fg-input">
            <option value="">Choose card‚Ä¶</option>
            <option value="card1">Card 1</option>
            <option value="card2">Card 2</option>
            <option value="card3">Card 3</option>
            <option value="card4">Card 4</option>
            <option value="card5">Card 5</option>
            <option value="card6">Card 6</option>
          </select>
        </div>
        <div>
          <label class="fg-label">System Guess</label>
          <select id="fgSystem" class="fg-input">
            <option value="">Select system‚Ä¶</option>
            <option value="Neurological">Neurological</option>
            <option value="Psychopharmacology">Psychopharmacology</option>
            <option value="Pain">Pain</option>
            <option value="Inflammation">Inflammation</option>
            <option value="Endocrine">Endocrine</option>
            <option value="Infection">Infection</option>
          </select>
        </div>
      </div>
      <button id="fgSubmit" class="assign-btn" style="margin-top:12px;">Submit Guess</button>
      <p id="fgStatus" class="assign-error"></p>
    </section>

    <!-- Expert Huddle Box (single system) -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üë©‚Äç‚öïÔ∏è</span>
        <h2 class="section-title">Expert Huddle ‚Äì <span id="systemNameInline">System</span></h2>
      </div>

      <div class="huddle-box" id="huddleBox">
        <h3 id="huddleTitle">System Experts</h3>

        <div class="huddle-field">
          <label>#1 Safety Risk (What kills the patient first?)</label>
          <input type="text" id="safetyRisk" placeholder="e.g., Respiratory depression, Lithium toxicity, GI bleed">
        </div>

        <div class="huddle-field">
          <label>#1 Lab / Assessment to Monitor</label>
          <input type="text" id="priorityLab" placeholder="e.g., Lithium level, INR, Blood glucose, WBC">
        </div>

        <div class="huddle-field">
          <label>"Do Not Mix" Rule</label>
          <input type="text" id="doNotMix" placeholder="e.g., MAOIs + SSRIs, opioids + benzos, NSAIDs + anticoagulants">
        </div>

        <div class="huddle-field">
          <label>High-Yield Medication(s)</label>
          <input type="text" id="highYieldMed" placeholder="e.g., Lithium, Vancomycin, Morphine, Insulin">
        </div>

        <div class="huddle-field">
          <label>Scenario Prompts (at least 2)</label>
          <textarea id="scenarioPrompts" placeholder="Example:
1) Your patient on ___ develops ___. What is your first action?
2) Teaching point the patient MUST remember about this med."></textarea>
        </div>

        <div class="huddle-field">
          <label>Rationale: Why are these your Top 3 priorities?</label>
          <textarea id="rationale" placeholder="Connect back to ATI, safety, and NCLEX-style thinking."></textarea>
        </div>
      </div>
    </section>

    <!-- JIGSAW LEARNING TRACKER -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üîÑ</span>
        <h2 class="section-title">Jigsaw Learning ‚Äì Track Your Progress</h2>
      </div>

      <p style="color:#ccecff;font-size:14px;margin-bottom:15px;">
        As you rotate through each system station, check off what you've learned. 
        When you complete a system's teaching, click the checkbox below to mark it complete.
      </p>

      <div id="jigsawCheckboxes" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:15px;">
        <p style="color:#ffb300;font-size:13px;margin:0;">‚ö†Ô∏è Set your Group # above first to see the tracking checkboxes.</p>
      </div>

      <div style="margin-top:15px;padding:12px;background:rgba(0,212,255,0.08);border-radius:10px;border-left:4px solid #00d4ff;">
        <p style="margin:0;font-size:13px;color:#ccecff;line-height:1.5;">
          <strong>üìù Pro Tip:</strong> Take notes on each system's #1 safety risk, critical lab, and do-not-mix rule. 
          You'll use this knowledge in the Lightning Round!
        </p>
      </div>
    </section>

    <!-- JIGSAW SPEED ROUND ‚Äì CASE REVEAL -->
    <section class="section" id="jigsawSection">
      <div class="section-header">
        <span class="section-icon">üß©</span>
        <h2 class="section-title">Jigsaw Speed Round ‚Äì Get Your Case</h2>
      </div>

      <p style="color:#ccecff;font-size:14px;margin-bottom:10px;">
        Each <strong>system expert</strong> will generate one case for their group.
        Select your expert role below and click <strong>"Get My Case"</strong>.
        The system will assign either a standard scenario or a consequence scenario based on your group's earlier decisions.
      </p>

      <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px;">
        <label for="jigsawSystemSelect" style="font-size:14px;color:#00d4ff;font-weight:600;">
          I am the expert for:
        </label>
        <select id="jigsawSystemSelect" class="fg-input" style="min-width:220px;">
          <option value="">Select your system‚Ä¶</option>
          <option value="psych">Psych / Haloperidol‚ÄìFluoxetine</option>
          <option value="neuro">Neuro / Levodopa‚ÄìPhenobarbital</option>
          <option value="pain">Pain / Fentanyl‚ÄìButorphanol</option>
          <option value="endocrine">Endocrine / PTU‚ÄìSomatropin</option>
          <option value="infection">Infection / Antibiotics‚ÄìAntifungals</option>
          <option value="inflammation">Inflammation / Belimumab‚ÄìAllopurinol‚ÄìSteroids</option>
        </select>

        <button id="jigsawCaseBtn" class="assign-btn">
          Get My Case
        </button>
      </div>

      <p id="jigsawStatus" class="assign-error"></p>

      <div id="jigsawCaseDisplay"
           style="margin-top:16px;padding:16px;border-radius:12px;border:1px solid rgba(0,212,255,0.4);background:rgba(255,255,255,0.04);min-height:80px;">
        <em style="color:#ccecff;font-size:13px;">Your case will appear here once generated. Do not refresh or you may lose your assigned scenario.</em>
      </div>
    </section>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBfJ4KBqpbP4tbtikAgMEdbT5P1rb3yhHo",
      authDomain: "ati-pharm-blitz.firebaseapp.com",
      databaseURL: "https://ati-pharm-blitz-default-rtdb.firebaseio.com",
      projectId: "ati-pharm-blitz",
      storageBucket: "ati-pharm-blitz.firebasestorage.app",
      messagingSenderId: "236104923394",
      appId: "1:236104923394:web:201f51f9ba162438b2aa1b"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Map group number -> system name + instructions
    const groupConfig = {
      1: {
        name: 'Neurological',
        label: 'Group 1 ‚Äì Neurological Experts',
        instructions: [
          'Focus on seizure meds, antiepileptics, and CNS depressants.',
          'Identify the biggest safety risk (airway, LOC, respiratory depression, etc.).',
          'Pick at least one high-yield drug (e.g., Phenytoin, Levetiracetam).',
          'Create two scenarios where neuro meds could rapidly become unsafe.',
          'Be ready to teach your Top 3 priorities to a mixed group.'
        ]
      },
      2: {
        name: 'Psychopharmacology',
        label: 'Group 2 ‚Äì Psychopharm Experts',
        instructions: [
          'Focus on antidepressants, antipsychotics, mood stabilizers, and anxiolytics.',
          'Think about suicide risk, serotonin syndrome, NMS, EPS, and sedation.',
          'Choose high-yield meds (e.g., Lithium, SSRIs, Clozapine).',
          'Create scenarios that force the group to choose the safest FIRST action.',
          'Prepare to explain why your rules prevent harm to the patient.'
        ]
      },
      3: {
        name: 'Pain Management',
        label: 'Group 3 ‚Äì Pain Management Experts',
        instructions: [
          'Focus on opioids, non-opioids, and adjunct pain meds.',
          'Zero in on respiratory depression, oversedation, and uncontrolled pain.',
          'Include at least one opioid and one non-opioid (e.g., Morphine + Ketorolac).',
          'Build scenarios where the wrong choice could tank breathing or perfusion.',
          'Be ready to explain how to safely combine or stagger pain meds.'
        ]
      },
      4: {
        name: 'Inflammation',
        label: 'Group 4 ‚Äì Inflammation / NSAID Experts',
        instructions: [
          'Focus on NSAIDs, steroids, and anti-inflammatory meds.',
          'Key risks: GI bleed, renal injury, immunosuppression.',
          'Pick common meds (e.g., Ibuprofen, Ketorolac, Prednisone).',
          'Create at least one scenario involving a patient on anticoagulants or with ulcers.',
          'Highlight labs and assessments that would make you HOLD the drug.'
        ]
      },
      5: {
        name: 'Endocrine',
        label: 'Group 5 ‚Äì Endocrine Experts',
        instructions: [
          'Focus on insulin, oral hypoglycemics, thyroid meds, and steroids.',
          'Watch for hypoglycemia, DKA/HHS, and thyroid storm/myxedema coma.',
          'Include at least one insulin and one oral agent or thyroid med.',
          'Create scenarios where timing of meds and meals matters.',
          'Be ready to explain which lab change is most deadly, the fastest.'
        ]
      },
      6: {
        name: 'Infection',
        label: 'Group 6 ‚Äì Infection / Antibiotic Experts',
        instructions: [
          'Focus on antibiotics, antivirals, and antifungals.',
          'Key risks: anaphylaxis, nephrotoxicity, C. diff, resistance.',
          'Choose high-yield meds (e.g., Vancomycin, Piperacillin-tazobactam).',
          'Write scenarios where cultures, trough levels, or allergies matter.',
          'Be ready to explain when you would STOP an antibiotic immediately.'
        ]
      }
    };

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    function initGroupView() {
      let groupNum = parseInt(getQueryParam('group'), 10);
      if (isNaN(groupNum) || groupNum < 1 || groupNum > 6) {
        groupNum = 1; // default to Group 1 if invalid
      }

      const config = groupConfig[groupNum];

      // Update header
      const systemLabel = document.getElementById('systemLabel');
      const groupLabel = document.getElementById('groupLabel');
      const systemNameInline = document.getElementById('systemNameInline');
      const huddleTitle = document.getElementById('huddleTitle');

      if (systemLabel) systemLabel.textContent = `System Focus: ${config.name}`;
      if (groupLabel) groupLabel.textContent = config.label;
      if (systemNameInline) systemNameInline.textContent = config.name;
      if (huddleTitle) huddleTitle.textContent = `${config.name} ‚Äì Top 3 Priorities`;

      // Instructions list
      const list = document.getElementById('instructionList');
      if (list) {
        list.innerHTML = '';
        config.instructions.forEach(text => {
          const li = document.createElement('li');
          li.textContent = text;
          list.appendChild(li);
        });
      }
    }

    document.addEventListener('DOMContentLoaded', initGroupView);

    // Auto-save to Firebase
    function setupFirebaseSync(groupNum) {
      const fields = ['safetyRisk', 'priorityLab', 'doNotMix', 'highYieldMed', 'scenarioPrompts', 'rationale'];
      const groupRef = database.ref('groups/' + groupNum);

      // Load existing data
      groupRef.once('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          fields.forEach(field => {
            const el = document.getElementById(field);
            if (el && data[field]) {
              el.value = data[field];
            }
          });
        }
      });

      // Save on input
      fields.forEach(fieldId => {
        const el = document.getElementById(fieldId);
        if (el) {
          el.addEventListener('input', () => {
            const updates = {};
            fields.forEach(field => {
              const input = document.getElementById(field);
              updates[field] = input ? input.value : '';
            });
            updates.systemName = groupConfig[groupNum].name;
            updates.timestamp = Date.now();
            groupRef.set(updates);
          });
        }
      });
    }

    function initGroupView() {
      let groupNum = parseInt(getQueryParam('group'), 10);
      if (isNaN(groupNum) || groupNum < 1 || groupNum > 6) {
        groupNum = 1; // default to Group 1 if invalid
      }

      const config = groupConfig[groupNum];

      // Update header
      const systemLabel = document.getElementById('systemLabel');
      const groupLabel = document.getElementById('groupLabel');
      const systemNameInline = document.getElementById('systemNameInline');
      const huddleTitle = document.getElementById('huddleTitle');

      if (systemLabel) systemLabel.textContent = `System Focus: ${config.name}`;
      if (groupLabel) groupLabel.textContent = config.label;
      if (systemNameInline) systemNameInline.textContent = config.name;
      if (huddleTitle) huddleTitle.textContent = `${config.name} ‚Äì Top 3 Priorities`;

      // Instructions list
      const list = document.getElementById('instructionList');
      if (list) {
        list.innerHTML = '';
        config.instructions.forEach(text => {
          const li = document.createElement('li');
          li.textContent = text;
          list.appendChild(li);
        });
      }

      // Setup Firebase sync
      setupFirebaseSync(groupNum);
    }

    document.addEventListener('DOMContentLoaded', initGroupView);

    // -----------------------------
    // GROUP ID HANDLING
    // -----------------------------

    let currentGroupId = null;

    function saveGroupId() {
      const input = document.getElementById('groupIdInput');
      const status = document.getElementById('groupIdStatus');
      const value = parseInt(input.value, 10);

      if (!value || value < 1 || value > 6) {
        status.style.color = '#ff99c2';
        status.textContent = 'Enter a valid Group # between 1 and 6.';
        return;
      }

      currentGroupId = value;
      status.style.color = '#00ffb3';
      status.textContent = 'Group set to #' + currentGroupId;

      // store locally so they don't retype
      try {
        localStorage.setItem('pharmBlitzGroupId', String(currentGroupId));
      } catch (e) {}

      // initialize stability in Firebase if not present
      const groupRef = database.ref('groups/' + currentGroupId);
      groupRef.child('stability').once('value').then(snap => {
        if (snap.val() == null) {
          groupRef.update({ stability: 100 });
        }
      });
    }

    const saveGroupBtn = document.getElementById('saveGroupIdBtn');
    if (saveGroupBtn) {
      saveGroupBtn.addEventListener('click', saveGroupId);
    }

    // Load saved groupId on page load
    (function loadSavedGroupId() {
      try {
        const saved = localStorage.getItem('pharmBlitzGroupId');
        if (saved) {
          currentGroupId = parseInt(saved, 10);
          const input = document.getElementById('groupIdInput');
          const status = document.getElementById('groupIdStatus');
          if (input) input.value = currentGroupId;
          if (status) {
            status.style.color = '#00ffb3';
            status.textContent = 'Group set to #' + currentGroupId;
          }
        }
      } catch (e) {}
    })();

    // -----------------------------
    // DECISION ENGINE + STABILITY
    // -----------------------------

    /**
     * recordDecision({
     *   phase: 'flashcard' | 'jigsaw' | 'lightning' | ...,
     *   itemId: 'card1' or 'scenarioA',
     *   isCorrect: true/false,
     *   severity: 'minor' | 'moderate' | 'critical',
     *   explanation: 'text shown to instructor'
     * })
     */
    function recordDecision(config) {
      if (!currentGroupId) {
        const status = document.getElementById('fgStatus') || document.getElementById('groupIdStatus');
        if (status) {
          status.style.color = '#ff99c2';
          status.textContent = 'Set your Group # first.';
        }
        return;
      }

      const { phase, itemId, isCorrect, severity, explanation } = config;
      const groupRef = database.ref('groups/' + currentGroupId);
      const eventsRef = database.ref('events');

      // Stability deltas
      let delta = 0;
      if (!isCorrect) {
        if (severity === 'critical') delta = -25;
        else if (severity === 'moderate') delta = -15;
        else delta = -5;
      } else {
        // small positive bump for correct decisions if you want
        delta = +2;
      }

      // Update stability atomically
      groupRef.child('stability').transaction(current => {
        if (typeof current !== 'number') current = 100;
        let next = current + delta;
        if (next > 100) next = 100;
        if (next < 0) next = 0;
        return next;
      });

      // Log event (for instructor alerts/consequence mapping)
      const payload = {
        groupId: currentGroupId,
        phase: phase,
        itemId: itemId,
        isCorrect: !!isCorrect,
        severity: severity,
        explanation: explanation,
        delta: delta,
        timestamp: Date.now()
      };

      eventsRef.push(payload);
    }

    // -----------------------------
    // FLASHCARD DISPLAY + SYNC
    // -----------------------------

    function setupFlashcardSync() {
      const flashcards = document.querySelectorAll('.flashcard[data-card-id]');
      
      flashcards.forEach(card => {
        const cardId = card.dataset.cardId;
        if (!cardId) return;
        
        // Listen to Firebase for flip state
        database.ref('flashcards/' + cardId).on('value', (snapshot) => {
          const data = snapshot.val();
          if (data && data.flipped) {
            // Unlock and can be flipped
            card.classList.remove('locked');
            
            // Add visual feedback
            card.style.animation = 'pulse 0.5s ease';
            setTimeout(() => {
              card.style.animation = '';
            }, 500);
          }
        });
        
        // Allow manual toggle only if unlocked
        card.addEventListener('click', () => {
          if (!card.classList.contains('locked')) {
            card.classList.toggle('flipped');
          }
        });
      });
    }

    // Initialize flashcard sync
    setupFlashcardSync();

    // -----------------------------
    // FLASHCARD GUESS ‚Äì AUTO CHECK
    // -----------------------------

    // Map each card to the correct system
    const flashcardKey = {
      card1: 'Psychopharmacology',  // Haloperidol/Fluoxetine - EPS, serotonin syndrome
      card2: 'Neurological',        // Levodopa/Phenobarbital - on-off phenomenon
      card3: 'Pain',                // Fentanyl/Butorphanol - respiratory depression
      card4: 'Endocrine',           // PTU/Somatropin - agranulocytosis
      card5: 'Infection',           // Erythromycin/Rifampin/Amphotericin B - drug interactions
      card6: 'Inflammation'         // Belimumab/Allopurinol/Hydrocortisone - live vaccines
    };

    function submitFlashcardGuess() {
      const cardInput = document.getElementById('fgCard');
      const systemInput = document.getElementById('fgSystem');
      const statusEl = document.getElementById('fgStatus');

      statusEl.textContent = '';

      if (!currentGroupId) {
        statusEl.style.color = '#ff99c2';
        statusEl.textContent = 'Set your Group # first.';
        return;
      }

      const cardId = cardInput.value;
      const systemGuess = systemInput.value;

      if (!cardId) {
        statusEl.style.color = '#ff99c2';
        statusEl.textContent = 'Choose which card you are answering for.';
        return;
      }
      if (!systemGuess) {
        statusEl.style.color = '#ff99c2';
        statusEl.textContent = 'Select your system guess.';
        return;
      }

      const correctSystem = flashcardKey[cardId];
      const isCorrect = (systemGuess === correctSystem);

      if (isCorrect) {
        statusEl.style.color = '#00ffb3';
        statusEl.textContent = '‚úì Correct ‚Äì nice call. Card will now flip on the instructor view!';
        
        // Mark card as flipped in Firebase so instructor view auto-flips it
        database.ref('flashcards/' + cardId).set({
          groupId: currentGroupId,
          flipped: true,
          timestamp: Date.now()
        });
        
        recordDecision({
          phase: 'flashcard',
          itemId: cardId,
          isCorrect: true,
          severity: 'minor',
          explanation: `Correctly identified ${cardId} as ${correctSystem}.`
        });
      } else {
        statusEl.style.color = '#ffb300';
        statusEl.textContent = `Not quite ‚Äì you picked ${systemGuess}, but you'll see how that choice affects your patient later.`;
        recordDecision({
          phase: 'flashcard',
          itemId: cardId,
          isCorrect: false,
          severity: 'moderate',
          explanation: `Misclassified ${cardId}: guessed ${systemGuess}, correct was ${correctSystem}.`
        });
      }

      // Reset form after brief delay
      setTimeout(() => {
        cardInput.value = '';
        systemInput.value = '';
      }, 2000);
    }

    const fgBtn = document.getElementById('fgSubmit');
    if (fgBtn) {
      fgBtn.addEventListener('click', submitFlashcardGuess);
    }

    // -----------------------------
    // JIGSAW LEARNING CHECKBOXES
    // -----------------------------

    const systemNames = {
      1: 'Neurological üß†',
      2: 'Psychopharmacology üíä',
      3: 'Pain Management üò£',
      4: 'Inflammation üî•',
      5: 'Endocrine ü©∫',
      6: 'Infection ü¶†'
    };

    function setupJigsawCheckboxes() {
      const container = document.getElementById('jigsawCheckboxes');
      if (!container || !currentGroupId) return;

      const jigsawRef = database.ref('jigsaw/group' + currentGroupId);

      // Load existing progress
      jigsawRef.once('value', (snapshot) => {
        const data = snapshot.val() || {};

        for (let sysNum = 1; sysNum <= 6; sysNum++) {
          const systemKey = 'system' + sysNum;
          const isCompleted = data[systemKey] === true;

          const box = document.createElement('div');
          box.style.cssText = 'background:rgba(255,255,255,0.05);border-radius:10px;padding:12px;border:1px solid rgba(0,212,255,0.3);display:flex;align-items:center;gap:10px;cursor:pointer;transition:all 0.2s ease;';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = 'jigsaw-sys-' + sysNum;
          checkbox.checked = isCompleted;
          checkbox.style.cssText = 'width:18px;height:18px;cursor:pointer;';

          const label = document.createElement('label');
          label.htmlFor = 'jigsaw-sys-' + sysNum;
          label.textContent = systemNames[sysNum];
          label.style.cssText = 'flex:1;cursor:pointer;font-size:14px;color:#ccecff;';

          box.appendChild(checkbox);
          box.appendChild(label);
          container.appendChild(box);

          // Save to Firebase when checked/unchecked
          checkbox.addEventListener('change', () => {
            jigsawRef.update({
              [systemKey]: checkbox.checked
            });

            // Optional: log a decision event
            if (checkbox.checked) {
              recordDecision({
                phase: 'jigsaw',
                itemId: systemKey,
                isCorrect: true,
                severity: 'minor',
                explanation: `Group ${currentGroupId} completed learning ${systemNames[sysNum]}`
              });
            }
          });

          // Visual feedback on hover
          box.addEventListener('mouseenter', () => {
            box.style.background = 'rgba(0,212,255,0.1)';
          });
          box.addEventListener('mouseleave', () => {
            box.style.background = 'rgba(255,255,255,0.05)';
          });
        }
      });

      // Listen for changes from instructor or other devices
      jigsawRef.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        for (let sysNum = 1; sysNum <= 6; sysNum++) {
          const checkbox = document.getElementById('jigsaw-sys-' + sysNum);
          if (checkbox) {
            checkbox.checked = data['system' + sysNum] === true;
          }
        }
      });
    }

    // Initialize jigsaw when group ID is set
    const saveGroupBtn = document.getElementById('saveGroupIdBtn');
    if (saveGroupBtn) {
      saveGroupBtn.addEventListener('click', () => {
        setTimeout(() => {
          if (currentGroupId) {
            setupJigsawCheckboxes();
          }
        }, 500);
      });
    }

    // Also initialize on page load if group ID already exists
    if (currentGroupId) {
      setupJigsawCheckboxes();
    }

    // Try again after a short delay in case group ID loads from localStorage
    setTimeout(() => {
      if (currentGroupId && document.getElementById('jigsawCheckboxes').children.length <= 1) {
        setupJigsawCheckboxes();
      }
    }, 1000);

    // -----------------------------
    // JIGSAW SPEED ROUND ‚Äì CASE ASSIGNMENT
    // -----------------------------

    // Map systems ‚Üí their flashcard card ID
    const systemToCard = {
      psych: 'card1',
      neuro: 'card2',
      pain: 'card3',
      endocrine: 'card4',
      infection: 'card5',
      inflammation: 'card6'
    };

    // JIGSAW CASE BANK
    const jigsawCases = {
      psych: {
        standard: {
          title: 'Psych ‚Äì Standard Case: Haloperidol (NMS Risk)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>You receive a new patient with schizophrenia started on <strong>Haloperidol</strong> 48 hours ago.</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Temperature: <strong>100.9¬∞F</strong></li>
              <li>Increasing <strong>muscle rigidity</strong></li>
              <li>BP: <strong>168/94</strong>, HR <strong>128</strong></li>
              <li>Patient looks confused and diaphoretic.</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority concern</strong>, and what is your <strong>first action</strong> as the nurse?</p>
          `
        },
        consequence: {
          title: 'Psych ‚Äì Consequence Case: Fluoxetine + Tramadol (Serotonin Syndrome)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>Patient on <strong>fluoxetine</strong> for depression and <strong>tramadol</strong> for chronic pain presents with:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Temperature: <strong>102.6¬∞F</strong></li>
              <li><strong>Clonus</strong> and hyperreflexia</li>
              <li>Agitation, flushed skin, heavy sweating</li>
              <li>BP <strong>154/90</strong>, HR <strong>132</strong></li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is happening, and what is your <strong>first priority action</strong>?</p>
          `
        }
      },

      neuro: {
        standard: {
          title: 'Neuro ‚Äì Standard Case: Levodopa/Carbidopa (Fall Risk)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A Parkinson's patient taking <strong>levodopa-carbidopa</strong> reports:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Improved tremors</li>
              <li><strong>Dizziness</strong> when standing</li>
              <li>Nausea</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority nursing focus</strong> for this patient to prevent harm?</p>
          `
        },
        consequence: {
          title: 'Neuro ‚Äì Consequence Case: Phenobarbital Toxicity',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A seizure patient taking <strong>phenobarbital</strong> is found:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Very lethargic, difficult to arouse</li>
              <li>RR <strong>8</strong></li>
              <li>BP <strong>90/60</strong></li>
              <li>Pupils sluggish</li>
              <li>Admits: "I took a little extra dose because I felt a seizure coming."</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority action</strong>, and what is the likely cause of this decline?</p>
          `
        }
      },

      pain: {
        standard: {
          title: 'Pain ‚Äì Standard Case: Fentanyl Monitoring',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>Post-op patient received IV <strong>fentanyl</strong> 20 minutes ago.</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Pain decreases from 9/10 ‚Üí 3/10</li>
              <li>RR <strong>10</strong>, shallow but arousable</li>
              <li>SpO‚ÇÇ <strong>92%</strong> on 2 L/min NC</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>next nursing action</strong> and what should you watch closely?</p>
          `
        },
        consequence: {
          title: 'Pain ‚Äì Consequence Case: Fentanyl Overdose',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>Same post-op patient now:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>RR <strong>6</strong></li>
              <li>Unresponsive to voice</li>
              <li>SpO‚ÇÇ <strong>84%</strong></li>
              <li>Pinpoint pupils</li>
              <li>An empty fentanyl PCA vial is in the bed.</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>first priority action</strong>, and what medication do you anticipate administering?</p>
          `
        }
      },

      endocrine: {
        standard: {
          title: 'Endocrine ‚Äì Standard Case: PTU (Agranulocytosis Risk)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A patient on <strong>PTU</strong> for hyperthyroidism reports:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Sore throat</li>
              <li>Mild fever</li>
              <li>Fatigue</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What lab value is your <strong>priority</strong>, and why?</p>
          `
        },
        consequence: {
          title: 'Endocrine ‚Äì Consequence Case: PTU Agranulocytosis',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>Same PTU patient now presents with:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Temp <strong>101.8¬∞F</strong></li>
              <li>Severe sore throat</li>
              <li>WBC <strong>1,200</strong></li>
              <li>BP <strong>92/54</strong>, HR <strong>130</strong></li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What condition are you most concerned about and what is your <strong>immediate nursing action</strong>?</p>
          `
        }
      },

      infection: {
        standard: {
          title: 'Infection ‚Äì Standard Case: Rifampin (Liver Monitoring)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A TB patient on <strong>rifampin</strong> reports:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Orange-colored urine and tears</li>
              <li>Mild fatigue</li>
              <li>Mild abdominal discomfort</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            Which lab values are your <strong>priority</strong> to monitor, and why?</p>
          `
        },
        consequence: {
          title: 'Infection ‚Äì Consequence Case: Amphotericin B Nephrotoxicity',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A patient on IV <strong>Amphotericin B</strong> for fungal infection now has:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Creatinine rising from 0.9 ‚Üí <strong>2.4</strong></li>
              <li>K‚Å∫ <strong>6.1</strong></li>
              <li>EKG showing <strong>peaked T waves</strong></li>
              <li>Rigors and fevers with infusions</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority</strong> response, and what earlier monitoring could have prevented this?</p>
          `
        }
      },

      inflammation: {
        standard: {
          title: 'Inflammation ‚Äì Standard Case: Belimumab (Infection Risk)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A lupus patient on <strong>belimumab</strong> reports:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>New fatigue</li>
              <li>Mild sore throat</li>
              <li>Low-grade temp 99.9¬∞F</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority teaching</strong> for this patient?</p>
          `
        },
        consequence: {
          title: 'Inflammation ‚Äì Consequence Case: Allopurinol (SJS/TEN)',
          html: `
            <p><strong>Scenario:</strong></p>
            <p>A gout patient on <strong>allopurinol</strong> develops:</p>
            <ul style="margin-left:20px;color:#ccecff;">
              <li>Widespread painful rash</li>
              <li>Blistering lesions</li>
              <li>Fever</li>
              <li>Oral and mucosal involvement</li>
            </ul>
            <p><strong>Question for your group:</strong><br>
            What is your <strong>priority concern</strong>, and what should you do immediately?</p>
          `
        }
      }
    };

    // Decide which variant a group gets: standard vs consequence
    function decideJigsawVariantForGroup(systemKey) {
      return new Promise((resolve, reject) => {
        if (!currentGroupId) {
          return reject(new Error('Group # not set. Make sure your group has already used the site for Phase 1.'));
        }

        const cardId = systemToCard[systemKey];
        if (!cardId) return reject(new Error('Unknown system selection.'));

        const groupRef = database.ref('groups/' + currentGroupId + '/stability');
        const eventsRef = database.ref('events').orderByChild('groupId').equalTo(currentGroupId);

        // Get stability + events in parallel
        Promise.all([
          groupRef.once('value'),
          eventsRef.once('value')
        ]).then(([stabilitySnap, eventsSnap]) => {
          const stability = typeof stabilitySnap.val() === 'number' ? stabilitySnap.val() : 100;
          let hadFlashcardMiss = false;

          const eventsVal = eventsSnap.val() || {};
          Object.values(eventsVal).forEach(ev => {
            if (
              ev.phase === 'flashcard' &&
              ev.itemId === cardId &&
              ev.isCorrect === false
            ) {
              hadFlashcardMiss = true;
            }
          });

          // RULE:
          // If they missed the flashcard for this system OR their stability is < 75 ‚Üí consequence case.
          // Otherwise ‚Üí standard case.
          if (hadFlashcardMiss || stability < 75) {
            resolve('consequence');
          } else {
            resolve('standard');
          }

        }).catch(err => reject(err));
      });
    }

    // Hook up the "Get My Case" button
    const jigsawCaseBtn = document.getElementById('jigsawCaseBtn');
    const jigsawSystemSelect = document.getElementById('jigsawSystemSelect');
    const jigsawCaseDisplay = document.getElementById('jigsawCaseDisplay');
    const jigsawStatus = document.getElementById('jigsawStatus');

    if (jigsawCaseBtn && jigsawSystemSelect && jigsawCaseDisplay) {
      jigsawCaseBtn.addEventListener('click', () => {
        jigsawStatus.textContent = '';
        jigsawCaseDisplay.innerHTML = '<em style="color:#ccecff;font-size:13px;">Loading case...</em>';

        const systemKey = jigsawSystemSelect.value;
        if (!systemKey) {
          jigsawStatus.style.color = '#ff99c2';
          jigsawStatus.textContent = 'Please select your expert system first.';
          jigsawCaseDisplay.innerHTML = '<em style="color:#ccecff;font-size:13px;">No case loaded.</em>';
          return;
        }

        if (!jigsawCases[systemKey]) {
          jigsawStatus.style.color = '#ff99c2';
          jigsawStatus.textContent = 'Case bank not configured for that system.';
          return;
        }

        decideJigsawVariantForGroup(systemKey)
          .then(variant => {
            const caseData = jigsawCases[systemKey][variant];
            if (!caseData) {
              throw new Error('No case configured for that variant.');
            }
            jigsawCaseDisplay.innerHTML = `
              <h3 style="color:#00ffb3;margin-top:0;">${caseData.title}</h3>
              ${caseData.html}
              <p style="margin-top:12px;font-size:12px;color:#ccecff;">
                <em>Note for your group:</em> This scenario was assigned based on your earlier decisions in Phase 1.
              </p>
            `;
          })
          .catch(err => {
            console.error(err);
            jigsawStatus.style.color = '#ff99c2';
            jigsawStatus.textContent = 'Unable to assign case. Check your group number and Firebase connection.';
            jigsawCaseDisplay.innerHTML = '<em style="color:#ff9f9f;font-size:13px;">Error loading case.</em>';
          });
      });
    }
  </script>
</body>
</html>
