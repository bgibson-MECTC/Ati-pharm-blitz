<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ATI Pharm Blitz Review</title>

  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a1128 0%, #1e3a5f 100%);
      color: #ffffff;
      overflow-x: hidden;
    }

    /* Role Selection Landing Screen */
    .landing-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 40px 20px;
      text-align: center;
    }

    .landing-screen.hidden {
      display: none;
    }

    .landing-title {
      font-size: 56px;
      font-weight: 900;
      background: linear-gradient(90deg, #00d4ff, #00ffb3, #00d4ff);
      background-size: 200% auto;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 3s linear infinite;
      text-transform: uppercase;
      letter-spacing: 3px;
      margin-bottom: 20px;
    }

    .landing-subtitle {
      font-size: 20px;
      color: #b8e0ff;
      margin-bottom: 60px;
      font-weight: 300;
    }

    .role-selection {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .role-card {
      background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(0,255,179,0.05));
      border: 2px solid rgba(0,212,255,0.3);
      border-radius: 20px;
      padding: 50px 60px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 280px;
    }

    .role-card:hover {
      transform: translateY(-10px);
      border-color: #00d4ff;
      box-shadow: 0 20px 40px rgba(0,212,255,0.3);
      background: linear-gradient(135deg, rgba(0,212,255,0.15), rgba(0,255,179,0.1));
    }

    .role-icon {
      font-size: 72px;
      margin-bottom: 20px;
    }

    .role-title {
      font-size: 28px;
      font-weight: 700;
      color: #00ffb3;
      margin-bottom: 10px;
    }

    .role-description {
      font-size: 14px;
      color: #b8e0ff;
      line-height: 1.6;
    }

    .instructor-content {
      display: none;
    }

    .instructor-content.active {
      display: block;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    .main-wrapper {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      padding: 40px 20px;
    }

    /* Header */
    header {
      text-align: center;
      margin-bottom: 50px;
      animation: fadeInDown 0.8s ease-out;
    }

    .main-title {
      font-size: 48px;
      font-weight: 900;
      background: linear-gradient(90deg, #00d4ff, #00ffb3, #00d4ff);
      background-size: 200% auto;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 3s linear infinite;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 18px;
      color: #00ffb3;
      font-weight: 300;
    }

    @keyframes shimmer {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }

    @keyframes pulse-warning {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(255, 179, 0, 0.7); }
      50% { opacity: 0.85; box-shadow: 0 0 20px 10px rgba(255, 179, 0, 0); }
    }

    @keyframes pulse-critical {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(255, 0, 110, 0.9); }
      50% { opacity: 0.75; box-shadow: 0 0 30px 15px rgba(255, 0, 110, 0); }
    }

    .stability-warning {
      animation: pulse-warning 2s ease-in-out infinite;
    }

    .stability-critical {
      animation: pulse-critical 1.5s ease-in-out infinite;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Section */
    .section {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 40px;
      border: 2px solid rgba(0, 212, 255, 0.3);
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #00d4ff;
    }

    .section-icon {
      font-size: 36px;
    }

    .section-title {
      font-size: 28px;
      font-weight: 700;
      color: #00ffb3;
      margin: 0;
    }

    /* Flashcards */
    .flashcard-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .flashcard {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .flashcard.locked {
      cursor: not-allowed;
      opacity: 0.7;
      background: linear-gradient(135deg, #555 0%, #333 100%);
    }

    .flashcard.locked::after {
      content: 'üîí';
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
    }

    .flashcard:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.5);
    }

    .flashcard.flipped {
      background: linear-gradient(135deg, #00ffb3 0%, #00cc88 100%);
    }

    .flashcard-front {
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
    }

    .flashcard-back {
      display: none;
      font-size: 22px;
      font-weight: 700;
      color: #0a1128;
    }

    .flashcard.flipped .flashcard-front {
      display: none;
    }

    .flashcard.flipped .flashcard-back {
      display: block;
    }

    /* Huddle Grid */
    .huddle-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-top: 20px;
    }

    .huddle-box {
      background: rgba(0, 212, 255, 0.1);
      border: 2px solid #00d4ff;
      border-radius: 15px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .huddle-box:hover {
      background: rgba(0, 212, 255, 0.2);
      transform: scale(1.02);
    }

    .huddle-box h3 {
      color: #00ffb3;
      font-size: 20px;
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
    }

    .huddle-field {
      margin-bottom: 15px;
    }

    .huddle-field label {
      display: block;
      color: #00d4ff;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .huddle-field input,
    .huddle-field textarea {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 8px;
      padding: 10px;
      color: #ffffff;
      font-size: 14px;
      font-family: inherit;
    }

    .huddle-field textarea {
      min-height: 60px;
      resize: vertical;
    }

    .huddle-field input:focus,
    .huddle-field textarea:focus {
      outline: none;
      border-color: #00ffb3;
      background: rgba(255, 255, 255, 0.15);
    }

    /* Red Flags */
    .red-flag-btn {
      background: #ff006e;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      font-size: 12px;
      cursor: pointer;
    }

    .red-flag-content {
      display: none;
      margin-top: 10px;
      background: rgba(255, 0, 110, 0.2);
      border-left: 4px solid #ff006e;
      padding: 10px;
      font-weight: bold;
    }

    .red-flag-content.show {
      display: block;
    }

    /* Lightning Tiles */
    .question-tile {
      background: linear-gradient(135deg, #8338ec 0%, #3a86ff 100%);
      border-radius: 12px;
      padding: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .question-tile:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(131, 56, 236, 0.5);
    }

    .tile-answer {
      display: none;
    }

    .question-tile.revealed {
      background: linear-gradient(135deg, #00ffb3 0%, #00d4ff 100%);
    }

    .question-tile.revealed .tile-question {
      display: none;
    }

    .question-tile.revealed .tile-answer {
      display: block;
      font-weight: bold;
      color: #0a1128;
    }

    /* Instructor Panel */
    .instructor-panel {
      background: rgba(255, 179, 0, 0.08);
      border: 3px solid #ffb300;
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 30px;
    }

    .instructor-panel .section-header {
      border-bottom-color: #ffb300;
    }

    .instructor-panel .section-title {
      color: #ffb300;
    }

    .instructor-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .control-box {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 179, 0, 0.4);
      border-radius: 12px;
      padding: 20px;
    }

    .control-box h4 {
      color: #ffb300;
      font-size: 16px;
      margin: 0 0 15px 0;
      text-align: center;
    }

    .timer-display {
      font-size: 42px;
      font-weight: 900;
      text-align: center;
      color: #00ffb3;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
    }

    .timer-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #00ffb3, #00cc88);
    }

    .btn-warning {
      background: linear-gradient(135deg, #ffb300, #ff8c00);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff006e, #cc0058);
    }

    .group-links {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .group-link {
      background: linear-gradient(135deg, #8338ec, #6528d7);
      color: #ffffff;
      text-decoration: none;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .group-link:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(131, 56, 236, 0.5);
    }

    .answer-key {
      background: rgba(0, 255, 179, 0.1);
      border: 2px solid #00ffb3;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
    }

    .answer-key h5 {
      color: #00ffb3;
      margin: 0 0 10px 0;
      font-size: 14px;
    }

    .answer-key ul {
      margin: 0;
      padding-left: 20px;
      font-size: 13px;
      color: #ccecff;
    }

    .answer-key li {
      margin-bottom: 5px;
    }

    .phase-indicator {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }

    .phase {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .phase.active {
      background: #00ffb3;
      color: #0a1128;
      border-color: #00ffb3;
    }

    .phase:not(.active) {
      background: rgba(255, 255, 255, 0.1);
      color: #ccecff;
      border-color: rgba(255, 255, 255, 0.2);
    }

    .phase:hover {
      transform: scale(1.05);
    }

    .teaching-notes {
      background: rgba(0, 212, 255, 0.08);
      border-left: 4px solid #00d4ff;
      padding: 15px;
      margin-top: 15px;
      border-radius: 5px;
    }

    .teaching-notes p {
      margin: 0;
      font-size: 13px;
      color: #ccecff;
      line-height: 1.6;
    }

    /* Random group assignment */
    .assign-grid {
      display: grid;
      grid-template-columns: minmax(260px, 1.2fr) minmax(260px, 1.5fr);
      gap: 20px;
      margin-top: 10px;
    }

    .assign-input label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #00d4ff;
      margin-bottom: 6px;
    }

    #studentNames {
      width: 100%;
      min-height: 160px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      border: 1px solid rgba(0,212,255,0.4);
      color: #ffffff;
      padding: 10px;
      font-size: 13px;
      resize: vertical;
      font-family: inherit;
    }

    .assign-controls {
      display: flex;
      gap: 15px;
      margin-top: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .assign-controls label {
      margin-bottom: 4px;
    }

    .assign-controls input {
      width: 80px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      border: 1px solid rgba(0,212,255,0.4);
      color: #ffffff;
      padding: 6px;
      font-size: 13px;
      font-family: inherit;
    }

    .assign-btn {
      margin-top: 6px;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #00ffb3;
      color: #0a1128;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.4);
      transition: all 0.2s ease;
    }

    .assign-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.5);
    }

    .assign-error {
      color: #ff99c2;
      font-size: 12px;
      min-height: 16px;
      margin-top: 4px;
    }

    .assign-output h3 {
      margin-top: 0;
      font-size: 18px;
      color: #00ffb3;
    }

    .group-results {
      max-height: 260px;
      overflow-y: auto;
      padding-right: 6px;
    }

    .group-card {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      border: 1px solid rgba(0,212,255,0.4);
      padding: 10px 12px;
      margin-bottom: 8px;
    }

    .group-card h4 {
      margin: 0 0 6px;
      font-size: 14px;
      color: #00ffb3;
    }

    .group-card ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 13px;
    }

    .group-card li {
      margin-bottom: 2px;
    }

    .role-badge {
      display: inline-block;
      margin-left: 4px;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(0,212,255,0.6);
      color: #ffddf2;
    }

    @media (max-width: 800px) {
      .assign-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Lab flow + timer */
    .timer-panel {
      display: grid;
      grid-template-columns: minmax(220px, 1.6fr) minmax(180px, 1.1fr);
      gap: 20px;
      align-items: center;
      margin-top: 10px;
    }

    .timer-info {
      background: rgba(0, 212, 255, 0.08);
      border-radius: 14px;
      border: 1px solid rgba(0,212,255,0.4);
      padding: 14px 16px;
    }

    .timer-phase-label {
      font-size: 16px;
      font-weight: 700;
      color: #00ffb3;
      margin-bottom: 8px;
    }

    .timer-instructions {
      margin: 0;
      padding-left: 18px;
      font-size: 13px;
      color: #ccecff;
    }

    .timer-instructions li {
      margin-bottom: 4px;
    }

    .timer-controls {
      text-align: center;
    }

    .timer-display {
      font-size: 40px;
      font-weight: 900;
      padding: 10px 0;
      border-radius: 16px;
      border: 2px solid rgba(0,212,255,0.8);
      background: radial-gradient(circle at top, rgba(0,212,255,0.3), rgba(10,17,40,0.9));
      margin-bottom: 10px;
    }

    .timer-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
      margin-bottom: 6px;
    }

    .timer-buttons button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(0,212,255,0.15);
      color: #ffffff;
      border: 1px solid rgba(0,212,255,0.6);
      transition: all 0.2s ease;
    }

    .timer-buttons button:hover {
      background: rgba(0,212,255,0.35);
      transform: translateY(-1px);
    }

    #nextPhaseBtn {
      background: #00ffb3;
      color: #0a1128;
      border-color: #00ffb3;
    }

    #nextPhaseBtn:hover {
      background: #4dffd0;
    }

    .timer-phase-count {
      font-size: 12px;
      color: #ccecff;
    }

    @media (max-width: 800px) {
      .timer-panel {
        grid-template-columns: 1fr;
      }
    }

    /* Debrief board */
    .debrief-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 10px;
    }

    .debrief-card {
      background: rgba(255,255,255,0.04);
      border-radius: 12px;
      border: 1px solid rgba(0,212,255,0.3);
      padding: 10px;
    }

    .debrief-card h3 {
      margin: 0 0 6px;
      font-size: 14px;
      color: #00ffb3;
    }

    .debrief-card textarea {
      width: 100%;
      min-height: 90px;
      background: rgba(255,255,255,0.07);
      border-radius: 8px;
      border: 1px solid rgba(0,212,255,0.4);
      color: #ffffff;
      padding: 8px;
      font-size: 13px;
      resize: vertical;
      font-family: inherit;
    }
  </style>
</head>

<body>
  <!-- LANDING SCREEN -->
  <div class="landing-screen" id="landingScreen">
    <h1 class="landing-title">ATI Pharm Blitz</h1>
    <p class="landing-subtitle">1-Hour High-Yield NCLEX Pharmacology Review</p>
    
    <div class="role-selection">
      <div class="role-card" onclick="selectRole('instructor')">
        <div class="role-icon">üéì</div>
        <div class="role-title">Instructor</div>
        <div class="role-description">Access command center, timer controls, and live monitoring dashboard</div>
      </div>
      
      <div class="role-card" onclick="selectRole('student')">
        <div class="role-icon">üë•</div>
        <div class="role-title">Student</div>
        <div class="role-description">Join your group for interactive pharmacology challenges</div>
      </div>
    </div>
  </div>

  <!-- INSTRUCTOR CONTENT -->
  <div class="main-wrapper instructor-content" id="instructorContent">
    <header>
      <h1 class="main-title">ATI Pharm Blitz</h1>
      <p class="subtitle">Instructor Dashboard</p>
      <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px;">
        <a href="group.html" class="back-link" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 8px; cursor: pointer; color: #fff; font-size: 14px; text-decoration: none; display: inline-block;">üè† Student Home Screen</a>
        <button onclick="resetGame()" class="back-link" style="background: rgba(255,69,0,0.2); border: 1px solid rgba(255,69,0,0.5); padding: 10px 20px; border-radius: 8px; cursor: pointer; color: #ff6b6b; font-size: 14px; font-weight: 600;">üîÑ Reset Game</button>
      </div>
    </header>

    <!-- DEBRIEF BOARD (INSTRUCTOR VIEW) -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üßæ</span>
        <h2 class="section-title">Debrief Board ‚Äì Charge Nurse Notes</h2>
      </div>

      <p style="color:#ccecff;font-size:14px;margin-bottom:15px;">
        Review what the Charge Nurses documented for each group. This updates automatically as they save their notes.
      </p>

      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:20px;">
        <div style="padding:15px;background:rgba(255,179,0,0.1);border-radius:12px;border:2px solid rgba(255,179,0,0.3);">
          <h3 style="color:#ffb300;margin:0 0 10px 0;">üë®‚Äç‚öïÔ∏è Charge Nurse 1 (Groups 1-3)</h3>
          <div id="charge1Debriefs">
            <!-- Populated by JS -->
          </div>
        </div>
        
        <div style="padding:15px;background:rgba(255,179,0,0.1);border-radius:12px;border:2px solid rgba(255,179,0,0.3);">
          <h3 style="color:#ffb300;margin:0 0 10px 0;">üë©‚Äç‚öïÔ∏è Charge Nurse 2 (Groups 4-6)</h3>
          <div id="charge2Debriefs">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>

      <button onclick="exportSessionReport()" class="assign-btn" style="margin-top:15px;background:#00d4ff;">
        üì• Export Session Report
      </button>
      <p id="debriefStatus" class="assign-error"></p>
    </section>

    <!-- INSTRUCTOR DASHBOARD ‚Äì LIVE VIEW -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üìä</span>
        <h2 class="section-title">Instructor Dashboard ‚Äì Live View</h2>
      </div>

      <!-- Phase Timer Controls -->
      <div style="margin-bottom:25px;padding:20px;background:rgba(0,212,255,0.1);border:2px solid rgba(0,212,255,0.3);border-radius:15px;">
        <h3 style="color:#00ffb3;font-size:18px;margin:0 0 15px 0;">‚è±Ô∏è Phase Timer Controls</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:15px;">
          <button onclick="startTimer('Warm-Up Flashcards', 15)" class="assign-btn" style="background:#00d4ff;">
            ‚ñ∂ Start Warm-Up (15 min)
          </button>
          <button onclick="startTimer('Expert Huddle', 10)" class="assign-btn" style="background:#00d4ff;">
            ‚ñ∂ Start Huddle (10 min)
          </button>
          <button onclick="startTimer('Jigsaw Round', 20)" class="assign-btn" style="background:#00d4ff;">
            ‚ñ∂ Start Jigsaw (20 min)
          </button>
          <button onclick="startTimer('Speed Round', 10)" class="assign-btn" style="background:#00d4ff;">
            ‚ñ∂ Start Speed Round (10 min)
          </button>
          <button onclick="stopTimer()" class="assign-btn" style="background:#ff006e;">
            ‚èπ Stop Timer
          </button>
        </div>
        <div id="timerStatus" style="color:#ccecff;font-size:14px;text-align:center;"></div>
      </div>

      <!-- Adaptive Difficulty Controls -->
      <div style="margin-bottom:25px;padding:20px;background:rgba(138,43,226,0.05);border:2px solid rgba(138,43,226,0.2);border-radius:15px;">
        <h3 style="color:#8a2be2;font-size:18px;margin:0 0 15px 0;">üéöÔ∏è Adaptive Difficulty</h3>
        
        <div style="margin-bottom:15px;">
          <label style="display:block;color:#ccecff;font-size:14px;margin-bottom:8px;">
            Error Penalty Multiplier: <span id="difficultyValue" style="color:#00ffb3;font-weight:700;">1.0x</span>
          </label>
          <input type="range" id="difficultySlider" min="0.5" max="2.0" step="0.1" value="1.0" 
            style="width:100%;accent-color:#8a2be2;" 
            oninput="updateDifficulty(this.value)" />
          <div style="display:flex;justify-content:space-between;font-size:12px;color:#888;margin-top:5px;">
            <span>Easy (0.5x)</span>
            <span>Normal (1.0x)</span>
            <span>Hard (2.0x)</span>
          </div>
        </div>

        <div style="background:rgba(255,255,255,0.05);padding:12px;border-radius:8px;font-size:12px;color:#ccecff;">
          <strong style="color:#8a2be2;">Effect:</strong> Adjusts stability penalty for errors. 
          Easy mode = -2 to -12 stability. Normal = -5 to -25. Hard = -10 to -50.
          <div style="margin-top:8px;padding:8px;background:rgba(138,43,226,0.1);border-radius:6px;">
            <strong>Current Settings:</strong><br>
            Minor errors: <span id="minorPenalty">-5</span><br>
            Moderate errors: <span id="moderatePenalty">-15</span><br>
            Critical errors: <span id="criticalPenalty">-25</span>
          </div>
        </div>
      </div>

      <div style="margin-bottom:25px;">
        <h3 style="color:#00ffb3;font-size:18px;margin:0 0 12px 0;">Patient Stability by Group</h3>
        <div id="stabilityPanel" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;"></div>
      </div>

      <!-- Performance Metrics -->
      <div style="margin-bottom:25px;padding:20px;background:rgba(0,255,179,0.05);border:2px solid rgba(0,255,179,0.2);border-radius:15px;">
        <h3 style="color:#00ffb3;font-size:18px;margin:0 0 15px 0;">üìà Session Performance Metrics</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;">
          <div style="text-align:center;padding:15px;background:rgba(0,0,0,0.2);border-radius:10px;">
            <div style="font-size:28px;font-weight:900;color:#00ffb3;" id="avgStability">--</div>
            <div style="font-size:12px;color:#ccecff;margin-top:5px;">Average Stability</div>
          </div>
          <div style="text-align:center;padding:15px;background:rgba(0,0,0,0.2);border-radius:10px;">
            <div style="font-size:28px;font-weight:900;color:#ff006e;" id="totalErrors">--</div>
            <div style="font-size:12px;color:#ccecff;margin-top:5px;">Total Errors</div>
          </div>
          <div style="text-align:center;padding:15px;background:rgba(0,0,0,0.2);border-radius:10px;">
            <div style="font-size:28px;font-weight:900;color:#ffb300;" id="rrtCalls">--</div>
            <div style="font-size:12px;color:#ccecff;margin-top:5px;">RRT Calls Made</div>
          </div>
          <div style="text-align:center;padding:15px;background:rgba(0,0,0,0.2);border-radius:10px;">
            <div style="font-size:28px;font-weight:900;color:#00d4ff;" id="interventions">--</div>
            <div style="font-size:12px;color:#ccecff;margin-top:5px;">Interventions Applied</div>
          </div>
        </div>
      </div>

      <!-- RRT Performance Metrics -->
      <div style="margin-bottom:25px;padding:20px;background:rgba(255,107,107,0.05);border:2px solid rgba(255,107,107,0.2);border-radius:15px;">
        <h3 style="color:#ff6b6b;font-size:18px;margin:0 0 15px 0;">‚ö° RRT Performance Metrics</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;">
          <div style="text-align:center;padding:15px;background:rgba(0,0,0,0.2);border-radius:10px;">
            <div style="font-size:28px;font-weight:900;color:#00d4ff;" id="avgResponseTime">--</div>
            <div style="font-size:11px;color:#ccecff;margin-top:5px;">Avg Response Time</div>
          </div>
          <div style="text-align:center;padding:15px;background:rgba(0,0,0,0.2);border-radius:10px;">
            <div style="font-size:28px;font-weight:900;color:#00ffb3;" id="avgStabilityGain">--</div>
            <div style="font-size:11px;color:#ccecff;margin-top:5px;">Avg Stability Gain</div>
          </div>
          <div style="text-align:center;padding:15px;background:rgba(0,0,0,0.2);border-radius:10px;">
            <div style="font-size:20px;font-weight:700;color:#ffb300;" id="mostUsedIntervention">--</div>
            <div style="font-size:11px;color:#ccecff;margin-top:5px;">Most Used</div>
          </div>
          <div style="text-align:center;padding:15px;background:rgba(0,0,0,0.2);border-radius:10px;">
            <div style="font-size:28px;font-weight:900;color:#8a2be2;" id="reflectionCount">0</div>
            <div style="font-size:11px;color:#ccecff;margin-top:5px;">Reflections Submitted</div>
          </div>
        </div>
      </div>

      <div style="margin-bottom:25px;">
        <h3 style="color:#00ffb3;font-size:18px;margin:0 0 12px 0;">Recent Alerts (Most Recent First)</h3>
        <div id="alertsPanel" style="background:rgba(0,0,0,0.3);border-radius:10px;padding:15px;max-height:300px;overflow-y:auto;"></div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(0,212,255,0.3);margin:25px 0;">

      <div>
        <h3 style="color:#00ffb3;font-size:18px;margin:0 0 12px 0;">Expert Huddle Submissions</h3>
        <div id="dashboard" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px;"></div>
      </div>
    </section>

  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <!-- INTERACTIVITY JS -->
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBfJ4KBqpbP4tbtikAgMEdbT5P1rb3yhHo",
      authDomain: "ati-pharm-blitz.firebaseapp.com",
      databaseURL: "https://ati-pharm-blitz-default-rtdb.firebaseio.com",
      projectId: "ati-pharm-blitz",
      storageBucket: "ati-pharm-blitz.firebasestorage.app",
      messagingSenderId: "236104923394",
      appId: "1:236104923394:web:201f51f9ba162438b2aa1b"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Flashcards - Firebase-driven flip (students unlock via correct guesses)
    function setupFlashcardSync() {
      const flashcards = document.querySelectorAll('.flashcard[data-card-id]');
      
      flashcards.forEach(card => {
        const cardId = card.dataset.cardId;
        if (!cardId) return;
        
        // Initially lock all cards
        card.classList.add('locked');
        
        // Listen to Firebase for flip state
        database.ref('flashcards/' + cardId).on('value', (snapshot) => {
          const data = snapshot.val();
          if (data && data.flipped) {
            // Unlock and flip the card
            card.classList.remove('locked');
            card.classList.add('flipped');
            
            // Add visual feedback
            card.style.animation = 'pulse 0.5s ease';
            setTimeout(() => {
              card.style.animation = '';
            }, 500);
          }
        });
        
        // Allow manual toggle only if unlocked
        card.addEventListener('click', () => {
          if (!card.classList.contains('locked')) {
            card.classList.toggle('flipped');
          }
        });
      });
    }
    
    // Initialize flashcard sync
    setupFlashcardSync();

    // Lightning reveal
    document.querySelectorAll('.question-tile').forEach(tile => {
      tile.addEventListener('click', () => tile.classList.toggle('revealed'));
    });

    // Red flag reveal
    document.querySelectorAll('.red-flag-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const content = btn.nextElementSibling;
        content.classList.toggle('show');
      });
    });

    // Timer functionality
    let totalSeconds = 60 * 60; // 60 minutes
    let timerInterval = null;
    let isRunning = false;

    const timerDisplay = document.getElementById('timerDisplay');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');

    function updateDisplay() {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      timerDisplay.textContent = 
        String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
      
      // Color coding based on time remaining
      if (totalSeconds <= 300) { // 5 minutes or less
        timerDisplay.style.color = '#ff006e';
      } else if (totalSeconds <= 600) { // 10 minutes or less
        timerDisplay.style.color = '#ffb300';
      } else {
        timerDisplay.style.color = '#00ffb3';
      }
    }

    function startTimer() {
      if (!isRunning) {
        isRunning = true;
        timerInterval = setInterval(() => {
          if (totalSeconds > 0) {
            totalSeconds--;
            updateDisplay();
          } else {
            pauseTimer();
            alert('‚è∞ Time\'s up! Session complete.');
          }
        }, 1000);
        startBtn.textContent = 'Running...';
        startBtn.disabled = true;
      }
    }

    function pauseTimer() {
      isRunning = false;
      clearInterval(timerInterval);
      startBtn.textContent = 'Resume';
      startBtn.disabled = false;
    }

    function resetTimer() {
      pauseTimer();
      totalSeconds = 60 * 60;
      updateDisplay();
      startBtn.textContent = 'Start';
    }

    startBtn.addEventListener('click', startTimer);
    pauseBtn.addEventListener('click', pauseTimer);
    resetBtn.addEventListener('click', resetTimer);

    // Phase indicators
    document.querySelectorAll('.phase').forEach(phase => {
      phase.addEventListener('click', () => {
        document.querySelectorAll('.phase').forEach(p => p.classList.remove('active'));
        phase.classList.add('active');
      });
    });

    // Initialize display
    updateDisplay();

    // Random Group Assignment
    const systemNames = [
      'Neurological üß†',
      'Psychopharmacology üíä',
      'Pain Management üò£',
      'Inflammation üî•',
      'Endocrine ü©∫',
      'Infection ü¶†'
    ];

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // Auto-save student names
    const studentNamesTextarea = document.getElementById('studentNames');
    const groupCountInput = document.getElementById('groupCount');
    const specialCountInput = document.getElementById('specialCount');
    const resultsEl = document.getElementById('groupResults');

    // Load saved data on page load
    function loadSavedData() {
      const savedNames = localStorage.getItem('studentNames');
      const savedGroupCount = localStorage.getItem('groupCount');
      const savedSpecialCount = localStorage.getItem('specialCount');
      const savedResults = localStorage.getItem('groupResults');

      if (savedNames) studentNamesTextarea.value = savedNames;
      if (savedGroupCount) groupCountInput.value = savedGroupCount;
      if (savedSpecialCount) specialCountInput.value = savedSpecialCount;
      if (savedResults) resultsEl.innerHTML = savedResults;
    }

    // Auto-save as user types
    studentNamesTextarea.addEventListener('input', () => {
      localStorage.setItem('studentNames', studentNamesTextarea.value);
    });

    groupCountInput.addEventListener('change', () => {
      localStorage.setItem('groupCount', groupCountInput.value);
    });

    specialCountInput.addEventListener('change', () => {
      localStorage.setItem('specialCount', specialCountInput.value);
    });

    // Load saved data
    loadSavedData();

    document.getElementById('assignButton').addEventListener('click', () => {
      const textarea = document.getElementById('studentNames');
      const errorEl = document.getElementById('assignError');
      const resultsEl = document.getElementById('groupResults');
      const groupCount = parseInt(document.getElementById('groupCount').value, 10);
      const specialCount = parseInt(document.getElementById('specialCount').value, 10);

      errorEl.textContent = '';
      
      // Parse student names
      const names = textarea.value
        .split('\n')
        .map(n => n.trim())
        .filter(n => n.length > 0);

      if (names.length === 0) {
        errorEl.textContent = '‚ö†Ô∏è Please enter at least one student name.';
        return;
      }

      if (names.length < groupCount) {
        errorEl.textContent = `‚ö†Ô∏è You need at least ${groupCount} students for ${groupCount} groups.`;
        return;
      }

      if (specialCount > names.length) {
        errorEl.textContent = `‚ö†Ô∏è Cannot assign ${specialCount} special roles from ${names.length} students.`;
        return;
      }

      // Shuffle and assign
      const shuffled = shuffleArray(names);
      
      // Pick special roles
      const specialRoles = shuffled.slice(0, specialCount);
      const remaining = shuffled.slice(specialCount);

      // Distribute into groups
      const groups = Array.from({ length: groupCount }, () => []);
      remaining.forEach((name, idx) => {
        groups[idx % groupCount].push(name);
      });

      // Build output HTML
      let html = '';
      
      // Special Roles
      html += '<div class="group-block">';
      html += '<h4>‚≠ê Special Roles (Charge Nurse / RRT)</h4>';
      html += '<ul>';
      specialRoles.forEach(name => {
        html += `<li><span class="special-role">${name}</span></li>`;
      });
      html += '</ul>';
      html += '</div>';

      // Groups
      groups.forEach((group, idx) => {
        const systemName = systemNames[idx] || `Group ${idx + 1}`;
        html += '<div class="group-block">';
        html += `<h4>Group ${idx + 1}: ${systemName}</h4>`;
        if (group.length === 0) {
          html += '<p style="color:#ff8c00;font-size:13px;">No students assigned</p>';
        } else {
          html += '<ul>';
          group.forEach(name => {
            html += `<li>${name}</li>`;
          });
          html += '</ul>';
        }
        html += '</div>';
      });

      resultsEl.innerHTML = html;
      
      // Save results to localStorage
      localStorage.setItem('groupResults', html);
    });

    // Lab Flow Phase Timer
    const phases = [
      {
        name: 'Phase 1: Warm-Up (5 min)',
        duration: 5 * 60,
        instructions: [
          'Activate prior knowledge with flashcards',
          'Students identify systems quickly',
          'Build energy and engagement'
        ]
      },
      {
        name: 'Phase 2: Expert Huddle (30 min)',
        duration: 30 * 60,
        instructions: [
          'Groups fill out their system priorities',
          'Identify #1 safety risk, lab, do-not-mix rule',
          'Create 2+ scenarios for teaching'
        ]
      },
      {
        name: 'Phase 3: Lightning Round (25 min)',
        duration: 25 * 60,
        instructions: [
          'Groups present their Top 3 priorities',
          'Rapid-fire Q&A across all systems',
          'Reinforce safety-first thinking'
        ]
      }
    ];

    let currentPhase = 0;
    let phaseSeconds = phases[0].duration;
    let phaseInterval = null;
    let phaseRunning = false;

    const phaseLabel = document.getElementById('phaseLabel');
    const phaseInstructions = document.getElementById('phaseInstructions');
    const phaseTimer = document.getElementById('phaseTimer');
    const phaseCount = document.getElementById('phaseCount');
    const startPhaseBtn = document.getElementById('startPhaseBtn');
    const pausePhaseBtn = document.getElementById('pausePhaseBtn');
    const resetPhaseBtn = document.getElementById('resetPhaseBtn');
    const nextPhaseBtn = document.getElementById('nextPhaseBtn');

    function updatePhaseDisplay() {
      const minutes = Math.floor(phaseSeconds / 60);
      const seconds = phaseSeconds % 60;
      phaseTimer.textContent = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
      
      // Color coding
      if (phaseSeconds <= 60) {
        phaseTimer.style.color = '#ff006e';
      } else if (phaseSeconds <= 300) {
        phaseTimer.style.color = '#ffb300';
      } else {
        phaseTimer.style.color = '#00ffb3';
      }
    }

    function loadPhase(index) {
      currentPhase = index;
      const phase = phases[currentPhase];
      phaseSeconds = phase.duration;
      
      phaseLabel.textContent = phase.name;
      phaseInstructions.innerHTML = '';
      phase.instructions.forEach(text => {
        const li = document.createElement('li');
        li.textContent = text;
        phaseInstructions.appendChild(li);
      });
      
      phaseCount.textContent = `Phase ${currentPhase + 1} of ${phases.length}`;
      updatePhaseDisplay();
      
      if (phaseRunning) {
        pausePhaseTimer();
      }
    }

    function startPhaseTimer() {
      if (!phaseRunning) {
        phaseRunning = true;
        phaseInterval = setInterval(() => {
          if (phaseSeconds > 0) {
            phaseSeconds--;
            updatePhaseDisplay();
          } else {
            pausePhaseTimer();
            alert(`‚è∞ ${phases[currentPhase].name} complete!`);
          }
        }, 1000);
        startPhaseBtn.textContent = 'Running...';
        startPhaseBtn.disabled = true;
      }
    }

    function pausePhaseTimer() {
      phaseRunning = false;
      clearInterval(phaseInterval);
      startPhaseBtn.textContent = 'Resume';
      startPhaseBtn.disabled = false;
    }

    function resetPhaseTimer() {
      pausePhaseTimer();
      phaseSeconds = phases[currentPhase].duration;
      updatePhaseDisplay();
      startPhaseBtn.textContent = 'Start';
    }

    function nextPhase() {
      if (currentPhase < phases.length - 1) {
        loadPhase(currentPhase + 1);
      } else {
        alert('‚úÖ All phases complete! Great job.');
      }
    }

    startPhaseBtn.addEventListener('click', startPhaseTimer);
    pausePhaseBtn.addEventListener('click', pausePhaseTimer);
    resetPhaseBtn.addEventListener('click', resetPhaseTimer);
    nextPhaseBtn.addEventListener('click', nextPhase);

    // Initialize
    loadPhase(0);

    // -----------------------------
    // DEBRIEF BOARD SAVE / LOAD
    // -----------------------------

    function saveDebrief() {
      const ids = ['debrief1','debrief2','debrief3','debrief4','debrief5','debrief6'];
      const data = {};
      ids.forEach(id => {
        const el = document.getElementById(id);
        data[id] = el ? el.value : '';
      });

      try {
        localStorage.setItem('pharmBlitzDebrief', JSON.stringify(data));
        const status = document.getElementById('debriefStatus');
        if (status) {
          status.style.color = '#00ffb3';
          status.textContent = 'Debrief saved on this device.';
          setTimeout(() => {
            status.textContent = '';
          }, 3000);
        }
      } catch (e) {
        const status = document.getElementById('debriefStatus');
        if (status) {
          status.style.color = '#ff99c2';
          status.textContent = 'Unable to save debrief (local storage unavailable).';
        }
      }
    }

    function loadDebrief() {
      try {
        const saved = localStorage.getItem('pharmBlitzDebrief');
        if (!saved) return;
        const data = JSON.parse(saved);
        Object.entries(data).forEach(([id, value]) => {
          const el = document.getElementById(id);
          if (el) el.value = value;
        });
      } catch (e) {
        // ignore
      }
    }

    // Load debrief on page load
    loadDebrief();

    const saveBtn = document.getElementById('saveDebriefBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', saveDebrief);
    }

    // Auto-save on input
    ['debrief1','debrief2','debrief3','debrief4','debrief5','debrief6'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', saveDebrief);
      }
    });

    // Real-time Firebase Sync for Huddle Section
    function setupHuddleSync() {
      for (let groupNum = 1; groupNum <= 6; groupNum++) {
        const groupRef = database.ref('groups/' + groupNum);
        const huddleBox = document.querySelector(`.huddle-box[data-group="${groupNum}"]`);
        
        if (huddleBox) {
          groupRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
              const fields = ['safetyRisk', 'priorityLab', 'doNotMix', 'highYieldMed', 'scenarioPrompts'];
              fields.forEach(field => {
                const input = huddleBox.querySelector(`[data-field="${field}"]`);
                if (input && data[field]) {
                  input.value = data[field];
                  // Add visual feedback when updated
                  input.style.background = 'rgba(0, 255, 179, 0.2)';
                  setTimeout(() => {
                    input.style.background = '';
                  }, 1000);
                }
              });
            }
          });
        }
      }
    }

    // Initialize huddle sync
    setupHuddleSync();

    // -----------------------------
    // INSTRUCTOR DASHBOARD - LIVE VIEW
    // -----------------------------

    const stabilityPanel = document.getElementById('stabilityPanel');
    const alertsPanel = document.getElementById('alertsPanel');

    // Listen to stability changes
    if (stabilityPanel) {
      database.ref('groups').on('value', snapshot => {
        const data = snapshot.val() || {};
        stabilityPanel.innerHTML = '';
        
        let totalStability = 0;
        let groupCount = 0;

        // Ensure all 6 groups are shown
        for (let groupId = 1; groupId <= 6; groupId++) {
          const g = data[groupId] || {};
          const stability = typeof g.stability === 'number' ? g.stability : 100;
          
          totalStability += stability;
          groupCount++;

          const box = document.createElement('div');
          box.className = 'groupBox';
          box.style.cssText = 'background:rgba(255,255,255,0.05);border-radius:10px;padding:12px;border:2px solid rgba(0,212,255,0.4);';

          // Add pulsing animation for critical levels
          if (stability < 25) {
            box.classList.add('stability-critical');
          } else if (stability < 50) {
            box.classList.add('stability-warning');
          }

          const title = document.createElement('div');
          title.style.cssText = 'font-size:14px;font-weight:600;color:#00d4ff;margin-bottom:8px;text-align:center;';
          title.textContent = `Group ${groupId} ‚Äì Stability: ${Math.round(stability)}`;
          box.appendChild(title);

          const bar = document.createElement('div');
          bar.className = 'stability-bar';
          bar.style.cssText = 'width:100%;height:20px;background:rgba(0,0,0,0.3);border-radius:10px;overflow:hidden;';

          const fill = document.createElement('div');
          fill.className = 'stability-fill';
          fill.style.width = stability + '%';
          fill.style.height = '100%';
          fill.style.borderRadius = '10px';
          fill.style.transition = 'all 0.5s ease';
          
          // Color coding
          if (stability >= 80) {
            fill.style.background = 'linear-gradient(90deg, #00ffb3, #00d4ff)';
            box.style.borderColor = 'rgba(0,255,179,0.6)';
          } else if (stability >= 50) {
            fill.style.background = 'linear-gradient(90deg, #ffb300, #ff8c00)';
            box.style.borderColor = 'rgba(255,179,0,0.6)';
          } else {
            fill.style.background = 'linear-gradient(90deg, #ff006e, #cc0058)';
            box.style.borderColor = 'rgba(255,0,110,0.6)';
          }

          bar.appendChild(fill);
          box.appendChild(bar);

          stabilityPanel.appendChild(box);
        }
        
        // Update average stability metric
        const avgStabilityEl = document.getElementById('avgStability');
        if (avgStabilityEl && groupCount > 0) {
          const avg = Math.round(totalStability / groupCount);
          avgStabilityEl.textContent = avg;
          avgStabilityEl.style.color = avg >= 75 ? '#00ffb3' : avg >= 50 ? '#ffb300' : '#ff006e';
        }
      });
    }

    // Listen to recent events (alerts)
    if (alertsPanel) {
      database.ref('events').limitToLast(25).on('value', snapshot => {
        const data = snapshot.val() || {};
        const entries = Object.values(data).sort((a,b) => b.timestamp - a.timestamp);

        if (entries.length === 0) {
          alertsPanel.innerHTML = '<p style="color:#ccecff;font-size:13px;margin:0;">No alerts yet</p>';
        } else {
          alertsPanel.innerHTML = '';

          entries.forEach(ev => {
            const div = document.createElement('div');
            div.className = 'alert-item ' + (ev.severity || 'minor');
            div.style.cssText = 'background:rgba(255,255,255,0.05);border-radius:8px;padding:10px;margin-bottom:8px;';
            
            // Border color based on severity
            if (ev.severity === 'critical') {
              div.style.borderLeft = '4px solid #ff006e';
            } else if (ev.severity === 'moderate') {
              div.style.borderLeft = '4px solid #ffb300';
            } else {
              div.style.borderLeft = '4px solid #00d4ff';
            }

            const time = new Date(ev.timestamp).toLocaleTimeString();
            const correctness = ev.isCorrect ? '‚úÖ' : '‚ö†Ô∏è';

            div.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:4px;">
                <span style="font-size:13px;font-weight:600;color:${ev.isCorrect ? '#00ffb3' : '#ff99c2'};">${correctness} Group ${ev.groupId} ‚Äì ${ev.phase}</span>
                <span style="font-size:11px;color:#ccecff;">${time}</span>
              </div>
              <div style="font-size:12px;color:#ccecff;">${ev.explanation || 'No details'}</div>
              <div style="font-size:11px;color:#00d4ff;margin-top:4px;">Severity: ${ev.severity} | Delta: ${ev.delta > 0 ? '+' : ''}${ev.delta || 0}</div>
            `;

            alertsPanel.appendChild(div);
          });
        }
        
        // Update total errors metric
        const totalErrorsEl = document.getElementById('totalErrors');
        if (totalErrorsEl) {
          const errorCount = entries.filter(ev => !ev.isCorrect).length;
          totalErrorsEl.textContent = errorCount;
        }
      });
    }
      });
    }

    // Expert Huddle Dashboard
    function setupHuddleDashboard() {
      const dashboard = document.getElementById('dashboard');
      if (!dashboard) return;

      for (let groupNum = 1; groupNum <= 6; groupNum++) {
        const groupRef = database.ref('groups/' + groupNum);
        
        const card = document.createElement('div');
        card.id = `huddle-dash-${groupNum}`;
        card.style.cssText = 'background:rgba(0,212,255,0.08);border-radius:12px;padding:15px;border:1px solid rgba(0,212,255,0.3);';
        card.innerHTML = `
          <h4 style="color:#00ffb3;margin:0 0 10px;font-size:16px;">Group ${groupNum}</h4>
          <div class="huddle-data" style="font-size:12px;color:#ccecff;line-height:1.6;"></div>
        `;
        dashboard.appendChild(card);

        groupRef.on('value', (snapshot) => {
          const data = snapshot.val();
          const dataEl = card.querySelector('.huddle-data');
          
          if (data) {
            let html = '';
            if (data.systemName) html += `<div><strong>System:</strong> ${data.systemName}</div>`;
            if (data.safetyRisk) html += `<div><strong>#1 Risk:</strong> ${data.safetyRisk}</div>`;
            if (data.priorityLab) html += `<div><strong>Lab:</strong> ${data.priorityLab}</div>`;
            if (data.doNotMix) html += `<div><strong>Do Not Mix:</strong> ${data.doNotMix}</div>`;
            if (data.highYieldMed) html += `<div><strong>Med:</strong> ${data.highYieldMed}</div>`;
            
            dataEl.innerHTML = html || '<em style="color:#888;">No data yet</em>';
          } else {
            dataEl.innerHTML = '<em style="color:#888;">No data yet</em>';
          }
        });
      }
    }

    // Initialize dashboard
    setupHuddleDashboard();

    // -----------------------------
    // DEBRIEF DASHBOARD
    // -----------------------------
    function setupDebriefDashboard() {
      const groupNames = {1: 'Neurological', 2: 'Psychopharmacology', 3: 'Pain', 4: 'Inflammation', 5: 'Endocrine', 6: 'Infection'};
      
      // Charge 1 groups (1-3)
      const charge1Container = document.getElementById('charge1Debriefs');
      [1, 2, 3].forEach(groupId => {
        createDebriefDisplay(charge1Container, groupId, groupNames[groupId]);
      });
      
      // Charge 2 groups (4-6)
      const charge2Container = document.getElementById('charge2Debriefs');
      [4, 5, 6].forEach(groupId => {
        createDebriefDisplay(charge2Container, groupId, groupNames[groupId]);
      });
    }

    function createDebriefDisplay(container, groupId, groupName) {
      const debriefDiv = document.createElement('div');
      debriefDiv.style.cssText = 'padding:12px;margin-bottom:12px;background:rgba(0,0,0,0.2);border-radius:8px;border-left:4px solid #00d4ff;';
      debriefDiv.innerHTML = `
        <h4 style="color:#00d4ff;margin:0 0 8px 0;font-size:15px;">Group ${groupId}: ${groupName}</h4>
        <div id="debriefContent${groupId}" style="color:#ccecff;font-size:13px;line-height:1.6;white-space:pre-wrap;">
          <em style="color:#888;">No notes yet from Charge Nurse...</em>
        </div>
        <div style="margin-top:8px;font-size:11px;color:#888;" id="debriefMeta${groupId}"></div>
      `;
      container.appendChild(debriefDiv);
      
      // Listen for updates
      const debriefRef = database.ref('debrief/group' + groupId);
      debriefRef.on('value', snap => {
        const data = snap.val();
        const contentEl = document.getElementById('debriefContent' + groupId);
        const metaEl = document.getElementById('debriefMeta' + groupId);
        
        if (data && data.content) {
          contentEl.textContent = data.content;
          const time = new Date(data.timestamp).toLocaleTimeString();
          const nurse = data.chargeNurse === 'charge1' ? 'Charge Nurse 1' : 'Charge Nurse 2';
          metaEl.textContent = `Updated by ${nurse} at ${time}`;
        } else {
          contentEl.innerHTML = '<em style="color:#888;">No notes yet from Charge Nurse...</em>';
          metaEl.textContent = '';
        }
      });
    }

    // Initialize debrief dashboard
    setupDebriefDashboard();

    // -----------------------------
    // JIGSAW TRACKER
    // -----------------------------

    function setupJigsawTracker() {
      const tracker = document.getElementById('jigsawTracker');
      if (!tracker) return;

      const systemNames = [
        'Neurological üß†',
        'Psychopharmacology üíä',
        'Pain Management üò£',
        'Inflammation üî•',
        'Endocrine ü©∫',
        'Infection ü¶†'
      ];

      for (let groupNum = 1; groupNum <= 6; groupNum++) {
        const card = document.createElement('div');
        card.style.cssText = 'background:rgba(255,255,255,0.04);border-radius:12px;padding:15px;border:1px solid rgba(0,212,255,0.3);';
        
        card.innerHTML = `
          <h4 style="color:#00ffb3;margin:0 0 10px;font-size:15px;">Group ${groupNum}</h4>
          <div id="jigsaw-checklist-${groupNum}" style="font-size:13px;"></div>
        `;
        tracker.appendChild(card);

        // Listen to jigsaw progress
        database.ref('jigsaw/group' + groupNum).on('value', (snapshot) => {
          const data = snapshot.val() || {};
          const checklist = document.getElementById(`jigsaw-checklist-${groupNum}`);
          
          let html = '';
          for (let sysNum = 1; sysNum <= 6; sysNum++) {
            const completed = data['system' + sysNum] === true;
            const icon = completed ? '‚úÖ' : '‚¨ú';
            const style = completed ? 'color:#00ffb3;' : 'color:#888;opacity:0.6;';
            html += `<div style="${style}margin-bottom:4px;">${icon} ${systemNames[sysNum - 1]}</div>`;
          }
          
          checklist.innerHTML = html;
        });
      }
    }

    // Initialize jigsaw tracker
    setupJigsawTracker();

    // -----------------------------
    // PERFORMANCE METRICS TRACKING
    // -----------------------------
    // Track RRT calls
    database.ref('rrt/calls').on('value', snapshot => {
      const rrtCallsEl = document.getElementById('rrtCalls');
      if (rrtCallsEl) {
        const calls = snapshot.val() || {};
        rrtCallsEl.textContent = Object.keys(calls).length;
      }
    });

    // Track interventions (count events with type 'intervention')
    database.ref('events').on('value', snapshot => {
      const interventionsEl = document.getElementById('interventions');
      if (interventionsEl) {
        const events = snapshot.val() || {};
        const interventionCount = Object.values(events).filter(ev => ev.phase === 'rrt-intervention').length;
        interventionsEl.textContent = interventionCount;
      }
    });

    // Track RRT performance metrics
    database.ref('rrt/metrics').on('value', snapshot => {
      const metrics = snapshot.val();
      if (metrics) {
        const metricArray = Object.values(metrics);
        
        // Average response time
        const avgTime = metricArray.reduce((sum, m) => sum + m.responseTimeMs, 0) / metricArray.length;
        const avgTimeSeconds = (avgTime / 1000).toFixed(1);
        document.getElementById('avgResponseTime').textContent = avgTimeSeconds + 's';
        
        // Average stability gain
        const avgGain = metricArray.reduce((sum, m) => sum + m.stabilityGain, 0) / metricArray.length;
        document.getElementById('avgStabilityGain').textContent = '+' + avgGain.toFixed(1);
        
        // Most used intervention
        const interventionCounts = {};
        metricArray.forEach(m => {
          interventionCounts[m.interventionType] = (interventionCounts[m.interventionType] || 0) + 1;
        });
        const mostUsed = Object.entries(interventionCounts).sort((a, b) => b[1] - a[1])[0];
        if (mostUsed) {
          document.getElementById('mostUsedIntervention').textContent = mostUsed[0].toUpperCase() + ' (' + mostUsed[1] + ')';
        }
      }
    });

    // Track reflections
    database.ref('reflections').on('value', snapshot => {
      const reflections = snapshot.val();
      if (reflections) {
        document.getElementById('reflectionCount').textContent = Object.keys(reflections).length;
      }
    });

    // -----------------------------
    // ADAPTIVE DIFFICULTY
    // -----------------------------
    function updateDifficulty(value) {
      const multiplier = parseFloat(value);
      
      // Update display
      document.getElementById('difficultyValue').textContent = multiplier.toFixed(1) + 'x';
      
      // Calculate penalties
      const minorBase = 5;
      const moderateBase = 15;
      const criticalBase = 25;
      
      const minorPenalty = Math.round(minorBase * multiplier);
      const moderatePenalty = Math.round(moderateBase * multiplier);
      const criticalPenalty = Math.round(criticalBase * multiplier);
      
      // Update display
      document.getElementById('minorPenalty').textContent = '-' + minorPenalty;
      document.getElementById('moderatePenalty').textContent = '-' + moderatePenalty;
      document.getElementById('criticalPenalty').textContent = '-' + criticalPenalty;
      
      // Save to Firebase so student views can read it
      database.ref('settings/difficulty').set({
        multiplier: multiplier,
        minorPenalty: minorPenalty,
        moderatePenalty: moderatePenalty,
        criticalPenalty: criticalPenalty,
        timestamp: Date.now()
      });
    }

    // -----------------------------
    // TIMER CONTROLS
    // -----------------------------
    function startTimer(phaseName, durationMinutes) {
      const endTime = Date.now() + (durationMinutes * 60 * 1000);
      
      database.ref('timer').set({
        phase: phaseName,
        endTime: endTime,
        duration: durationMinutes
      });
      
      const status = document.getElementById('timerStatus');
      if (status) {
        status.style.color = '#00ffb3';
        status.textContent = `‚úì Timer started: ${phaseName} - ${durationMinutes} minutes`;
      }
    }

    function stopTimer() {
      database.ref('timer').remove();
      
      const status = document.getElementById('timerStatus');
      if (status) {
        status.style.color = '#ff99c2';
        status.textContent = '‚èπ Timer stopped';
      }
    }

    // -----------------------------
    // EXPORT SESSION REPORT
    // -----------------------------
    async function exportSessionReport() {
      try {
        // Fetch all data
        const groupsSnapshot = await database.ref('groups').once('value');
        const eventsSnapshot = await database.ref('events').once('value');
        const rrtSnapshot = await database.ref('rrt/calls').once('value');
        const debriefSnapshot = await database.ref('debrief').once('value');
        
        const groups = groupsSnapshot.val() || {};
        const events = eventsSnapshot.val() || {};
        const rrtCalls = rrtSnapshot.val() || {};
        const debriefNotes = debriefSnapshot.val() || {};
        
        // Build report
        let report = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
        report += '       ATI PHARM BLITZ - SESSION REPORT\n';
        report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
        report += `Generated: ${new Date().toLocaleString()}\n\n`;
        
        // Performance Summary
        report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
        report += 'PERFORMANCE SUMMARY\n';
        report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
        
        const groupStabilities = Object.keys(groups).map(gId => groups[gId].stability || 100);
        const avgStability = groupStabilities.length > 0 
          ? Math.round(groupStabilities.reduce((a,b) => a+b, 0) / groupStabilities.length)
          : 100;
        const totalErrors = Object.values(events).filter(ev => !ev.isCorrect).length;
        const totalRRTCalls = Object.keys(rrtCalls).length;
        const interventions = Object.values(events).filter(ev => ev.phase === 'rrt-intervention').length;
        
        report += `Average Patient Stability: ${avgStability}%\n`;
        report += `Total Errors Made: ${totalErrors}\n`;
        report += `RRT Calls: ${totalRRTCalls}\n`;
        report += `Interventions Applied: ${interventions}\n\n`;
        
        // Group Stability Details
        report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
        report += 'GROUP STABILITY SCORES\n';
        report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
        const groupNames = ['Neurological', 'Psychopharmacology', 'Pain Management', 
                           'Inflammation', 'Endocrine', 'Infection'];
        for (let i = 1; i <= 6; i++) {
          const stability = groups[i]?.stability || 100;
          report += `Group ${i} (${groupNames[i-1]}): ${stability}%\n`;
        }
        report += '\n';
        
        // Debrief Notes
        report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
        report += 'DEBRIEF NOTES (From Charge Nurses)\n';
        report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
        for (let i = 1; i <= 6; i++) {
          const debrief = debriefNotes[`group${i}`];
          if (debrief && debrief.content) {
            report += `\nGroup ${i} (by ${debrief.chargeNurse}):\n`;
            report += debrief.content.trim() + '\n';
          }
        }
        report += '\n';
        
        // Error Log
        report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
        report += 'ERROR LOG (Most Recent 50)\n';
        report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
        const errorEvents = Object.values(events)
          .filter(ev => !ev.isCorrect)
          .sort((a,b) => b.timestamp - a.timestamp)
          .slice(0, 50);
        
        errorEvents.forEach(ev => {
          const time = new Date(ev.timestamp).toLocaleTimeString();
          report += `[${time}] Group ${ev.groupId} - ${ev.phase}\n`;
          report += `  ${ev.explanation || 'Error occurred'}\n`;
          report += `  Severity: ${ev.severity} | Stability Impact: ${ev.delta}\n\n`;
        });
        
        // RRT Calls
        if (totalRRTCalls > 0) {
          report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
          report += 'RRT CALLS SUMMARY\n';
          report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
          Object.values(rrtCalls).forEach(call => {
            const time = new Date(call.timestamp).toLocaleTimeString();
            report += `[${time}] Group ${call.groupId} - Stability: ${call.stability}\n`;
            if (call.sbar) {
              report += `  Situation: ${call.sbar.situation}\n`;
              report += `  Background: ${call.sbar.background}\n`;
              report += `  Assessment: ${call.sbar.assessment}\n`;
              report += `  Recommendation: ${call.sbar.recommendation}\n`;
            }
            report += '\n';
          });
        }
        
        report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
        report += '             END OF REPORT\n';
        report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
        
        // Download as text file
        const blob = new Blob([report], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `PharmBlitz_Session_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Show success message
        const status = document.getElementById('debriefStatus');
        if (status) {
          status.style.color = '#00ffb3';
          status.textContent = '‚úì Session report downloaded successfully!';
          setTimeout(() => { status.textContent = ''; }, 3000);
        }
      } catch (error) {
        console.error('Export error:', error);
        const status = document.getElementById('debriefStatus');
        if (status) {
          status.style.color = '#ff006e';
          status.textContent = '‚úó Export failed. Check console for details.';
        }
      }
    }
  </script>

  </div>
  <!-- END INSTRUCTOR CONTENT -->

  <script>
    function selectRole(role) {
      if (role === 'instructor') {
        // Show instructor content
        document.getElementById('landingScreen').classList.add('hidden');
        document.getElementById('instructorContent').classList.add('active');
      } else if (role === 'student') {
        // Redirect to group selection with parameter to force selection screen
        window.location.href = 'group.html?select=1';
      }
    }
    
    function resetGame() {
      if (!confirm('‚ö†Ô∏è Reset all game data? This will clear all groups, events, flashcards, and progress. This action cannot be undone!')) {
        return;
      }
      
      console.log('resetGame called from instructor dashboard');
      
      // Initialize Firebase if not already done
      if (typeof firebase === 'undefined') {
        alert('‚ùå Firebase not loaded. Please refresh the page.');
        return;
      }
      
      if (!firebase.apps.length) {
        const firebaseConfig = {
          apiKey: "AIzaSyBfJ4KBqpbP4tbtikAgMEdbT5P1rb3yhHo",
          authDomain: "ati-pharm-blitz.firebaseapp.com",
          databaseURL: "https://ati-pharm-blitz-default-rtdb.firebaseio.com",
          projectId: "ati-pharm-blitz",
          storageBucket: "ati-pharm-blitz.firebasestorage.app",
          messagingSenderId: "236104923394",
          appId: "1:236104923394:web:201f51f9ba162438b2aa1b"
        };
        firebase.initializeApp(firebaseConfig);
      }
      
      const database = firebase.database();
      
      // Clear all Firebase data
      const resetPromises = [
        database.ref('groups').remove(),
        database.ref('events').remove(),
        database.ref('flashcards').remove(),
        database.ref('jigsaw').remove(),
        database.ref('debrief').remove(),
        database.ref('leadership').remove(),
        database.ref('rrt/calls').remove(),
        database.ref('timer').remove(),
        database.ref('chat').remove(),
        database.ref('messages').remove(),
        database.ref('reflections').remove(),
        database.ref('rrt/metrics').remove()
      ];
      
      Promise.all(resetPromises).then(() => {
        console.log('All Firebase data cleared from instructor dashboard');
        alert('‚úÖ Game reset complete!');
        // Reload the page
        window.location.reload();
      }).catch(err => {
        console.error('Error resetting game:', err);
        alert('‚ùå Error resetting game. Please try again.');
      });
    }
  </script>
</body>
</html>